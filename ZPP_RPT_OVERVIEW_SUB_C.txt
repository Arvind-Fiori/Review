*&---------------------------------------------------------------------*
*&  Include           ZPP_RPT_OVERVIEW_SUB
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  GET_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
*||---Technical Name---|| Functional Name||---Dev-Id---|| Change Date ||TR  Number ||Reason for Change ||
*||Soc by Trilok Teli || Bhushan B. || Devid-4712 || 05-12-2023 || ATDK994741 || WPS Changes
*|| Trilok Teli     || Bhushan B.  || Devid-4619 || 15.12.2023 || ATDK995022 || WPS Changes
*|| Trilok Teli     || Kunal Badgujar  || Devid-4728 || 12.12.2023 || ATDK995082 || New field addition
*|| Trilok Teli     || Bhushan Borse  || Devid-4953 || 30.03.2024  ||  ATDK998997 || WPS Data Log
*|| Trilok Teli     || Kunal Badgujar  || Devid-5287 || 29.05.2024 || ATDK9A045Q || CHAR - New field addition
*|| Uday Sorathiya  || Bhushan Borse  || WPS Project || || ATDK9A06BO || WPS Proxy
*|| Jash Rajpara    || Harshal Borse  || WPS Project || || ATDK9A0A47 || Field Addition For WPS
*|| Jash Rajpara    || Harshal Borse  || WPS Project || || ATDK9A0A89 || Data Send Partition
*|| Jash Rajpara    || Harshal Borse  || WPS Project || || ATDK9A0AEY || Table Count Field Change
*|| Saxi Patel      || Girish Parate  || Devid-6216 || 28.01.2025  || ATDK9A0EO0 || ADD TWO FIELDS
*|| Saxi Patel      || Akshay Honkarpe|| Devid-6394 || 18.03.2025  ||  ATDK9A0GX3 || validation based on warehouse stock
*|| YASH JAIN       || Girish Parate  || Devid-6712 || 12.05.2025  ||  ATDK9A0JT8 || Add Column of finishing group number
*|| YASH JAIN       || ATDK9A0L2X     || 05.06.2025 ||  ATDK9A0JT8 || DUMP RESOLUTION
*||Soc by Trilok Teli  || Girish P.       || Devid-001  || 31.08.2025  || ATDK9A0Q7A || Batch Creation Againg
*|| Rahul Koshti    || Girish Parate  || Devid-0001 PRD Issued  || 08.09.2025  || ATDK9A0QQV   || Add Plant - 2426 in Field Catalog
*|| Sushen Gore    || Girish Parate  || Devid-8439 PRD Issued  || 29.10.2025  || ATDK9A0SVW   || OPtimization
*-----------------------------------------------------------------------------------------------------
*----------------------------------------------------------------------*
FORM get_data .
  DATA: lv_sales TYPE char16.

  DATA : lrt_werks   TYPE RANGE OF werks_d, "Added By Devid-001
         lrt_werks_t TYPE RANGE OF werks_d.

*------------------------------------------------------------------------------------------------------------*
*   Select all Warehouse stock Data from LQUA, as per condition on selection screen                          *
*------------------------------------------------------------------------------------------------------------*
  SELECT a~*,
         b~matkl
*         c~cuobj
*         c~maktx,
*         d~lgobe
*         e~wgbez
     FROM lqua AS a  INNER JOIN    mara  AS b ON a~matnr EQ b~matnr AND a~verme NE 0
*     FROM lqua AS a  INNER JOIN    ( mara  AS b INNER JOIN t023t AS e ON b~matkl EQ e~matkl AND spras EQ 'E') ON a~matnr EQ b~matnr
*                      LEFT OUTER JOIN vbap AS c ON a~vbeln EQ c~vbeln AND a~posnr EQ c~posnr AND a~matnr EQ c~matnr
*                     INNER JOIN makt  AS c ON a~matnr EQ c~matnr AND c~spras EQ 'E'
*                     LEFT OUTER JOIN makt  AS c ON a~matnr EQ c~matnr AND spras EQ 'E'
*                     INNER JOIN t001l AS d ON a~lgort EQ d~lgort
*                     LEFT OUTER JOIN t001l AS d ON a~lgort EQ d~lgort
                     INTO TABLE @DATA(lt_lqua)
                           WHERE a~werks IN @s_werks AND
                                 a~matnr IN @s_matnr AND
                                 b~matkl IN @s_matkl AND
                                 a~lgort IN @s_lgort AND
                                 a~lgnum IN @s_lgnum AND
*                                 a~lgtyp IN @s_lgtyp AND
*                                 a~lgpla IN @s_lgpla AND
                                 a~bestq IN @s_bestq AND
                                 a~sobkz IN @s_sobkz AND
*                                 a~vbeln IN @s_vbeln AND
*                                 a~posnr IN @s_posnr AND
                                 a~charg IN @s_charg .
*------------------------------------------------------------------------------------------------------------*
*   Select all Sales Order stock Data from MSKA, as per condition on selection screen                        *
*------------------------------------------------------------------------------------------------------------*

  SELECT a~*,
         b~matkl,
         c~cuobj
*         d~cuobj AS cuobj1
*    FROM mska AS a  INNER JOIN mara AS b ON a~matnr EQ b~matnr AND a~kalab GT 0
    FROM mska AS a  INNER JOIN mara AS b ON a~matnr EQ b~matnr
*    FROM mska AS a  INNER JOIN mara AS b ON a~matnr EQ b~matnr AND ( a~kalab GT 0 ) OR ( a~kaspe GT 0 ) OR ( a~kains GT 0 )
                    LEFT OUTER JOIN vbap AS c ON a~vbeln EQ c~vbeln AND a~posnr EQ c~posnr AND a~matnr EQ c~matnr
*                    LEFT OUTER JOIN afpo AS d ON a~vbeln EQ d~kdauf AND a~posnr EQ d~kdpos AND a~matnr EQ d~matnr
                    INTO TABLE @DATA(lt_mska)
                            WHERE a~werks IN @s_werks AND
                                  a~matnr IN @s_matnr AND
                                  b~matkl IN @s_matkl AND
                                  a~lgort IN @s_lgort AND
                                  a~sobkz IN @s_sobkz AND
                                  a~vbeln IN @s_vbeln AND
                                  a~posnr IN @s_posnr AND
                                  a~charg IN @s_charg AND
                                  ( a~kaspe NE '0.00' OR a~kains NE '0.00' OR a~kalab NE '0.00'  ).
  IF lt_mska IS NOT INITIAL.
    gt_mska1[] = lt_mska[].
    gt_mska2[] = lt_mska[].
    gt_mska3[] = lt_mska[].
    DELETE gt_mska1 WHERE werks NE '1021'.
    DELETE gt_mska2 WHERE werks NE '1021'.
    DELETE gt_mska3 WHERE werks NE '1021'.
    gv_mska = 'X'.
  ENDIF.


*  IF s_bestq-low IS NOT INITIAL.
*
*  ELSE.
*    delete lt_mska WHERE a-kalab
*  ENDIF.
*------------------------------------------------------------------------------------------------------------*
*   Select all Batch stock Data from MACH, as per condition on selection screen                              *
*------------------------------------------------------------------------------------------------------------*

  SELECT a~*,
         b~matkl
*         c~maktx
    FROM mchb AS a  INNER JOIN      mara AS b ON a~matnr EQ b~matnr ") or ( a~cinsm gt 0 ) or ( a~cspem gt 0 )
*    FROM mchb AS a  INNER JOIN      mara AS b ON a~matnr EQ b~matnr AND a~clabs GT 0 ") or ( a~cinsm gt 0 ) or ( a~cspem gt 0 )
*    FROM mchb AS a  INNER JOIN      mara AS b ON a~matnr EQ b~matnr ") or ( a~cinsm gt 0 ) or ( a~cspem gt 0 )
*                    LEFT OUTER JOIN makt AS c ON a~matnr EQ c~matnr AND spras EQ 'E'
                           INTO TABLE @DATA(lt_mchb)
                            WHERE a~werks IN @s_werks AND
                                  a~matnr IN @s_matnr AND
                                  b~matkl IN @s_matkl AND
                                  a~lgort IN @s_lgort AND
                                  a~charg IN @s_charg AND
                                  a~lvorm EQ ''       AND
                                  ( a~clabs NE '0.00' OR cinsm NE '0.00' OR cspem NE '0.00' ).
  IF lt_mchb IS NOT INITIAL.
    gt_mchb1[] = lt_mchb[].
    gt_mchb2[] = lt_mchb[].
    gt_mchb3[] = lt_mchb[].
    DELETE gt_mchb1 WHERE werks NE '1021'.
    DELETE gt_mchb2 WHERE werks NE '1021'.
    DELETE gt_mchb3 WHERE werks NE '1021'.
    gv_mchb = 'X'.
  ENDIF.
*------------------------------------------------------------------------------------------------------------*
*   Select all General stock Data from MARD except some condition on selection screen                        *
*------------------------------------------------------------------------------------------------------------*
  IF  s_lgnum[] IS INITIAL AND s_lgtyp[] IS INITIAL AND s_lgpla[] IS INITIAL AND s_bestq[] IS INITIAL AND
      s_sobkz[] IS INITIAL AND s_vbeln[] IS INITIAL AND s_posnr[] IS INITIAL AND s_charg[] IS INITIAL AND
      s_qlty[] IS INITIAL AND s_regio[] IS INITIAL AND s_vkbur[] IS INITIAL .

    SELECT a~*,
           b~matkl
*         c~maktx
     FROM mard AS a INNER JOIN      mara AS b ON a~matnr EQ b~matnr AND a~labst GT 0
*                    LEFT OUTER JOIN makt AS c ON a~matnr EQ c~matnr AND spras EQ 'E'
                           INTO TABLE @DATA(lt_mard)
                           WHERE a~werks IN @s_werks AND
                                 a~matnr IN @s_matnr AND
                                 b~matkl IN @s_matkl AND
                                 a~lgort IN @s_lgort AND
                                 a~lvorm EQ ''.

  ENDIF.
*------------------------------------------------------------------------------------------------------------*
*  Set A Flag Char to Identify which Table data is this
*  W = WareHouse  level Stock Table :- LQUA
*  S = Sales Order Level Stock :- MSKA
*  B = Batch level Stock ;- MCHB
*  N = Normal stock :- MARD ( Plant + Sloc ) level
*------------------------------------------------------------------------------------------------------------*
*   Insert All WareHouse Data                                                                                *
*------------------------------------------------------------------------------------------------------------*
  IF lt_lqua IS NOT INITIAL .
    "~~~~~~~~ Get All CUobj from VBAP ~~~~~~~~~~~~"
    SELECT vbeln, posnr,cuobj
                  FROM vbap INTO TABLE @DATA(lt_cuobj)
                  FOR ALL ENTRIES IN @lt_lqua
                  WHERE vbeln EQ @lt_lqua-a-sonum+0(10)
*                  AND   posnr EQ lt_lqua-a-sonum+10(6)
                  AND   cuobj NE ''.
    SORT lt_cuobj BY vbeln posnr cuobj.

    "~~~~~~~~ For MTS/MTO Case get sales order from Delivery ~~~~~~~~~~~~"

    IF pchec = ''.

      SELECT a~matnr, a~charg,a~vbelv, a~posnv,a~vgbel,a~vgpos,b~cuobj,a~erdat,a~erzet,a~vgtyp,
             c~cuobj AS cuobj1
            FROM lips AS a
            LEFT OUTER JOIN vbap AS b ON a~vgbel EQ b~vbeln AND a~vgpos EQ b~posnr
            LEFT OUTER JOIN vbap AS c ON a~vbelv EQ b~posnv AND a~vgpos EQ b~posnr
            INTO TABLE @DATA(lt_lips)
            FOR ALL ENTRIES IN @lt_lqua
            WHERE a~charg  EQ @lt_lqua-a-charg AND
                  a~matnr  EQ @lt_lqua-a-matnr AND
                  a~werks  EQ @lt_lqua-a-werks AND
                  a~lgort  EQ @lt_lqua-a-lgort AND
                  a~vgbel  EQ @lt_lqua-a-sonum+0(10).

    ELSE.

      DATA(lt_lqua_lc) = lt_lqua.                    " SOC : 8439
      DELETE lt_lqua_lc WHERE a-sonum NE ''.         " SOC : 8439
      IF lt_lqua_lc IS NOT INITIAL.                  " SOC : 8439

        SELECT a~matnr, a~charg,a~vbelv, a~posnv,a~vgbel,a~vgpos,b~cuobj,a~erdat,a~erzet,a~vgtyp,
               c~cuobj AS cuobj1
              FROM lips AS a
              LEFT OUTER JOIN vbap AS b ON a~vgbel EQ b~vbeln AND a~vgpos EQ b~posnr
              LEFT OUTER JOIN vbap AS c ON a~vbelv EQ b~posnv AND a~vgpos EQ b~posnr
              INTO TABLE @DATA(lt_lips5)
              FOR ALL ENTRIES IN @lt_lqua_lc
              WHERE a~charg  EQ @lt_lqua_lc-a-charg AND
                    a~matnr  EQ @lt_lqua_lc-a-matnr AND
                    a~werks  EQ @lt_lqua_lc-a-werks AND
                    a~lgort  EQ @lt_lqua_lc-a-lgort AND
                    a~vgbel  EQ @lt_lqua_lc-a-sonum+0(10).

              MOVE-CORRESPONDING lt_lips5 TO lt_lips.


      ENDIF.  " SOC : 8439

    ENDIF.

      SORT lt_lips BY matnr charg ASCENDING erdat DESCENDING erzet DESCENDING .

    "~~~~~~~~ Start: loop of LQUA Warehouse Stock ~~~~~~~~~~~~"
    LOOP AT lt_lqua ASSIGNING FIELD-SYMBOL(<fs_lqua>).

      MOVE-CORRESPONDING <fs_lqua>-a TO gw_matnr .
      MOVE-CORRESPONDING <fs_lqua> TO gw_matnr .

      gw_matnr-vbeln = <fs_lqua>-a-sonum+0(10).
      gw_matnr-posnr = <fs_lqua>-a-sonum+10(6).
      gw_matnr-qnty  = <fs_lqua>-a-verme.
      gw_matnr-flag = 'W' .

*------ Get CUOBJ no from VBAP----------------------------------------------*
      IF gw_matnr-vbeln IS NOT INITIAL AND gw_matnr-posnr IS NOT INITIAL.
        READ TABLE lt_cuobj ASSIGNING FIELD-SYMBOL(<fs_cuobj>) WITH KEY vbeln = gw_matnr-vbeln
                                                                        posnr = gw_matnr-posnr BINARY SEARCH.
        IF <fs_cuobj> IS ASSIGNED.
          gw_matnr-cuobj = <fs_cuobj>-cuobj .
        ENDIF.

*------In case of MTS(MAke to Stock) ist Delivery then so create------------*
      ELSEIF gw_matnr-vbeln IS INITIAL AND gw_matnr-posnr IS INITIAL AND gw_matnr-charg IS NOT INITIAL.

        IF lt_lips IS NOT INITIAL.
          READ TABLE lt_lips ASSIGNING FIELD-SYMBOL(<fs_lips>) WITH KEY matnr = gw_matnr-matnr
                                                                        charg = gw_matnr-charg BINARY SEARCH.
          IF <fs_lips> IS ASSIGNED AND sy-subrc EQ 0.
            CASE <fs_lips>-vgtyp.
              WHEN 'V'.
                gw_matnr-vbeln = <fs_lips>-vbelv.
                gw_matnr-posnr = <fs_lips>-posnv.
                gw_matnr-cuobj = <fs_lips>-cuobj1.
              WHEN OTHERS.
                gw_matnr-vbeln = <fs_lips>-vgbel.
                gw_matnr-posnr = <fs_lips>-vgpos.
                gw_matnr-cuobj = <fs_lips>-cuobj.
            ENDCASE.
          ENDIF.
        ENDIF.
*        REFRESH:lt_lips.
      ENDIF.
*-------------------------------------------------------------------------*

      CHECK  gw_matnr-vbeln IN s_vbeln[].
      CHECK  gw_matnr-posnr IN s_posnr[].

      MOVE-CORRESPONDING gw_matnr TO gw_lqua1 .

      APPEND gw_matnr TO gt_matnr .
      APPEND gw_lqua1 TO gt_lqua1 .

      CLEAR:gw_matnr,gw_matkl,gw_lqua.
    ENDLOOP.
    FREE lt_lqua."By Pratik
******** Start to added by Rohit on 27.04.2020 *******
* Logic : Batch Creation Date :-
*For Plant code 1021,  Check  the Plant, Material and Batch No in Table :- ZPP_PCKHDR
*If record exist, then show    ZPP_PCKHDR-BUDAT  as  Batch Creation Date,  Else as per Present Logic
    IF gt_matnr IS NOT INITIAL.
*************************soc 6394 add by saxi**************************
      SELECT werks
             lgort
             lgnum
        FROM t320 INTO TABLE gt_t320
        FOR ALL ENTRIES IN gt_matnr
        WHERE werks = gt_matnr-werks
        AND lgort = gt_matnr-lgort
        AND lgnum = gt_matnr-lgnum.

      SORT gt_t320 BY werks lgort lgnum.
*************************soc 6394 add by saxi**************************
*************** SOC : 4414 ***************
      BREAK : v00051.
      SELECT
        charg
        ztp
        FROM zpp_conf_batch
        INTO TABLE gt_zpp_conf_batch
        FOR ALL ENTRIES IN gt_matnr
        WHERE charg = gt_matnr-charg.
      SORT gt_zpp_conf_batch BY charg.
*************** EOC : 4414 ***************

      SELECT werks zbale_no budat matnr
       FROM zpp_pckhdr
       INTO TABLE gt_zpp_pckhdr
       FOR ALL ENTRIES IN gt_matnr
       WHERE werks = gt_matnr-werks AND
             zbale_no = gt_matnr-charg AND
             matnr = gt_matnr-matnr.
      SORT gt_zpp_pckhdr BY werks matnr zbale_no .
    ENDIF.

*~~~~ Add On 11-1-2019: By sirajit~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~* " Start
*~~~~ Logic: If warehouse Srock is select and stock belong in
*      multiple storage type & bin then show them separately ~~~~~~~~~~~~~*
    IF gt_lqua1 IS NOT INITIAL AND r2 IS INITIAL.
*    IF gt_lqua1 IS NOT INITIAL .
*~~~~ Add On 11-1-2019: By sirajit~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~* " End

      SORT gt_lqua1 BY werks lgnum lgort matnr matkl charg vbeln posnr ASCENDING bestq qnty DESCENDING .

      REFRESH:gt_matnr.
      CLEAR:gv_qnty,gw_matnr,gw_lqua1.

      "~~~~~~~~ Loop at Ware House Stock ~~~~~~~~~~~~~~" Start:
      LOOP AT gt_lqua1 INTO gw_lqua1 .

        MOVE-CORRESPONDING gw_lqua1 TO gw_matnr1 .
        gv_qnty = gv_qnty + gw_lqua1-qnty .
        AT NEW bestq.
          CLEAR: gw_matnr1-qnty .
          gw_matnr = gw_matnr1.
        ENDAT.

        AT END OF bestq.
          gw_matnr-qnty = gv_qnty .
          APPEND gw_matnr TO gt_matnr .
          CLEAR:gw_matnr,gw_lqua1,gv_qnty.
        ENDAT.
        CLEAR:gw_lqua1,gw_matnr1.
      ENDLOOP.
      "~~~~~~~~ Loop at Ware House Stock ~~~~~~~~~~~~~~" End:

      IF gt_matnr IS NOT INITIAL.
        DELETE gt_matnr WHERE qnty IS INITIAL .        " delete if qty is initial
        DELETE gt_matnr WHERE lgtyp EQ '999'  .        " Add on 31-1-2019 rqst by Pinky: Delete if lgtyp eq 999 ( Wrong data show)
      ENDIF.
      REFRESH: gt_lqua1 .
      CLEAR:gw_matnr,gw_matnr1,gw_lqua1,gv_qnty,sy-subrc.
    ENDIF.

  ENDIF.
*------------------------------------------------------------------------------------------------------------*
*   Insert All Sales Order                                                                                   *
*------------------------------------------------------------------------------------------------------------*
  IF lt_mska IS NOT INITIAL.
**>>> Get PO configaration deatils <<<**
    SELECT a~pwerk, a~kdauf,a~kdpos, a~matnr, a~cuobj

           FROM afpo AS a
           INNER JOIN aufk AS b ON a~aufnr EQ b~aufnr AND b~loekz EQ ''
           INNER JOIN mseg AS c ON a~aufnr EQ c~aufnr AND c~bwart EQ '101' AND a~matnr EQ c~matnr
           INTO TABLE @DATA(lt_afpo)
           FOR ALL ENTRIES IN @lt_mska
           WHERE a~pwerk EQ @lt_mska-a-werks AND
                 a~kdauf EQ @lt_mska-a-vbeln AND
                 a~kdpos EQ @lt_mska-a-posnr AND
                 a~matnr EQ @lt_mska-a-matnr AND
                 c~charg EQ @lt_mska-a-charg.

    SORT lt_afpo BY pwerk kdauf kdpos matnr cuobj .
    DELETE ADJACENT DUPLICATES FROM lt_afpo COMPARING ALL FIELDS .

**>>> Get SO configaration deatils in 561 upload case <<<**

    SELECT vbeln, posnr, cuobj
      FROM vbap INTO TABLE @DATA(lt_vbap_cuobj)
      FOR ALL ENTRIES IN @lt_mska
      WHERE vbeln EQ @lt_mska-a-vbeln AND
            posnr EQ @lt_mska-a-posnr .

    SORT lt_vbap_cuobj BY vbeln posnr .

  ENDIF.  "IF lt_mska is NOT INITIAL.

  IF lt_mska IS NOT INITIAL AND ( r1 EQ 'X' OR r3 EQ 'X' ).
    REFRESH: gt_matnr_temp.
    gt_matnr_temp = gt_matnr .                    " Store data in teporary table
    SORT gt_matnr_temp BY werks matnr charg vbeln posnr .
*    SORT lt_lqua BY a-matnr a-werks a-charg a-sonum .

    "~~~~~~~~ Loop at Sales Order Stock ~~~~~~~~~~~~~~" Start:
    LOOP AT lt_mska ASSIGNING FIELD-SYMBOL(<fs_mska>).

*      CHECK <fs_mska>-a-kaspe IS NOT INITIAL OR             " Block Stock
*            <fs_mska>-a-kains IS NOT INITIAL OR             " Quality Stock
*            <fs_mska>-a-kalab IS NOT INITIAL.               " Un-resticted Stock

*
*      CLEAR:lv_sales.
*      CONCATENATE <fs_mska>-a-vbeln <fs_mska>-a-posnr INTO lv_sales .
*      CONDENSE:lv_sales.
*
*      READ TABLE lt_lqua ASSIGNING FIELD-SYMBOL(<fs_valid>) WITH KEY a-matnr = <fs_mska>-a-matnr
*                                                                     a-werks = <fs_mska>-a-werks
*                                                                     a-charg = <fs_mska>-a-charg
*                                                                     a-sonum = lv_sales BINARY SEARCH.
      READ TABLE gt_matnr_temp  INTO gw_matnr_temp WITH KEY werks = <fs_mska>-a-werks
                                                            matnr = <fs_mska>-a-matnr
                                                            charg = <fs_mska>-a-charg
                                                            vbeln = <fs_mska>-a-vbeln
                                                            posnr = <fs_mska>-a-posnr BINARY SEARCH .
      CHECK  sy-subrc NE 0.
      CLEAR:sy-subrc,gw_matnr_temp.

      MOVE-CORRESPONDING <fs_mska>-a TO gw_matnr .
      MOVE-CORRESPONDING <fs_mska> TO gw_matnr .

      IF <fs_mska>-cuobj IS INITIAL.
        READ TABLE lt_afpo ASSIGNING FIELD-SYMBOL(<fs_afpo>) WITH KEY pwerk = <fs_mska>-a-werks
                                                                      kdauf = <fs_mska>-a-vbeln
                                                                      kdpos = <fs_mska>-a-posnr
                                                                      matnr = <fs_mska>-a-matnr BINARY SEARCH .
        IF sy-subrc EQ 0 AND <fs_afpo> IS ASSIGNED.
          gw_matnr-cuobj = <fs_afpo>-cuobj .
        ELSE.
          READ TABLE lt_vbap_cuobj ASSIGNING FIELD-SYMBOL(<fs_vbap_cuobj>)   " upload grige fabric charctaristic
                                             WITH KEY vbeln = <fs_mska>-a-vbeln
                                                      posnr = <fs_mska>-a-posnr BINARY SEARCH .
          IF sy-subrc EQ 0 AND <fs_vbap_cuobj> IS ASSIGNED.
            gw_matnr-cuobj = <fs_vbap_cuobj>-cuobj .
          ENDIF.
        ENDIF.  " READ TABLE lt_vbap_cuobj
      ENDIF.   " IF <fs_mska>-cuobj IS INITIAL.

      gw_matnr-qnty = <fs_mska>-a-kalab .
      gw_matnr-flag = 'S' .

      IF <fs_mska>-a-kaspe IS NOT INITIAL AND <fs_mska>-a-kains IS INITIAL.
        gw_matnr-qnty = <fs_mska>-a-kaspe .
        gw_matnr-bestq = 'S'.
      ELSEIF <fs_mska>-a-kaspe IS INITIAL AND <fs_mska>-a-kains IS NOT INITIAL.
        gw_matnr-qnty = <fs_mska>-a-kains  .
        gw_matnr-bestq = 'Q'.
      ENDIF.

      MOVE-CORRESPONDING <fs_mska>-a TO gw_mska .
      MOVE-CORRESPONDING <fs_mska> TO gw_mska .

      APPEND gw_matnr TO gt_matnr .
      APPEND gw_mska  TO gt_mska .

      CLEAR:gw_matnr,gw_matkl,gw_mska.
    ENDLOOP.

  ENDIF.

  FREE: lt_mska,lt_vbap_cuobj[]. "By Pratik

*------------------------------------------------------------------------------------------------------------*
*   Insert All Batch Data                                                                                    *
*------------------------------------------------------------------------------------------------------------*
  IF lt_mchb IS NOT INITIAL AND ( r1 EQ 'X' OR r3 EQ 'X' ) .
    REFRESH: gt_matnr_temp,lt_lips.

    gt_matnr_temp = gt_matnr .                    " Store data in teporary table
    SORT gt_matnr_temp BY werks lgort matnr charg .

    "~~~~~~~ Get sales order from delivery ~~~~~~~~~~~~~~~"
    SELECT a~matnr, a~charg,a~vbelv, a~posnv,a~vgbel,a~vgpos,b~cuobj,a~erdat,a~erzet,a~vgtyp,
               c~cuobj AS cuobj1
           FROM lips AS a
           LEFT OUTER JOIN vbap AS b ON a~vgbel EQ b~vbeln AND a~vgpos EQ b~posnr
           LEFT OUTER JOIN vbap AS c ON a~vbelv EQ b~posnv AND a~vgpos EQ b~posnr
           INTO TABLE @lt_lips
           FOR ALL ENTRIES IN @lt_mchb
           WHERE a~charg  EQ @lt_mchb-a-charg AND
                 a~matnr  EQ @lt_mchb-a-matnr AND
                 a~werks  EQ @lt_mchb-a-werks.

    SORT lt_lips BY matnr charg ASCENDING erdat DESCENDING erzet DESCENDING .

    "~~~~~~~ Start: Loop of Batch stock ~~~~~~~~"
    LOOP AT lt_mchb ASSIGNING FIELD-SYMBOL(<fs_mchb>).

*      CHECK <fs_mchb>-a-clabs IS NOT INITIAL OR
*            <fs_mchb>-a-cinsm IS NOT INITIAL OR
*            <fs_mchb>-a-cspem IS NOT INITIAL.

**-----in case of MTS stock show in Warehouse And BAtch TAble so show only one table data-------*
      READ TABLE gt_matnr_temp ASSIGNING FIELD-SYMBOL(<fs_matnr>) WITH KEY werks = <fs_mchb>-a-werks
                                                                           lgort = <fs_mchb>-a-lgort
                                                                           matnr = <fs_mchb>-a-matnr
                                                                           charg = <fs_mchb>-a-charg  BINARY SEARCH.
      CHECK sy-subrc NE 0 .

      MOVE-CORRESPONDING <fs_mchb>-a TO gw_matnr .
      MOVE-CORRESPONDING <fs_mchb> TO gw_matnr .

      gw_matnr-flag = 'B' .
      gw_matnr-qnty = <fs_mchb>-a-clabs .

      IF <fs_mchb>-a-cinsm IS NOT INITIAL AND <fs_mchb>-a-cspem IS INITIAL.
        gw_matnr-qnty = <fs_mchb>-a-cinsm .
        gw_matnr-bestq = 'Q'.
      ELSEIF <fs_mchb>-a-cinsm IS INITIAL AND <fs_mchb>-a-cspem IS NOT INITIAL.
        gw_matnr-qnty = <fs_mchb>-a-cspem  .
        gw_matnr-bestq = 'S'.
      ENDIF.

      MOVE-CORRESPONDING <fs_mchb>-a TO gw_mchb .
      MOVE-CORRESPONDING <fs_mchb> TO gw_mchb .

*------In case of MTS(MAke to Stock) ist Delivery then so create------------*
      IF gw_matnr-vbeln IS INITIAL AND gw_matnr-posnr IS INITIAL AND gw_matnr-charg IS NOT INITIAL.

        IF  lt_lips IS NOT INITIAL.

          READ TABLE lt_lips ASSIGNING <fs_lips> WITH KEY matnr = gw_matnr-matnr
                                                          charg = gw_matnr-charg BINARY SEARCH.
          IF <fs_lips> IS ASSIGNED AND sy-subrc EQ 0.
            CASE <fs_lips>-vgtyp.
              WHEN 'V'.                                         " STO against Purchase order
                gw_matnr-vbeln = <fs_lips>-vbelv.
                gw_matnr-posnr = <fs_lips>-posnv.
                gw_matnr-cuobj = <fs_lips>-cuobj1.
              WHEN OTHERS.                                      " Other then STO
                gw_matnr-vbeln = <fs_lips>-vgbel.
                gw_matnr-posnr = <fs_lips>-vgpos.
                gw_matnr-cuobj = <fs_lips>-cuobj.
            ENDCASE.
          ENDIF.
        ENDIF.
*        REFRESH:lt_lips.
        CLEAR sy-subrc.
      ENDIF.
*--------------------------------------------------------------------
      APPEND gw_matnr TO gt_matnr .
      APPEND gw_mchb TO gt_mchb.

      CLEAR:gw_matnr,gw_matkl ,gw_mchb.
    ENDLOOP.
  ENDIF.
  FREE lt_mchb. "By Pratik
*------------------------------------------------------------------------------------------------------------*
*   Insert All MARD Data                                                                                     *
*------------------------------------------------------------------------------------------------------------*
  IF lt_mard IS NOT INITIAL AND ( r1 EQ 'X' OR r3 EQ 'X' ) AND s_charg[] IS INITIAL.
    REFRESH:gt_matnr_temp.

    gt_matnr_temp = gt_matnr .
    SORT gt_matnr_temp BY werks matnr lgort .

    LOOP AT lt_mard ASSIGNING FIELD-SYMBOL(<fs_mard>).
      READ TABLE gt_matnr_temp ASSIGNING <fs_matnr> WITH KEY werks = <fs_mard>-a-werks
                                                             matnr = <fs_mard>-a-matnr
                                                             lgort = <fs_mard>-a-lgort BINARY SEARCH.
      CHECK sy-subrc NE 0 .
      MOVE-CORRESPONDING <fs_mard>-a TO gw_matnr .
      MOVE-CORRESPONDING <fs_mard>   TO gw_matnr .

      gw_matnr-flag = 'N' .
      gw_matnr-qnty = <fs_mard>-a-labst.

      MOVE-CORRESPONDING <fs_mard>-a TO gw_mard .
      MOVE-CORRESPONDING <fs_mard> TO gw_mard.

      APPEND gw_matnr TO gt_matnr .
      APPEND gw_mard TO gt_mard .

      CLEAR:gw_matnr,gw_matkl,gw_mard.
    ENDLOOP.
  ENDIF.
  FREE lt_mard. "By Pratik

  SORT gt_matnr BY werks lgort matnr charg .
  DELETE ADJACENT DUPLICATES FROM gt_matnr COMPARING ALL FIELDS .

  IF s_bestq IS NOT INITIAL.
    DELETE gt_matnr WHERE bestq NOT IN s_bestq .
  ENDIF.

  SORT gt_matkl BY matkl.
  CLEAR:sy-subrc .

*------------------------------------------------------------------------------------------------------------*
*   Delete Multiple data as per selection screen:1) Special Catagory Stock(BESTQ)                                 *
*------------------------------------------------------------------------------------------------------------*
  IF s_bestq[] IS NOT INITIAL.
    DELETE gt_matnr WHERE bestq NOT IN s_bestq[] .
  ENDIF.
  IF s_lgtyp[] IS NOT INITIAL.
    DELETE gt_matnr WHERE lgtyp NOT IN s_lgtyp[] .
  ENDIF.
  IF s_lgpla[] IS NOT INITIAL.
    DELETE gt_matnr WHERE lgpla NOT IN s_lgpla[] .
  ENDIF.
  IF s_sobkz[] IS NOT INITIAL.
    DELETE gt_matnr WHERE sobkz NOT IN s_sobkz[] .
  ENDIF.

  IF s_posnr[] IS NOT INITIAL  OR s_vbeln[] IS NOT INITIAL.
    IF s_vbeln[] IS NOT INITIAL.
      DELETE gt_matnr WHERE vbeln NOT IN s_vbeln[] .
      DELETE gt_matnr WHERE posnr NOT IN s_posnr[] .
    ELSEIF s_posnr[] IS NOT INITIAL AND  s_vbeln[] IS INITIAL .
      REFRESH: s_posnr[].
    ENDIF.
  ENDIF.

*---  If R3 is select then BLock Stock & Quality Stock Not Show --------------*
  IF r3 IS NOT INITIAL.

    r_bestq-sign = 'I'.
    r_bestq-option = 'EQ'.
    r_bestq-low = 'S'.      " block Stock
    APPEND r_bestq .
    CLEAR:r_bestq-low.

    r_bestq-low = 'Q'.      " Quality Stock
    APPEND r_bestq .
    CLEAR:r_bestq-low.

    DELETE gt_matnr WHERE bestq IN r_bestq[] .
    REFRESH:r_bestq[].

  ENDIF.
*------------------------------------------------------------------------------------------------------------*
*   Get All Charactaristic Code as per Table ZMM_STK_RPT                                                     *
*------------------------------------------------------------------------------------------------------------*
  REFRESH: gt_mm_stck_rpt, gt_stck_rpt_new .

  "~~~~~~~~~~~ Read All char from zmm_stck_rpt that main tain by User ~~~~~"
  IF gt_matnr[] IS NOT INITIAL.
    SELECT matkl, klart, class, hdrdesc, atnam, tabname, fldname
             FROM zmm_stck_rpt
             INTO TABLE @DATA(lt_stck_rpt)
             FOR ALL ENTRIES IN @gt_matnr
             WHERE matkl EQ @gt_matnr-matkl .

    IF sy-subrc EQ 0 .
      gt_mm_stck_rpt = lt_stck_rpt .

*-------------------------------------------------------------------------* Start
*  By Pass Table-ZMM_STCK_RPT Data with New  New Table data-ZMM_STCK_NEW
*  Add BY Surajit On 27-12-2019 Rqst By Pinky
*-------------------------------------------------------------------------*
      PERFORM stck_rpt_by_pass .
*-------------------------------------------------------------------------* End

      REFRESH lt_stck_rpt .
      lt_stck_rpt = gt_mm_stck_rpt .
      SORT lt_stck_rpt BY matkl klart class.
      DELETE ADJACENT DUPLICATES FROM lt_stck_rpt COMPARING matkl klart class.
    ENDIF.
  ENDIF.
  CLEAR: gw_matnr,gw_mm_stck_rpt,sy-subrc,gt_stck_rpt_new.

  "~~~~~~~~~~~ Loop At table Zmm_stck_rpt  ~~~~~"

  LOOP AT gt_matnr INTO gw_matnr .

    READ TABLE lt_stck_rpt INTO gw_mm_stck_rpt WITH KEY matkl = gw_matnr-matkl BINARY SEARCH.
    CHECK sy-subrc EQ 0.
    CLEAR:gw_mm_stck_rpt.

*    LOOP AT gt_mm_stck_rpt INTO gw_mm_stck_rpt USING KEY mgp WHERE matkl EQ gw_matnr-matkl.
    LOOP AT lt_stck_rpt INTO gw_mm_stck_rpt FROM sy-tabix.
      IF gw_mm_stck_rpt-matkl NE gw_matnr-matkl.
        EXIT.
      ENDIF.

*      ON CHANGE OF gw_mm_stck_rpt-class.
      CLEAR:gw_ppmatch,gw_ppbatch.

      CASE gw_mm_stck_rpt-klart.
        WHEN 022.
          CHECK gw_matnr-charg IS NOT INITIAL .
          gw_ppbatch-matnr   = gw_matnr-matnr.
          gw_ppbatch-werks   = gw_matnr-werks.
          gw_ppbatch-charg   = gw_matnr-charg.
*          APPEND gw_ppbatch TO gt_ppbatch.

          gw_ppbatch-read_char_val = abap_true .
          APPEND gw_ppbatch TO gt_ppbatch.

        WHEN 001 OR 200.
          gw_ppmatch-werks            = gw_matnr-werks .
          gw_ppmatch-matnr            = gw_matnr-matnr .
          gw_ppmatch-read_from_master = abap_true      .
          gw_ppmatch-classtype        = gw_mm_stck_rpt-klart .
          gw_ppmatch-classnum         = gw_mm_stck_rpt-class .
          APPEND gw_ppmatch TO gt_ppmatch .

        WHEN 300.
          CHECK gw_matnr-cuobj IS NOT INITIAL .
          ON CHANGE OF gw_matnr-matnr OR gw_matnr-cuobj .
            gw_ppmatch-matnr = gw_matnr-matnr .
            gw_ppmatch-cuobj = gw_matnr-cuobj .
            APPEND gw_ppmatch TO gt_ppmatch .
          ENDON.

      ENDCASE.
      CLEAR: gw_ppmatch,gw_ppbatch.

*      ENDON.
    ENDLOOP.
  ENDLOOP.
*  REFRESH:lt_stck_rpt.
  FREE:lt_stck_rpt.

*-----------------------------------------------------------------*
  IF gt_ppmatch[] IS NOT INITIAL OR gt_ppbatch[] IS NOT INITIAL.

    SORT gt_ppmatch BY werks matnr classtype classnum cuobj.
    SORT gt_ppbatch BY werks matnr charg read_char_val.

    DELETE ADJACENT DUPLICATES FROM gt_ppmatch COMPARING ALL FIELDS.
    DELETE ADJACENT DUPLICATES FROM gt_ppbatch COMPARING ALL FIELDS.

    CALL FUNCTION 'ZPP_READ_CHARACTERISTICS'
      EXPORTING
        iv_keydate    = sy-datum
      IMPORTING
        ev_return     = gv_return
      CHANGING
        cv_mat_char   = gt_ppmatch
        cv_batch_char = gt_ppbatch.
  ENDIF.

*------------------------------------------------------------------------------------------------------------*
*   Get All Text Data in Internal Table                                                                      *
*------------------------------------------------------------------------------------------------------------*
  IF gt_matnr IS NOT INITIAL.
    REFRESH: gt_matnr_temp .
    gt_matnr_temp = gt_matnr .

    SORT gt_matnr_temp BY matnr .
    SELECT matnr maktx FROM makt INTO TABLE gt_maktx
                       FOR ALL ENTRIES IN gt_matnr_temp
                       WHERE matnr EQ gt_matnr_temp-matnr AND
                             spras EQ 'E'.
    SORT gt_matnr_temp BY lgort .
    SELECT werks lgort lgobe FROM t001l INTO TABLE gt_lgobe
                 FOR ALL ENTRIES IN gt_matnr_temp
                 WHERE lgort EQ gt_matnr_temp-lgort AND
                       werks EQ gt_matnr_temp-werks .
    SORT gt_matnr_temp BY matkl .
    SELECT matkl wgbez FROM t023t INTO TABLE gt_wgbez
                   FOR ALL ENTRIES IN gt_matnr_temp
                   WHERE matkl EQ gt_matnr_temp-matkl AND
                         spras EQ 'E'.
    SORT gt_matnr_temp BY lgnum .
    SELECT lgnum lnumt FROM t300t INTO TABLE gt_lnumt
                   FOR ALL ENTRIES IN gt_matnr_temp
                   WHERE lgnum EQ gt_matnr_temp-lgnum AND
                         spras EQ 'E'.
    CLEAR:gt_matnr_temp.
*    REFRESH:gt_matnr_temp.
    FREE:gt_matnr_temp.

    SORT gt_maktx BY matnr .
*    DELETE ADJACENT DUPLICATES FROM gt_maktx COMPARING ALL FIELDS .

    SORT gt_lgobe BY werks lgort.
*    DELETE ADJACENT DUPLICATES FROM gt_lgobe COMPARING ALL FIELDS .

    SORT gt_wgbez BY matkl .
*    DELETE ADJACENT DUPLICATES FROM gt_wgbez COMPARING ALL FIELDS .

*    SORT gt_lnumt BY lgnum .
*    DELETE ADJACENT DUPLICATES FROM gt_lnumt COMPARING ALL FIELDS .
*------------------------------------------------------------------------------------------------------------*
*   Get All Sales Data to Internal Table                                                                      *
*------------------------------------------------------------------------------------------------------------*

    SELECT DISTINCT a~vbeln, a~posnr, a~matnr, a~charg, a~kdmat, a~kwmeng, a~vrkme, a~bwtar, a~zzppcmtdt,
                    a~zztradenm, a~zzkvgr1,a~matkl,a~zzdevelop_no,a~zzdevelop_item,a~zzmou_order,
           b~vbtyp, b~auart, b~vkgrp, b~vkbur, b~knumv, b~zz_sortorder, b~zzassortdt,a~zzcusreqd,
*           c~bzirk,
           e~bezei AS sf_text,
           f~bezei AS sg_text,
           g~bezei AS brnd_text

      FROM vbap AS a INNER JOIN vbak AS b ON a~vbeln EQ b~vbeln
*      INNER JOIN mska AS d ON a~vbeln EQ d~vbeln AND a~posnr EQ d~posnr AND d~kalab GT 0
*      LEFT OUTER JOIN vbkd AS c ON a~vbeln EQ c~vbeln
      LEFT OUTER JOIN tvkbt AS e ON b~vkbur EQ e~vkbur AND e~spras EQ 'E'
      LEFT OUTER JOIN tvgrt AS f ON b~vkgrp EQ f~vkgrp AND f~spras EQ 'E'
      LEFT OUTER JOIN tvv1t AS g ON a~zzkvgr1 EQ g~kvgr1 AND g~spras EQ 'E'

      INTO TABLE @DATA(lt_vbap)
      FOR ALL ENTRIES IN @gt_matnr
      WHERE a~vbeln EQ @gt_matnr-vbeln AND
            a~posnr EQ @gt_matnr-posnr.

    IF sy-subrc EQ 0 AND lt_vbap IS NOT INITIAL.
*      DELETE ADJACENT DUPLICATES FROM lt_vbap COMPARING ALL FIELDS .
      gt_vbap = lt_vbap .
*      SORT gt_vbap BY vbeln posnr .
      CLEAR:sy-subrc,lt_vbap.
    ENDIF.
*------------------------------------------------------------------------------------------------------------*
*   Get All Movement Type Data to Internal Table                                                             *
*------------------------------------------------------------------------------------------------------------*
*~~~~~~~~~~~~Add on 23-11-2018 for dump on SQL On large data ~~~~~~* Start

    MOVE-CORRESPONDING gt_matnr TO gt_matnr_mseg.                  "
    SORT gt_matnr_mseg BY werks matnr .
    DELETE ADJACENT DUPLICATES FROM gt_matnr_mseg COMPARING ALL FIELDS .

*~~~~~~~~~~~~Add on 23-11-2018 for dump on SQL On large data ~~~~~~* End

*    SELECT a~werks, a~matnr, d~budat,d~cpudt,d~cputm, a~mblnr, a~mjahr, a~zeile, a~line_id, a~bwart, a~lgort, a~charg, a~mat_kdauf, a~mat_kdpos, a~bwtar,
*                    a~menge, a~meins, a~erfmg, a~erfme, a~ebeln, a~ebelp, a~sjahr, a~smbln, a~smblp, a~aufnr,a~vfdat,
*                    a~umlgo,a~umcha,
*         b~zgateentryno, b~zinvoino, b~zinvoidt,
*         c~zentrydate,
**         e~pstyp,e~banfn,e~bnfpo,                           " Changes on 27-11-2018
*         f~steuc
**         g~vmsav                                            " Changes on 27-11-2018
*     FROM mseg AS a
*      INNER JOIN mkpf AS d ON a~mblnr EQ d~mblnr AND a~mjahr EQ d~mjahr
*      INNER JOIN marc AS f ON a~matnr EQ f~matnr AND a~werks EQ f~werks
*      LEFT OUTER JOIN ( zmm_migo_hdr AS b INNER JOIN zmm_weighinhdr AS c ON b~zgateentryno EQ c~zgateentryno ) ON a~mblnr EQ b~mblnr AND a~mjahr EQ b~mjahr
**      LEFT OUTER JOIN ekpo AS e ON a~ebeln EQ e~ebeln AND a~ebelp EQ e~ebelp
**      LEFT OUTER JOIN marc AS f ON a~matnr EQ f~matnr AND a~werks EQ f~werks
**      LEFT OUTER JOIN mbew AS g ON a~matnr EQ g~matnr AND a~werks EQ g~bwkey AND a~bwtar EQ g~bwtar AND g~vmvpr EQ 'S'
*      INTO TABLE @DATA(lt_mseg)
**      FOR ALL ENTRIES IN @gt_matnr
*      FOR ALL ENTRIES IN @gt_matnr_mseg
**      WHERE a~matnr EQ @gt_matnr-matnr AND
*      WHERE a~matnr EQ @gt_matnr_mseg-matnr AND           " Add on 23-11-2018
**            a~werks EQ @gt_matnr-werks AND
*            a~werks EQ @gt_matnr_mseg-werks AND            " Add on 23-11-2018
**            a~xauto EQ ''.
*            a~parent_id EQ ''.
**            a~bwart IN ('101','102','561','562','651','652').
**if this logig is not work then
*-------------------------------------------------------------------------* Add On 11-2-2019
    IF gt_matnr_mseg[] IS NOT INITIAL.
      SELECT a~werks, a~matnr, d~budat,d~cpudt,d~cputm, a~mblnr, a~mjahr, a~zeile, a~line_id, a~bwart, a~lgort,
             a~charg, a~mat_kdauf, a~mat_kdpos, a~bwtar,a~menge, a~meins, a~erfmg, a~erfme, a~ebeln, a~ebelp, a~sjahr,
             a~smbln, a~smblp, a~aufnr,a~vfdat,a~umwrk, a~ummat, a~umlgo,a~umcha,b~zgateentryno, b~zinvoino, b~zinvoidt,
             c~zentrydate,f~steuc,a~ablad
        FROM mseg AS a
        INNER JOIN mkpf AS d ON a~mblnr EQ d~mblnr AND a~mjahr EQ d~mjahr
        INNER JOIN marc AS f ON a~matnr EQ f~matnr AND a~werks EQ f~werks
        LEFT OUTER JOIN ( zmm_migo_hdr AS b INNER JOIN zmm_weighinhdr AS c ON b~zgateentryno EQ c~zgateentryno ) ON a~mblnr EQ b~mblnr AND a~mjahr EQ b~mjahr
        INTO TABLE @DATA(lt_mseg)
        FOR ALL ENTRIES IN @gt_matnr_mseg
        WHERE a~matnr EQ @gt_matnr_mseg-matnr
        AND a~werks EQ @gt_matnr_mseg-werks
        AND a~lgort EQ @gt_matnr_mseg-lgort
        AND a~charg EQ @gt_matnr_mseg-charg
        AND a~parent_id EQ ''.

      SELECT a~werks, a~matnr, d~budat,d~cpudt,d~cputm, a~mblnr, a~mjahr, a~zeile, a~line_id, a~bwart, a~lgort,
             a~charg, a~mat_kdauf, a~mat_kdpos, a~bwtar,a~menge, a~meins, a~erfmg, a~erfme, a~ebeln, a~ebelp, a~sjahr,
             a~smbln, a~smblp, a~aufnr,a~vfdat,a~umwrk, a~ummat, a~umlgo,a~umcha,b~zgateentryno, b~zinvoino, b~zinvoidt,
             c~zentrydate,f~steuc,a~ablad
        FROM mseg AS a
        INNER JOIN mkpf AS d ON a~mblnr EQ d~mblnr AND a~mjahr EQ d~mjahr
        INNER JOIN marc AS f ON a~matnr EQ f~matnr AND a~werks EQ f~werks
        LEFT OUTER JOIN ( zmm_migo_hdr AS b INNER JOIN zmm_weighinhdr AS c ON b~zgateentryno EQ c~zgateentryno ) ON a~mblnr EQ b~mblnr AND a~mjahr EQ b~mjahr
        APPENDING CORRESPONDING FIELDS OF TABLE @lt_mseg
        FOR ALL ENTRIES IN @gt_matnr_mseg
        WHERE a~ummat EQ @gt_matnr_mseg-matnr
        AND a~umwrk EQ @gt_matnr_mseg-werks
        AND a~umlgo EQ @gt_matnr_mseg-lgort
        AND a~umcha EQ @gt_matnr_mseg-charg
        AND a~parent_id EQ ''.
    ENDIF.
*-------------------------------------------------------------------------*
    DATA: lt_mseg_temp TYPE STANDARD TABLE OF ty_mseg,
          lw_mseg_temp TYPE ty_mseg.

    IF lt_mseg IS NOT INITIAL.
      SORT lt_mseg BY mjahr mblnr zeile .
      DELETE ADJACENT DUPLICATES FROM lt_mseg COMPARING ALL FIELDS .
      gt_mseg      = lt_mseg .
      lt_mseg_temp = lt_mseg .

*--------- Delete reverse document no -----------------*
      DELETE lt_mseg WHERE smbln IS INITIAL .
      DELETE gt_mseg WHERE smbln IS NOT INITIAL .

      SORT lt_mseg_temp[] BY mjahr mblnr zeile.
      SORT lt_mseg        BY sjahr smbln smblp.

      IF lt_mseg IS NOT INITIAL.
        LOOP AT lt_mseg ASSIGNING FIELD-SYMBOL(<fs_temp>).
          READ TABLE lt_mseg_temp INTO lw_mseg_temp WITH KEY mjahr = <fs_temp>-sjahr mblnr = <fs_temp>-smbln zeile = <fs_temp>-smblp BINARY SEARCH .
          CHECK sy-subrc EQ 0.
          lw_mseg_temp-flag = 'X'.
          MODIFY lt_mseg_temp FROM lw_mseg_temp INDEX sy-tabix .
          CLEAR:lw_mseg_temp.
        ENDLOOP .
        DELETE lt_mseg_temp WHERE flag EQ 'X'.
        IF sy-subrc EQ 0.
          REFRESH:gt_mseg.
          DELETE lt_mseg_temp WHERE smbln IS NOT INITIAL .
          gt_mseg = lt_mseg_temp .
        ENDIF.
      ENDIF.
      CLEAR:sy-subrc,lw_mseg_temp.
      FREE:lt_mseg_temp,lt_mseg .
    ENDIF.

    IF gt_mseg IS NOT INITIAL.
      gt_mseg_dest = gt_mseg .
      gt_mseg_blnk = gt_mseg .
      DELETE gt_mseg_blnk WHERE charg NE ''.
      SORT gt_mseg_blnk BY werks matnr lgort ASCENDING budat DESCENDING .
    ENDIF.
*------------------------------------------------------------------------------------------------------------*
*   Get All Movement Type Data to Internal Table                                                             *
*------------------------------------------------------------------------------------------------------------*
    REFRESH: gt_mseg261.
    IF gt_matnr[] IS NOT INITIAL.
      SELECT mblnr mjahr bwart charg
          FROM mseg INTO TABLE gt_mseg261
          FOR ALL ENTRIES IN gt_matnr
          WHERE charg EQ gt_matnr-charg AND
                bwart EQ '261'.

      SORT gt_mseg261 BY charg .
*------------------------------------------------------------------------------------------------------------*
*   Get All LIPS & LIKP Data                                                                                 *
*------------------------------------------------------------------------------------------------------------*
      SELECT  a~vgbel,
              a~vgpos,
              a~charg,
              a~vbeln,
              a~posnr,
              a~erdat,
              a~lfimg,
              a~vbelv,"SOC ADDED BY YASH PRD DUMP ISSUE || ATDK9A0L2X
              a~posnv "SOC ADDED BY YASH PRD DUMP ISSUE || ATDK9A0L2X
        FROM lips AS a INNER JOIN likp AS b ON a~vbeln EQ b~vbeln
        INTO TABLE @DATA(lt_lips1)
        FOR ALL ENTRIES IN @gt_matnr
        WHERE a~vgbel EQ @gt_matnr-vbeln AND
              a~vgpos EQ @gt_matnr-posnr AND
              a~charg EQ @gt_matnr-charg .

      IF lt_lips1 IS NOT INITIAL.
        SORT lt_lips1 BY vgbel vgpos charg ASCENDING erdat DESCENDING .
        gt_lips = lt_lips1 .
        SORT gt_lips BY vgbel vgpos charg .
        REFRESH:lt_lips1.
      ENDIF.

*---------------Get All LIPS & LIKP Data where STO is done ----------------------------*

      SELECT  a~vgbel,"SOC ADDED BY YASH PRD DUMP ISSUE || ATDK9A0L2X
              a~vgpos,"SOC ADDED BY YASH PRD DUMP ISSUE || ATDK9A0L2X
              a~charg,
              a~vbeln,
              a~posnr,
              a~erdat,
              a~lfimg,
              a~vbelv,
              a~posnv
            FROM lips AS a INNER JOIN likp AS b ON a~vbeln EQ b~vbeln
            INTO TABLE @lt_lips1
            FOR ALL ENTRIES IN @gt_matnr
            WHERE a~vbelv EQ @gt_matnr-vbeln AND
                  a~posnv EQ @gt_matnr-posnr AND
                  a~charg EQ @gt_matnr-charg .
    ENDIF.
    IF lt_lips1 IS NOT INITIAL.
      SORT lt_lips1 BY vgbel vgpos charg ASCENDING erdat DESCENDING .
      gt_lips_v = lt_lips1 .
      SORT gt_lips_v BY vgbel vgpos charg .
      REFRESH:lt_lips1.
    ENDIF.
    gt_lips_all[] = gt_lips[].
    APPEND LINES OF gt_lips_v TO gt_lips_all[].
    SORT gt_lips_all[] BY vbeln.
    DELETE ADJACENT DUPLICATES FROM gt_lips_all COMPARING vbeln.
    IF gt_lips_all[] IS NOT   INITIAL.
      SELECT vbeln, wbstk
          FROM vbuk
          FOR ALL ENTRIES IN @gt_lips_all
         WHERE vbeln = @gt_lips_all-vbeln
          INTO TABLE @gt_vbuk. "Logic added by Shashank on 14th July 2020

    ENDIF.
    CLEAR : gt_lips_all[].
*------------------------------------------------------------------------------------------------------------*
*   Get MCHA data                                                                                 *
*------------------------------------------------------------------------------------------------------------*
    IF gt_matnr[] IS NOT INITIAL.
*------------------------------------------>Soc By Devid-001
      IF gt_matnr IS NOT INITIAL.
        CLEAR : lrt_werks[],gt_zmm_amd_plantage[].
        DATA(gt_matnr_t) = gt_matnr.
        DELETE gt_matnr_t WHERE werks IS INITIAL .
        SORT gt_matnr_t BY werks.
        DELETE ADJACENT DUPLICATES FROM gt_matnr_t COMPARING werks.

        IF gt_matnr_t IS NOT INITIAL.
          SELECT old_plant,
                 new_plant
                 FROM zmm_amd_plantage
                 INTO TABLE @gt_zmm_amd_plantage
                 FOR ALL ENTRIES IN @gt_matnr_t
                 WHERE new_plant = @gt_matnr_t-werks.
          IF gt_zmm_amd_plantage IS NOT INITIAL.
            SORT gt_zmm_amd_plantage BY new_plant .

            CLEAR : lrt_werks_t[].
            lrt_werks_t = VALUE #( FOR <ls_amd_plantage> IN gt_zmm_amd_plantage ( sign = 'I'
                                                             option = 'EQ'
                                                             low = <ls_amd_plantage>-old_plant ) ).
            APPEND LINES OF lrt_werks_t TO lrt_werks.
          ENDIF.

          CLEAR : lrt_werks_t[].
          lrt_werks_t = VALUE #( FOR <ls_matnr_t> IN gt_matnr_t ( sign = 'I'
                                                           option = 'EQ'
                                                           low = <ls_matnr_t>-werks ) ).
          APPEND LINES OF lrt_werks_t TO lrt_werks.

          SORT lrt_werks BY low.
          DELETE ADJACENT DUPLICATES FROM lrt_werks COMPARING low.
        ENDIF.

        IF lrt_werks IS NOT INITIAL.
          SELECT a~werks a~matnr a~charg a~bwtar a~fvdt1 a~fvdt2 a~ersda
                 a~vfdat    "Insert by Sushen on 25.12.2024++,Dev id:6066,Reqby Parth
                 a~hsdat    "Insert by Sushen on 25.12.2024++,Dev id:6066,Reqby Parth
                 b~name1
              FROM mcha AS a LEFT OUTER JOIN lfa1 AS b ON a~lifnr EQ b~lifnr
              INTO TABLE gt_mcha
            FOR ALL ENTRIES IN gt_matnr
            WHERE a~werks IN lrt_werks AND
                  a~matnr EQ gt_matnr-matnr AND
                  a~charg EQ gt_matnr-charg AND
                  a~lvorm EQ ''.
          IF gt_mcha IS NOT INITIAL.
*            SORT GT_MCHA BY WERKS MATNR CHARG .
          ENDIF.
        ENDIF.
      ENDIF.
*------------------------------------------>Eoc By Devid-001
*      SELECT A~WERKS A~MATNR A~CHARG A~BWTAR A~FVDT1 A~FVDT2 A~ERSDA
*             A~VFDAT    "Insert by Sushen on 25.12.2024++,Dev id:6066,Reqby Parth
*             A~HSDAT    "Insert by Sushen on 25.12.2024++,Dev id:6066,Reqby Parth
*             B~NAME1
*          FROM MCHA AS A LEFT OUTER JOIN LFA1 AS B ON A~LIFNR EQ B~LIFNR
*          INTO TABLE GT_MCHA
*        FOR ALL ENTRIES IN GT_MATNR
*        WHERE A~WERKS EQ GT_MATNR-WERKS AND
*              A~MATNR EQ GT_MATNR-MATNR AND
*              A~CHARG EQ GT_MATNR-CHARG AND
*              A~LVORM EQ ''.

*    IF gt_mcha IS NOT INITIAL.
*      SORT gt_mcha BY werks matnr charg .
*    ENDIF.
*-----------------------------------------------------------------------------------------*
*    Performance Enhance
*-----------------------------------------------------------------------------------------*
      "~~~~~~~~~~~~~~ Transection Create Date ~~~~~~~~~~~~
      SELECT matnr charg werks lgort cpudt_mkpf
                              FROM mseg INTO TABLE gt_cpudt
                              FOR ALL ENTRIES IN gt_matnr
                              WHERE matnr EQ gt_matnr-matnr AND
                                    charg EQ gt_matnr-charg AND
                                    werks EQ gt_matnr-werks AND
                                    lgort EQ gt_matnr-lgort .
      SORT gt_cpudt BY werks lgort matnr charg .
      DELETE ADJACENT DUPLICATES FROM gt_cpudt COMPARING werks lgort matnr charg .
      "~~~~~~~~~~~~~~User manual Material UOM ~~~~~~~~~~~~*
      SELECT * FROM zsd_mat_uom
               INTO TABLE gt_mat_uom
               FOR ALL ENTRIES IN gt_matnr
               WHERE matkl EQ gt_matnr-matkl.

*    SORT gt_mat_uom BY matkl meins .

      "~~~~~~~~~~~~~~ Material Base UOM & Description ~~~~~~~~~~~~*
      SELECT a~matnr a~meins b~maktx a~bismt
               FROM mara AS a INNER JOIN makt AS b ON a~matnr EQ b~matnr
               INTO TABLE gt_mara_basic
               FOR ALL ENTRIES IN gt_matnr
               WHERE a~matnr EQ gt_matnr-matnr
               AND   b~spras EQ 'E'.

      "~~~~~~~~~~~~~~ Stock Category description ~~~~~~~~~~~~*
      SELECT domvalue_l ddtext
               FROM dd07t INTO TABLE gt_bestq
*             FOR ALL ENTRIES IN gt_matnr
               WHERE domname    EQ 'BESTQ'
               AND   ddlanguage EQ 'E'
               AND as4local     EQ 'A' .
*             AND domvalue_l   EQ gt_matnr-bestq .

      "~~~~~~~~~~~~~~ Sales Order Partner ~~~~~~~~~~~~*
      SELECT a~vbeln a~parvw a~kunnr b~name1
              FROM vbpa AS a
              INNER JOIN kna1 AS b ON a~kunnr EQ b~kunnr
              INTO TABLE gt_vbpa
              FOR ALL ENTRIES IN gt_matnr
              WHERE vbeln EQ gt_matnr-vbeln .

*    SORT gt_vbpa BY vbeln posnr parvw .

      DELETE ADJACENT DUPLICATES FROM gt_vbpa COMPARING vbeln parvw .

      "~~~~~~~~~~~~~~ Bale break for Block Stock ~~~~~~~~~~~~*
      SELECT zbale_no zreq_no zstat
                    FROM zsd_request
                    INTO TABLE gt_request
                    FOR ALL ENTRIES IN gt_matnr
                    WHERE zbale_no EQ gt_matnr-charg
                    AND   zd_flag  EQ ''.

      SORT gt_request BY zbale_no ASCENDING zreq_no DESCENDING .

      "~~~~~~~~~~~~~~ Material Price as per sales order  ~~~~~~~~~~~~*
      SELECT a~vbeln a~posnr a~bwkey a~matnr b~charg a~bwtar a~vprsv a~verpr a~stprs a~peinh
                  FROM ebew AS a
                  INNER JOIN mcha AS b ON a~matnr EQ b~matnr AND a~bwkey EQ b~werks AND a~bwtar EQ b~bwtar
                  INTO TABLE gt_ebew
                  FOR ALL ENTRIES IN gt_matnr
                  WHERE a~matnr EQ gt_matnr-matnr
                  AND   a~bwkey EQ gt_matnr-werks
                  AND   a~vbeln EQ gt_matnr-vbeln
                  AND   a~posnr EQ gt_matnr-posnr
                  AND   b~charg EQ gt_matnr-charg .

      SORT gt_ebew BY vbeln posnr bwkey matnr charg bwtar .
      "~~~~~~~~~~~~~~ Material Price as per batch  ~~~~~~~~~~~~*
      SELECT  a~bwkey a~matnr b~charg a~bwtar a~vprsv a~verpr a~stprs a~peinh
                    FROM mbew AS a INNER JOIN mcha AS b ON a~matnr EQ b~matnr AND a~bwkey EQ b~werks AND a~bwtar EQ b~bwtar
                    INTO TABLE gt_mbew_charg
                    FOR ALL ENTRIES IN gt_matnr
                    WHERE a~matnr EQ gt_matnr-matnr
                    AND   a~bwkey EQ gt_matnr-werks
                    AND   b~charg EQ gt_matnr-charg.

      SORT gt_mbew_charg BY bwkey matnr charg bwtar .
*    SORT gt_mbew_charg BY bwkey matnr charg .

      "~~~~~~~~~~~~~~ Material Price without batch  ~~~~~~~~~~~~*
      SELECT  bwkey matnr bwtar vprsv verpr stprs peinh
                 FROM mbew INTO TABLE gt_mbew
                 FOR ALL ENTRIES IN gt_matnr
                 WHERE matnr EQ gt_matnr-matnr
                 AND   bwkey EQ gt_matnr-werks
                 AND   bwtar EQ ''.

      SORT gt_mbew BY bwkey matnr .

      "~~~~~~~~~~~~~~ Material Ageing  ~~~~~~~~~~~~*
      SELECT matnr charg vfdat hsdat
            FROM mch1 INTO TABLE gt_mch1
            FOR ALL ENTRIES IN gt_matnr
            WHERE matnr EQ gt_matnr-matnr
            AND   charg EQ gt_matnr-charg .

      "Production Order Status Added by Shashank on 03-06-2019"
      SELECT mblnr mjahr zeile bwart matnr werks charg aufnr
        FROM mseg
        INTO TABLE gt_mseg_po
        FOR ALL ENTRIES IN gt_matnr
        WHERE werks = gt_matnr-werks
        AND matnr = gt_matnr-matnr
        AND charg = gt_matnr-charg
        AND bwart = '101'.
    ENDIF.
    SORT gt_mseg_po BY werks matnr charg bwart.
    SORT gt_mseg BY charg.
    IF gt_mseg_po IS NOT INITIAL.
      SELECT aufnr objnr
        FROM aufk
        INTO TABLE gt_aufk
        FOR ALL ENTRIES IN gt_mseg_po
        WHERE aufnr = gt_mseg_po-aufnr.
      IF gt_aufk IS NOT INITIAL.
        SELECT *
          FROM jest
          INTO TABLE gt_jest
          FOR ALL ENTRIES IN gt_aufk
          WHERE objnr = gt_aufk-objnr
          AND stat = 'I0045'
          AND inact NE 'X'.
      ENDIF.
    ENDIF.
    SORT : gt_aufk BY aufnr,
           gt_jest BY objnr.
    "Production Order Status Added by Shashank on 03-06-2019"
  ENDIF.

  IF gt_vbap IS NOT INITIAL.
    "~~~~~~~~~~~~~~ Sales District ~~~~~~~~~~~~*
    SELECT DISTINCT a~vbeln a~posnr a~bstkd_e a~posex_e a~bzirk
           b~bztxt
               FROM vbkd AS a
               LEFT OUTER JOIN t171t AS b ON a~bzirk EQ b~bzirk AND b~spras EQ 'E'
               INTO TABLE gt_vbkd
               FOR ALL ENTRIES IN gt_vbap
               WHERE vbeln EQ gt_vbap-vbeln .

*    SORT gt_vbkd BY vbeln posnr .
*    DELETE ADJACENT DUPLICATES FROM gt_vbkd COMPARING ALL FIELDS .

    "~~~~~~~~~~~~~~ Sales Order Price ~~~~~~~~~~~~*
    SELECT knumv kposn kbetr
              FROM konv INTO TABLE gt_konv "gw_final-so_price
              FOR ALL ENTRIES IN gt_vbap
              WHERE knumv EQ gt_vbap-knumv
              AND   kschl IN ('ZR00', 'ZR01','ZR05','ZE00','ZE03').
    SORT gt_konv BY knumv kposn.
  ENDIF.
*---- Boc By Satyen for Performance improvement on 21.09.2022
  gt_vbkdn[] = gt_vbkd[].
  SORT : gt_vbkdn BY bzirk.
  DELETE ADJACENT DUPLICATES FROM gt_vbkdn COMPARING bzirk.
  IF gt_vbkdn[] IS NOT INITIAL.

    SELECT code ,final_seg ,mkt_seg
            FROM zsd_segment
            FOR ALL ENTRIES IN @gt_vbkdn
            WHERE code = @gt_vbkdn-bzirk
          INTO TABLE @gt_zsd_segment.
  ENDIF.
  CLEAR : gt_vbkdn[].
*---- Eoc By Satyen for Performance improvement on 21.09.2022
*--------------------------------------------------------------------------------------*
  DATA: lt_ekpo_temp TYPE STANDARD TABLE OF ty_ekpo.

  IF gt_mseg IS NOT INITIAL.

    MOVE-CORRESPONDING gt_mseg TO lt_ekpo_temp .
    DELETE lt_ekpo_temp WHERE ebeln IS INITIAL .

    SORT lt_ekpo_temp BY ebeln ebelp .
    DELETE ADJACENT DUPLICATES FROM lt_ekpo_temp COMPARING ebeln ebelp .

    "********************************************"Start
    "01-06-2019 By Shashank for status"
    IF lt_ekpo_temp[] IS NOT INITIAL.
      SELECT ebeln ebelp loekz elikz
        FROM ekpo
        INTO TABLE gt_ekpo_st
        FOR ALL ENTRIES IN lt_ekpo_temp
        WHERE ebeln EQ lt_ekpo_temp-ebeln
        AND ebelp EQ  lt_ekpo_temp-ebelp
        AND loekz = ' '
        AND elikz = ' '.

      SELECT a~ebeln, a~ebelp, a~pstyp, a~banfn, a~bnfpo,
             c~name1,
             d~name1 AS sto_name1
              FROM ekpo AS a
              INNER JOIN ekko AS b ON a~ebeln EQ b~ebeln
              LEFT OUTER JOIN ( lfa1 AS e INNER JOIN adrc AS c ON e~adrnr EQ c~addrnumber ) ON b~lifnr EQ e~lifnr
              LEFT OUTER JOIN t001w AS d ON b~reswk EQ d~werks
              INTO TABLE @DATA(lt_ekpo)
              FOR ALL ENTRIES IN @lt_ekpo_temp
              WHERE a~ebeln EQ @lt_ekpo_temp-ebeln AND
                    a~ebelp EQ @lt_ekpo_temp-ebelp .
    ENDIF.
    SORT lt_ekpo BY ebeln ebelp .
    DELETE ADJACENT DUPLICATES FROM lt_ekpo COMPARING ebeln ebelp .
    gt_ekpo = lt_ekpo.
    "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~" End

    IF gt_ekpo IS NOT INITIAL .
      SELECT banfn bnfpo ernam bednr                   " BEDNR- change by Hiren Bhoi
              FROM eban INTO TABLE gt_eban
              FOR ALL ENTRIES IN gt_ekpo
              WHERE banfn EQ gt_ekpo-banfn AND
                    bnfpo EQ gt_ekpo-bnfpo.     " Added by Hiren Bhoi
      SORT gt_eban BY banfn bnfpo bednr .       " BEDNR- Added by Hiren Bhoi
      DELETE ADJACENT DUPLICATES FROM gt_eban COMPARING banfn bnfpo bednr.
    ENDIF.

    IF gt_mseg[] IS NOT INITIAL.
      SELECT mjahr mblnr matnr zeile prueflos
              FROM qals INTO TABLE gt_qals
              FOR ALL ENTRIES IN gt_mseg
              WHERE mjahr EQ gt_mseg-mjahr
              AND   mblnr EQ gt_mseg-mblnr
              AND   zeile EQ gt_mseg-zeile .

      SORT gt_qals BY mjahr mblnr zeile matnr  .
    ENDIF.
  ENDIF.

  "~~~~~~~~~~~~~~ PO Text for Item Category ~~~~~~~~~~~~*
  SELECT * FROM t163y INTO TABLE gt_pstyp WHERE spras EQ 'E'.
  SORT gt_pstyp BY pstyp .

  "~~~~~~~~~~~~~~ User Name As per Id ~~~~~~~~~~~~~~~~~*
  SELECT a~bname a~persnumber b~name_text
           FROM usr21 AS a
           INNER JOIN adrp AS b ON a~persnumber EQ b~persnumber
           INTO TABLE gt_usr21 .

  SORT gt_usr21 BY bname persnumber .

*--------------------------------------------------------------------------------------*
*  Grey Issue & Plant qty: Mseg 261 - 261 gainst MATKL = ('NGF','YGF','ISG','IGF') and SO & SO Line
*--------------------------------------------------------------------------------------*
  IF '1012' IN s_werks[].
    PERFORM gey_matkl .          " Create range table of material group for grey issue & Plan
    IF gt_matnr[] IS NOT INITIAL.
      SELECT a~werks,a~mat_kdauf, a~mat_kdpos,a~matnr,a~mjahr,a~mblnr,a~zeile,a~aufnr,
                     a~bwart, a~menge, a~meins, a~cpudt_mkpf, a~cputm_mkpf, a~budat_mkpf,
                     a~sjahr, a~smbln, a~smblp,
             b~matkl
        FROM mseg AS a
        INNER JOIN mara AS b ON a~matnr EQ b~matnr

        INTO TABLE @DATA(lt_pp261)
        FOR ALL ENTRIES IN @gt_matnr
        WHERE a~werks     EQ '1012'          AND
              a~mat_kdauf EQ @gt_matnr-vbeln AND
              a~mat_kdpos EQ @gt_matnr-posnr AND
              a~matnr     EQ @gt_matnr-matnr AND
              a~parent_id EQ ''              AND
              a~bwart     IN ( '261','262' ) AND
              b~matkl     IN @rt_issue_matkl." ( 'NGF','YGF','ISG','IGF' ).
    ENDIF.
    IF lt_pp261 IS NOT INITIAL.

      SORT lt_pp261 BY werks mat_kdauf mat_kdpos matnr.

      LOOP AT lt_pp261 ASSIGNING FIELD-SYMBOL(<fs_pp261>) .

        CASE <fs_pp261>-bwart.
          WHEN '261'.
            gw_pp261-menge = gw_pp261-menge + <fs_pp261>-menge .

            "~~~~ Last Issue date ~~~~~~~~~~~~~: Stat
            IF line_exists( lt_pp261[ bwart = '262' sjahr = <fs_pp261>-mjahr smbln = <fs_pp261>-mblnr
                                      smblp = <fs_pp261>-zeile ] ).
            ELSE.
              IF  gw_pp261-budat LT <fs_pp261>-budat_mkpf.
                gw_pp261-budat = <fs_pp261>-budat_mkpf .
              ENDIF.
            ENDIF.
            "~~~~ Last Issue date ~~~~~~~~~~~~~: End

          WHEN '262'.
            gw_pp261-menge = gw_pp261-menge - <fs_pp261>-menge .
        ENDCASE.

        AT END OF mat_kdpos.
          gw_pp261-werks      = <fs_pp261>-werks .
          gw_pp261-mat_kdauf  = <fs_pp261>-mat_kdauf .
          gw_pp261-mat_kdpos  = <fs_pp261>-mat_kdpos .
          gw_pp261-matnr      = <fs_pp261>-matnr .
          gw_pp261-menge      = gw_pp261-menge .
          gw_pp261-meins      = <fs_pp261>-meins .
          gw_pp261-budat      = gw_pp261-budat.

          APPEND gw_pp261 TO gt_pp261.
          CLEAR gw_pp261.
        ENDAT.

      ENDLOOP.   "  LOOP AT lt_pp261 ASSIGNING
*      SORT gt_pp261 BY werks mat_kdauf mat_kdpos .
    ENDIF.       " IF lt_pp261 IS NOT INITIAL.

    "~~~~~~ Total batch quantity as per so & Soline obly for Mat Grp NGF, ISG, YGF,IGF~~"
    DATA: lt_tt_btch_stck TYPE STANDARD TABLE OF ty_tt_btch_stck.

    lt_tt_btch_stck = CORRESPONDING #( gt_matnr MAPPING werks = werks vbeln = vbeln posnr = posnr
                          matkl = matkl matnr = matnr menge = qnty ) .

    DELETE lt_tt_btch_stck WHERE matkl NOT IN rt_issue_matkl.
    SORT lt_tt_btch_stck BY werks vbeln posnr .

    LOOP AT lt_tt_btch_stck ASSIGNING FIELD-SYMBOL(<fs_stck>).

      gw_tt_btch_stck-menge = gw_tt_btch_stck-menge + <fs_stck>-menge .

      AT END OF posnr .
        gw_tt_btch_stck-werks = <fs_stck>-werks .
        gw_tt_btch_stck-vbeln = <fs_stck>-vbeln .
        gw_tt_btch_stck-posnr = <fs_stck>-posnr .
        gw_tt_btch_stck-matkl = <fs_stck>-matkl .
        gw_tt_btch_stck-matnr = <fs_stck>-matnr .
        gw_tt_btch_stck-menge = gw_tt_btch_stck-menge .

        APPEND gw_tt_btch_stck TO gt_tt_btch_stck .
        CLEAR gw_tt_btch_stck.
      ENDAT.
    ENDLOOP.

    SORT gt_tt_btch_stck BY werks vbeln posnr .

    FREE: lt_pp261,lt_tt_btch_stck .",lt_pp.
  ENDIF. " IF '1012' IN s_werks[].

*--------------------------------------------------------------------------------------*
*----- Add On 11-2-2019 by surajit Get Defect code ----------------*
  IF gt_matnr IS NOT INITIAL.
    SELECT * FROM zzdefects INTO TABLE gt_defects
       FOR ALL ENTRIES IN gt_matnr
      WHERE zplant EQ gt_matnr-werks AND
            matkl  EQ gt_matnr-matkl .
  ENDIF.
*--------------------------------------------------------------------------------------*
*------  Ad by surajit 29-Aug-2019-- 315 Mov data------*
  IF gt_mseg_dest IS NOT INITIAL.
    gt_mseg_315 = gt_mseg_dest .

    DELETE gt_mseg_315 WHERE bwart NE '315' .
    SORT gt_mseg_315 BY werks matnr charg cpudt DESCENDING cputm DESCENDING .
  ENDIF.
*--------------------------------------------------------------------------------------*
*  Ad by surajit 21-Aug-2019 Non Batch Doc movement data
*--------------------------------------------------------------------------------------*
  DATA: r_bwart     TYPE RANGE OF bwart,
        r_bwart_oth TYPE RANGE OF bwart,
        r_charg     TYPE RANGE OF charg_d.

  CLEAR: r_bwart,r_charg,r_bwart_oth .

  r_bwart     = VALUE #( sign = 'I' option = 'EQ' ( low = '101' ) ( low = '561' ) ( low = 'Z32' ) ) .
  r_bwart_oth = VALUE #( sign = 'I' option = 'EQ' ( low = '311' ) ( low = '561' ) ( low = 'Z32' ) ) .
  r_charg     = VALUE #( sign = 'I' option = 'CP' ( low = '*OTHER*' ) ). "


  IF gt_mseg_dest IS NOT INITIAL.

*-----------" Non Batch management and Split Valuation materila agging"--------*
    IF gt_matnr[] IS NOT INITIAL.
      SELECT a~werks a~matnr a~xchpf
             b~bwtty
        FROM marc AS a
        INNER JOIN mbew AS b ON a~werks EQ b~bwkey AND a~matnr EQ b~matnr
        INTO TABLE gt_marc
        FOR ALL ENTRIES IN gt_matnr
        WHERE a~werks EQ gt_matnr-werks AND
              a~matnr EQ gt_matnr-matnr AND
              a~xchpf EQ ''.
    ENDIF.
    SORT gt_marc BY werks matnr .
    DELETE ADJACENT DUPLICATES FROM gt_marc COMPARING ALL FIELDS .

    gt_mseg_ne  = gt_mseg_dest .
    DELETE gt_mseg_ne WHERE bwart NOT IN r_bwart.
    SORT   gt_mseg_ne   BY werks matnr lgort kdauf kdpos budat DESCENDING cputm DESCENDING .

*-----------" 'OTHER' Batch materila agging"--------*
    gt_mseg_oth = gt_mseg_dest .
    DELETE gt_mseg_oth WHERE bwart NOT IN r_bwart_oth.

    lt_mseg = gt_mseg_oth .
    DELETE lt_mseg     WHERE bwart NE '561'.
    DELETE lt_mseg     WHERE charg NOT IN r_charg.

    DELETE gt_mseg_oth WHERE bwart EQ '561'.
    DELETE gt_mseg_oth WHERE umcha NOT IN r_charg.

    "----move 561 data to final mseg other table----"
    LOOP AT lt_mseg INTO gw_mseg.
      gw_mseg-umwrk = gw_mseg-werks.
      gw_mseg-ummat = gw_mseg-matnr.
      gw_mseg-umlgo = gw_mseg-lgort.
      gw_mseg-umcha = gw_mseg-charg.

      APPEND gw_mseg TO gt_mseg_oth.
      CLEAR:gw_mseg.
    ENDLOOP."LOOP AT lt_mseg INTO lw_mseg.

    SORT gt_mseg_oth BY werks ummat umlgo umcha kdauf kdpos budat DESCENDING cputm DESCENDING .

  ENDIF."IF gt_mseg_dest IS NOT INITIAL.
*--------------------------------------------------------------------------------------*
  "Added By Shashank on 09.01.2020 to Display Department and Operation "
  IF gt_matnr[] IS NOT INITIAL..
    SELECT aufnr werks bigroll rmzhl vornr ktsch wipbatch rktsch
      FROM zpp_conf_fn_hd
      INTO TABLE gt_conf_hd
      FOR ALL ENTRIES IN gt_matnr
      WHERE werks = gt_matnr-werks
      AND wipbatch = gt_matnr-charg.
  ENDIF.
  SORT gt_conf_hd BY werks wipbatch.
  IF gt_conf_hd IS NOT INITIAL.
    SELECT *
      FROM t435t
      INTO TABLE gt_t435t
      FOR ALL ENTRIES IN gt_conf_hd
      WHERE spras = sy-langu
      AND vlsch = gt_conf_hd-ktsch.

    SELECT *
    FROM t435t
    INTO TABLE gt_t435t_r
    FOR ALL ENTRIES IN gt_conf_hd
    WHERE spras = sy-langu
    AND vlsch = gt_conf_hd-rktsch.

    SORT :gt_t435t BY  spras vlsch,
          gt_t435t_r BY  spras vlsch.
  ENDIF.
  "Added By Shashank on 09.01.2020 to Display Department and Operation "

  CLEAR: sy-subrc.

  FREE: lt_afpo, lt_cuobj, lt_lips, lt_lips1, lt_lqua, lt_mard, lt_mchb, lt_mchb, lt_mseg,
      lt_mska, lt_stck_rpt, lt_vbap,lt_ekpo_temp,lt_mseg_temp,lt_tt_btch_stck.
  FREE: gt_mseg,gt_matnr_temp.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  FINAL_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM final_data .
*------------------------------------------------------------------------------------------------------------*
*   Send All data to Final Table                                                                             *
*   Final TAble Divide by 4 Part: Part1 all Basic Details                                                    *
*                                 Part2 all Sales related Details                                            *
*                                 Part3 all Movement Type Details                                            *
*                                 Part4 all Charactaristic Details                                           *
*                                 Part5  Some Calculation base on some fielld                                *
*------------------------------------------------------------------------------------------------------------*

  SORT gt_ppmatch BY matnr classtype classnum .
  gt_ppmatchn[] = gt_ppmatch[].
  SORT gt_ppmatchn BY matnr cuobj .


  DATA(gt_matnrn) = gt_matnr[].
  DELETE gt_matnrn WHERE vbeln IS INITIAL.
  SORT gt_matnrn BY matnr vbeln posnr.
  DELETE ADJACENT DUPLICATES FROM gt_matnrn COMPARING matnr vbeln posnr.
  IF gt_matnrn[] IS NOT INITIAL.
    SELECT DISTINCT matnr , kdauf , kdpos , aufnr , sernr
                          FROM resb
                          FOR ALL ENTRIES IN @gt_matnrn
                          WHERE matnr = @gt_matnrn-matnr
                            AND kdauf = @gt_matnrn-vbeln
                            AND kdpos = @gt_matnrn-posnr
                    INTO TABLE @gt_resb .

  ENDIF.
*  SORT gt_resb BY matnr kdauf kdpos.
  DELETE ADJACENT DUPLICATES FROM gt_resb COMPARING matnr kdauf kdpos.

  gt_jest_input = VALUE #( FOR ls IN gt_matnrn
                       (
                       objnr = |VB{ ls-vbeln }{ ls-posnr }|
                       ) ).

  IF gt_jest_input[] IS NOT INITIAL.
    SELECT objnr , inact
      FROM jest
      FOR ALL ENTRIES IN @gt_jest_input
      WHERE objnr = @gt_jest_input-objnr
      AND  stat EQ 'E0007'
      AND  inact <> ' '
      INTO TABLE @gt_jeststatus.
  ENDIF.
  CLEAR : gt_matnrn[].
  SORT : gt_jeststatus BY objnr.

*****
*****  gt_mm_stck_rptn = VALUE #( FOR lscopy IN gt_mm_stck_rpt WHERE ( hdrdesc = 'ORIGINAL SALES ORDER'
*****                                                                  OR hdrdesc = 'SHADE / COLOUR'
*****                                                                  OR hdrdesc = 'YARN1 DESC'
*****                                                                  OR hdrdesc = 'YARN2 DESC'
*****                                                                  OR hdrdesc = 'YARN3 DESC'
*****                                                                  OR hdrdesc = 'YARN4 DESC') ( lscopy ) ).
*****  DELETE ADJACENT DUPLICATES FROM gt_mm_stck_rptn COMPARING atnam.
*****  gt_char_tab = VALUE #( FOR ls_main IN   gt_mm_stck_rptn
*****                         FOR ls_char_tab IN gt_ppbatch
*****                          FOR ls_char_tab1 IN ls_char_tab-char_tab
*****                          WHERE ( atnam = ls_main-atnam )
*****                              (
*****                              hdrdesc = ls_main-hdrdesc
*****                              atnam = ls_char_tab1-atnam
*****                              atwrt = |{ ls_char_tab1-atwrt ALPHA = IN }|
*****                              )
*****                              ).
*****
*****  gt_char_tabm = VALUE #( FOR ls_mainm IN   gt_mm_stck_rptn
*****                         FOR ls_char_tabm IN gt_ppmatch
*****                          FOR ls_char_tab1m IN ls_char_tabm-char_tab
*****                          WHERE ( atnam = ls_mainm-atnam )
*****                              (
*****                              hdrdesc = ls_mainm-hdrdesc
*****                              atnam = ls_char_tab1m-atnam
*****                              atwrt = |{ ls_char_tab1m-atwrt ALPHA = IN }|
*****                              )
*****                              ).
*****
*****  APPEND LINES OF gt_char_tabm[] TO gt_char_tab[].
*****  SORT : gt_char_tab BY hdrdesc atnam atwrt.
*****  DELETE ADJACENT DUPLICATES FROM gt_char_tab COMPARING hdrdesc atnam atwrt.
*****  gt_char_tabn = VALUE #( FOR ls_vbak IN gt_char_tab WHERE ( hdrdesc = 'ORIGINAL SALES ORDER' ) ( ls_vbak ) ).
*****  IF gt_char_tabn[] IS NOT INITIAL.
*****    SELECT DISTINCT vbeln ,  auart
*****            FROM vbak
*****            FOR ALL ENTRIES IN @gt_char_tabn
*****            WHERE vbeln EQ @gt_char_tabn-atwrt+8(10)
*****          INTO TABLE @gt_vbak.
*****    CLEAR : gt_char_tabn[].
*****  ENDIF.
*****
*****  DELETE ADJACENT DUPLICATES FROM gt_char_tab COMPARING hdrdesc atnam atwrt.
*****  gt_char_tabn = VALUE #( FOR ls_makt IN gt_char_tab WHERE ( hdrdesc = 'SHADE / COLOUR'
*****                                                            OR hdrdesc = 'YARN1 DESC'
*****                                                            OR hdrdesc = 'YARN2 DESC'
*****                                                            OR hdrdesc = 'YARN3 DESC'
*****                                                            OR hdrdesc = 'YARN4 DESC'
*****
*****                                                            ) ( ls_makt ) ).
*****  IF gt_char_tabn[] IS NOT INITIAL.
*****    SELECT DISTINCT matnr , maktx
*****            FROM makt
*****            FOR ALL ENTRIES IN @gt_char_tabn
*****            WHERE matnr EQ @gt_char_tabn-atwrt
*****            AND   spras = @sy-langu
*****          INTO TABLE @gt_makt.
*****    CLEAR : gt_char_tabn[].
*****  ENDIF.
*****************************************Soc BY Devid-4728
  DATA: lt_conf   TYPE TABLE OF conf_out .

  REFRESH gt_mat_sort .
  gt_mat_sort = gt_matnr .
  SORT gt_mat_sort BY vbeln posnr .
*****************************************Eoc BY Devid-4728

*------------------------------------------->Soc By Devid-5287
  IF gt_ppbatch IS NOT INITIAL.
    DATA(gt_ppbatch_n) = gt_ppbatch .
    SORT gt_ppbatch_n BY matnr werks charg .
  ENDIF.
*------------------------------------------->Eoc By Devid-5287

  LOOP AT gt_mat_sort INTO gw_matnr.  "Replaced gt_mat_sort from gt_matnr - "Soc BY Devid-4728

    CLEAR:gv_flag1,gv_flag2,gv_flag3 .
*************************soc 6394 add by saxi**************************
    IF gw_matnr-lgnum  IS NOT INITIAL.

      READ TABLE gt_t320 INTO gw_t320 WITH KEY werks = gw_matnr-werks lgort = gw_matnr-lgort lgnum = gw_matnr-lgnum BINARY SEARCH.
      IF sy-subrc = 0.
        gw_final-lgnum = gw_matnr-lgnum .
      ELSE.
        CLEAR:gw_final,gw_t320.
        CONTINUE.
      ENDIF.
    ENDIF.
*************************eoc 6394 add by saxi**************************
    PERFORM insert_data_part1.
    PERFORM insert_data_part2.
    PERFORM insert_data_part3.
    PERFORM insert_data_part4.
*------------------------------------------------------------------------------------------------------------*
*   Part 5: Some Calculation base on final wark Area value                                                                                                  *
*------------------------------------------------------------------------------------------------------------*
    PERFORM insert_data_part5.
*------------Append Final workarea Data to Final Table-----------------*

*------------------------------------------->Soc By Devid-5287
    READ TABLE gt_ppbatch_n INTO DATA(gw_ppbatch_n) WITH KEY matnr = gw_matnr-matnr
                                                             werks = gw_matnr-werks
                                                             charg = gw_matnr-charg BINARY SEARCH .
    IF sy-subrc EQ 0 AND gw_ppbatch_n-char_tab[] IS NOT INITIAL.
      gw_final-zwash_status   = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_WSST' ]-atwrt OPTIONAL ) .
      gw_final-zwash_lot_no   = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_WSLN' ]-atwrt OPTIONAL ) .
      gw_final-zwash_shade_block = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_WSSD' ]-atwrt OPTIONAL ) .
      gw_final-zunwash_shade_block  = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_UWSD' ]-atwrt OPTIONAL ) .
      gw_final-ztapper_seq   = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_TPSQ' ]-atwrt OPTIONAL ) .
      gw_final-znet_wt     = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_NTWT' ]-atwrt OPTIONAL ) .
      gw_final-zgross_wt      = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_GSWT' ]-atwrt OPTIONAL ) .
      gw_final-zwash_counter  = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_WSCN' ]-atwrt OPTIONAL ) .
      gw_final-zdpt_syd      = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_DPSY' ]-atwrt OPTIONAL ) .
      gw_final-zint_tag       = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_TAG1' ]-atwrt OPTIONAL ) .
      gw_final-zbatch_status  = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_BSTS' ]-atwrt OPTIONAL ) .
      gw_final-zwash_target  = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_WSTR' ]-atwrt OPTIONAL ) .
      gw_final-zmc_no        = VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_DYMN' ]-atwrt OPTIONAL ) .
      gw_final-znet_width   =   VALUE #( gw_ppbatch_n-char_tab[ atnam = 'B_NEWD' ]-atwrt OPTIONAL ) .
      CLEAR : gw_ppbatch_n .
    ENDIF.
*------------------------------------------->Eoc By Devid-5287

*-------------- Production Order Status -----------------------------*Added By Shashank for Production Order Status
    READ TABLE gt_mseg_po INTO gw_mseg_po WITH KEY werks = gw_matnr-werks matnr = gw_matnr-matnr charg = gw_matnr-charg bwart = '101' BINARY SEARCH.
    IF sy-subrc = 0.
      READ TABLE gt_aufk INTO gw_aufk WITH KEY aufnr = gw_mseg_po-aufnr BINARY SEARCH.
      IF sy-subrc = 0.
        READ TABLE gt_jest WITH KEY objnr = gw_aufk-objnr BINARY SEARCH TRANSPORTING NO FIELDS.
        IF sy-subrc <> 0.
          gw_final-postat = 'Open'.
        ELSE.
          gw_final-postat = 'Close'.
        ENDIF.
      ENDIF.
    ENDIF.
*-------------- Production Order Status -----------------------------*Added By Shashank for Production Order Status

*-------------- Operation and Department ----------------------------: Added By Shashank on 09.01.2020
    READ TABLE gt_conf_hd INTO gw_conf_hd WITH KEY werks = gw_final-werks wipbatch = gw_final-charg BINARY SEARCH.
    IF sy-subrc = 0.
      IF gw_conf_hd-ktsch IS NOT INITIAL.
        gw_final-operation = gw_conf_hd-ktsch.
        READ TABLE gt_t435t INTO gw_t435t WITH KEY spras = sy-langu vlsch = gw_conf_hd-ktsch BINARY SEARCH.
        IF sy-subrc = 0.
          gw_final-departdesc = gw_t435t-txt.
        ENDIF.
      ELSE.
        gw_final-operation = gw_conf_hd-rktsch.
        READ TABLE gt_t435t_r INTO gw_t435t_r WITH KEY spras = sy-langu vlsch = gw_conf_hd-rktsch BINARY SEARCH.
        IF sy-subrc = 0.
          gw_final-departdesc = gw_t435t_r-txt.
        ENDIF.
      ENDIF.
    ENDIF.
*-------------- Operation and Department ----------------------------: Added By Shashank on 09.01.2020
**********code start by Surbhi Dadhich******************
    IF gw_matnr-matkl CP 'CTN*' OR r1 = 'X'. "soc 6216 add by saxi
      CALL FUNCTION 'VB_BATCH_GET_DETAIL'
        EXPORTING
          matnr              = gw_matnr-matnr
          charg              = gw_matnr-charg
          werks              = gw_matnr-werks
          get_classification = 'X'
        TABLES
          char_of_batch      = lt_charr
        EXCEPTIONS
          no_material        = 1
          no_batch           = 2
          no_plant           = 3
          material_not_found = 4
          plant_not_found    = 5
          no_authority       = 6
          batch_not_exist    = 7
          lock_on_batch      = 8
          OTHERS             = 9.
      IF sy-subrc <> 0.
* Implement suitable error handling here
      ENDIF.
    ENDIF."soc 6216 add by saxi
************************soc 6216 add by saxi***********************
    IF r1 = 'X'.
      READ TABLE lt_charr INTO ls_charr WITH KEY atnam = 'K_NS'.
      IF sy-subrc = '0'.
        gw_final-k_ns = ls_charr-atwtb.
      ENDIF.
      CLEAR:ls_charr.
      READ TABLE lt_charr INTO ls_charr WITH KEY atnam = 'K_TS'.
      IF sy-subrc = '0'.
        gw_final-k_ts = ls_charr-atwtb.
      ENDIF.
      CLEAR:ls_charr.
**Soc by Devid - 6712
      READ TABLE lt_charr INTO ls_charr WITH KEY atnam = 'W_KSLN'.
      IF sy-subrc = '0'.
        gw_final-w_ksln = ls_charr-atwtb.
      ENDIF.
      CLEAR:ls_charr.
**Soc by Devid - 6712
    ENDIF.
************************eoc 6216 add by saxi***********************
    IF gw_matnr-matkl CP 'CTN*'. "soc 6216 add by saxi
      DELETE lt_charr WHERE atnam NE 'ZCTN1000'.
      READ TABLE lt_charr INTO ls_charr WITH KEY atnam = 'ZCTN1000'.
      IF sy-subrc = 0.
        lv_string = ls_charr-atwtb.
        SPLIT lv_string AT 'mm2/s' INTO TABLE it_id .
        READ TABLE it_id INDEX 1 INTO wa_id .
        IF sy-subrc = 0.
          lv_id =  wa_id-str.
        ENDIF.
        lv_id1 = lv_id.
        lv_id2 = lv_id1.

        READ TABLE gt_mcha INTO gw_mcha WITH KEY werks = gw_matnr-werks matnr = gw_matnr-matnr charg = gw_matnr-charg  BINARY SEARCH.
        IF sy-subrc EQ 0 .
        ENDIF.
        CONCATENATE sy-datum+6(2) '.' sy-datum+4(2) '.' sy-datum+0(4) ' ' INTO sys_date.
        SELECT zsci_from zsci_to zcotton_cat zfrom_date zto_date FROM zctn_scidtls
        INTO TABLE gt_zctn_scidtls
        WHERE zsci_from LE lv_id2
        AND zsci_to GE lv_id2
        AND zfrom_date LE gw_mcha-ersda "sy-datum
        AND zto_date GE gw_mcha-ersda. "sy-datum.
        IF gt_zctn_scidtls IS NOT INITIAL.
*          LOOP AT gt_zctn_scidtls INTO gs_zctn_scidtls.
*            gw_final-sci_value = lv_id2.
*            gw_final-cotton_cat = gs_zctn_scidtls-zcotton_cat.
*          ENDLOOP.
          gw_final-sci_value = lv_id2.
          gw_final-cotton_cat = VALUE #( gt_zctn_scidtls[ 1 ]-zcotton_cat OPTIONAL ).
        ELSE.
          gw_final-sci_value = lv_id2.
        ENDIF.
      ELSE.
*      GW_FINAL-SCI_VALUE = ' '.
      ENDIF.
    ENDIF.
*********code end by Surbhi Dadhich********************
*********code Added by Soham Upadhyay********************
    IF r1 = 'X' OR r2 = 'X'.
*      SELECT SINGLE aufnr
*                    sernr INTO ( gw_final-aufnr1,
*                                 gw_final-sernr ) FROM resb
*                          WHERE matnr = gw_final-matnr
*                            AND kdauf = gw_final-vbeln
*                            AND kdpos = gw_final-posnr.
      DATA(gs_resb) = VALUE #( gt_resb[ matnr = gw_final-matnr kdauf = gw_final-vbeln kdpos = gw_final-posnr ] OPTIONAL ).
      IF gs_resb-matnr IS NOT INITIAL.
        gw_final-aufnr1 = gs_resb-aufnr.
        gw_final-sernr = gs_resb-sernr.
      ENDIF.
    ENDIF.
*********code end by Soham Upadhyay********************

************** SOC : 4414 **************
    BREAK:v00051.
    READ TABLE gt_zpp_conf_batch INTO gs_zpp_conf_batch WITH KEY charg = gw_matnr-charg  BINARY SEARCH.
    IF sy-subrc = 0.
      gw_final-ztp =  gs_zpp_conf_batch-ztp.
      CLEAR : gs_zpp_conf_batch.
    ENDIF.
************** EOC : 4414 **************

    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT' " added Harshad 03-06-21
      EXPORTING
        input  = gw_final-matnr
      IMPORTING
        output = gw_final-matnr.

*****************************************Soc BY Devid-4728
    IF gw_final-matkl = 'KFF' OR gw_final-matkl = 'KGF' .
      DATA(gw_new_cuobj) = gw_matnr-cuobj .
      AT NEW posnr .
        REFRESH lt_conf .
        CALL FUNCTION 'VELO01_GET_CONFIGURATION'
          EXPORTING
            cuobj_number = gw_new_cuobj
          TABLES
            cuval_et     = lt_conf.
        CLEAR : gw_new_cuobj .
      ENDAT.

      gw_final-k_fs = VALUE #( lt_conf[ atnam = 'K_FS' ]-atwrt OPTIONAL ) .
      gw_final-k_fb = VALUE #( lt_conf[ atnam = 'K_FB' ]-atwrt OPTIONAL ) .
    ENDIF.
*****************************************Eoc BY Devid-4728
    APPEND gw_final TO gt_final .
    CLEAR: gw_final,gw_matnr,lv_id1,lv_id2,gw_t320 .        "gw_ap_awt_kfs ,gw_ap_awt_kfb ."soc 6394 add by saxi
  ENDLOOP.                       " End: Final Loop

  CLEAR : gt_mat_sort[] , gt_ppbatch_n[] . "Soc BY Devid-4728 "Soc By Devid-5287

  PERFORM free_itab."By Pratik
  DELETE ADJACENT DUPLICATES FROM gt_final COMPARING ALL FIELDS .

*------ Unsold Stock: Delete Delivery done data for Unsold Stock --------*
  IF r3 IS NOT INITIAL.
    DELETE gt_final WHERE vbeln_dl IS NOT INITIAL .
  ENDIF.
*------ Sales District: Filter data asper input sales district  --------*
  IF s_bzirk[] IS NOT INITIAL.
    DELETE gt_final WHERE bzirk NOT IN s_bzirk[].
  ENDIF.
  CLEAR: sy-subrc.

*----- START : ADDED BY RIYA ON 20.01.2023 --------
  IF gt_final IS NOT INITIAL.
    SELECT * FROM zbatch_age_knits
      INTO TABLE it_knits
        FOR ALL ENTRIES IN gt_final
          WHERE umcha = gt_final-charg.

    IF it_knits IS NOT INITIAL.
      SELECT charg ersda FROM mcha
        INTO TABLE it_mchar
          FOR ALL ENTRIES IN it_knits
            WHERE charg = it_knits-charg.
    ENDIF.

    LOOP AT gt_final INTO DATA(war).
      IF war-charg IS NOT INITIAL AND war-werks = '1024'.
        READ TABLE it_knits INTO wa_knits WITH KEY umcha = war-charg.
        IF wa_knits IS NOT INITIAL.
          READ TABLE it_mchar INTO wa_mchar WITH KEY charg = wa_knits-charg.
          IF wa_mchar IS NOT INITIAL.
            CLEAR : war-age_batch,war-fvdt1.
            war-fvdt1 = wa_mchar-ersda.
            IF war-fvdt1 IS NOT INITIAL.
              lv_date = war-fvdt1 .
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              war-age_batch  = lv_char .
              CLEAR:lv_date,lv_char .
            ENDIF.
            MODIFY gt_final FROM war.
            CLEAR : war.
          ENDIF.
          CLEAR : wa_mchar.
        ENDIF.
        CLEAR : wa_knits.
      ENDIF.
      CLEAR : war.
    ENDLOOP.

  ENDIF.
*----- END : ADDED BY RIYA ON 20.01.2023 --------

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CALCULATE_DATE_RANGE
*&---------------------------------------------------------------------*
*    Calculate Date Range Between two Date                             *
*----------------------------------------------------------------------*
FORM calculate_date_range  USING    p_date TYPE sy-datum
                           CHANGING p_char TYPE char20.
  DATA: p_ttdate TYPE i .
  CLEAR: p_char,p_ttdate .

  p_ttdate = sy-datum - p_date + 1 .

  IF p_ttdate IS NOT INITIAL.

    IF p_ttdate     BETWEEN 0 AND 30.
      p_char = '0-30'.
    ELSEIF p_ttdate BETWEEN 31 AND 60.
      p_char = '31-60'.
    ELSEIF p_ttdate BETWEEN 61 AND 90.
      p_char = '61-90'.
    ELSEIF p_ttdate BETWEEN 91 AND 120.
      p_char = '91-120'.
    ELSEIF p_ttdate BETWEEN 121 AND 180.
      p_char = '121-180'.
    ELSEIF p_ttdate BETWEEN 181 AND 365.
      p_char = '181-365'.
    ELSEIF p_ttdate GT 365.
      p_char = 'More then 365'.
    ENDIF.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_DATA_PART1
*&---------------------------------------------------------------------*
*------------------------------------------------------------------------------------------------------------*
*   Part 1: Start                                                                                            *
*------------------------------------------------------------------------------------------------------------*
FORM insert_data_part1 .
*  CLEAR:lw_mcha.

*  IF GT_ZPP_PCKHDR IS INITIAL. " Added by Rohit on 27.04.2020 "Commented By Hardik Bhatt on 30.03.2021

  IF gw_matnr-charg IS NOT INITIAL AND gt_mcha IS NOT INITIAL.
*------------------------------------------>Soc By Devid-001
    DATA(gw_zmm_amd_plantage_werks) = VALUE #( gt_zmm_amd_plantage[ new_plant = gw_matnr-werks ]-old_plant OPTIONAL ) .
    IF gw_zmm_amd_plantage_werks IS NOT INITIAL.
      CLEAR:gw_mcha.
      READ TABLE gt_mcha INTO gw_mcha WITH KEY werks = gw_zmm_amd_plantage_werks
                                               matnr = gw_matnr-matnr
                                               charg = gw_matnr-charg  BINARY SEARCH.

      IF sy-subrc EQ 0 .
        IF gw_mcha-fvdt1 IS NOT INITIAL.
          gw_final-fvdt1 = gw_mcha-fvdt1 .
        ELSE.
          gw_final-fvdt1 = gw_mcha-ersda.         " Batch Creation Date
        ENDIF.

        IF gw_final-fvdt1 IS NOT INITIAL.
          DATA(lw_flg_bcd) = 'X'.
        ENDIF.
      ENDIF.
    ENDIF.
    CLEAR : gw_zmm_amd_plantage_werks.
*------------------------------------------>Eoc By Devid-001
*    IF gt_mcha IS NOT INITIAL.
    CLEAR:gw_mcha.
    READ TABLE gt_mcha INTO gw_mcha WITH KEY werks = gw_matnr-werks matnr = gw_matnr-matnr charg = gw_matnr-charg BINARY SEARCH.
    IF sy-subrc EQ 0 .    " Batch Creation Date
      gw_final-bwtar         = gw_mcha-bwtar .          " Valuation type
      gw_final-weaving_plant = gw_mcha-name1 .          " Weavingc plant

      IF lw_flg_bcd IS INITIAL.  "Added By Devid-001
        IF gw_mcha-fvdt1 IS NOT INITIAL.
          gw_final-fvdt1 = gw_mcha-fvdt1 .
        ELSE.
          gw_final-fvdt1 = gw_mcha-ersda.         " Batch Creation Date
        ENDIF.
      ENDIF.
    ENDIF.
    CLEAR : lw_flg_bcd.
  ENDIF.
*  ELSE.

  IF gw_final-fvdt1 IS INITIAL.
    READ TABLE gt_zpp_pckhdr INTO gw_zpp_pckhdr WITH KEY werks = gw_matnr-werks matnr = gw_matnr-matnr zbale_no = gw_matnr-charg BINARY SEARCH.
    IF sy-subrc EQ 0.
      gw_final-fvdt1 = gw_zpp_pckhdr-budat.
    ENDIF.
  ENDIF.
*  ENDIF. " Ended by Rohit on 28.04.2020   "Commented By Hardik Bhatt on 30.03.2021

  gw_final-werks = gw_matnr-werks .
  gw_final-lgort = gw_matnr-lgort .

  IF gw_matnr-lgort IS NOT INITIAL.
    READ TABLE gt_lgobe INTO gw_lgobe WITH KEY werks = gw_matnr-werks lgort = gw_matnr-lgort BINARY SEARCH .
    IF sy-subrc EQ 0.
      gw_final-lgobe = gw_lgobe-lgobe .
    ENDIF.
  ENDIF.

  gw_final-matkl = gw_matnr-matkl .
  IF gw_matnr-matkl IS NOT INITIAL.
    READ TABLE gt_wgbez INTO gw_wgbez WITH KEY matkl = gw_matnr-matkl BINARY SEARCH.
    IF sy-subrc EQ 0.
      gw_final-wgbez = gw_wgbez-wgbez .
    ENDIF.
  ENDIF.
*-------------------------------------------------------------------
*  All Material Basic data inset to final table
*-------------------------------------------------------------------
  gw_final-matnr = gw_matnr-matnr .
  IF gw_matnr-matnr IS NOT INITIAL.

    READ TABLE gt_mara_basic INTO gw_mara_basic WITH KEY matnr = gw_matnr-matnr BINARY SEARCH.
    IF sy-subrc EQ 0.
      gw_final-meins = gw_mara_basic-meins.
      gw_final-maktx = gw_mara_basic-maktx.
      gw_final-old_mtrl_no = gw_mara_basic-bismt.  " Add on 02-01-2019 by surajit rqst by Bharat bhai
    ENDIF.
  ENDIF.
*------------------------------------------------------------------------------------------------------------*
*   Get Batch Quantity                                                                                       *
*------------------------------------------------------------------------------------------------------------*

  gw_final-menge = gw_matnr-qnty .
  IF gw_matnr-charg IS NOT INITIAL.
    gw_final-charg = gw_matnr-charg .
  ENDIF.

***  GW_FINAL-LGNUM = GW_MATNR-LGNUM ."soc 6394 cmt by saxi**************************
  IF gw_matnr-lgnum IS NOT INITIAL .
    READ TABLE gt_lnumt INTO gw_lnumt WITH KEY lgnum = gw_matnr-lgnum BINARY SEARCH.
    IF sy-subrc EQ 0.
      gw_final-lnumt = gw_lnumt-lnumt .
    ENDIF.
  ENDIF.

  gw_final-lgtyp = gw_matnr-lgtyp.
  gw_final-lgpla = gw_matnr-lgpla.

*----------------------------------------------------------------------*
  "dd07t-DDTEXT----> dd07t-DOMNAME = 'BESTQ' ,DDLANGUAGE = 'E' AS4LOCAL  = 'A' DOMVALUE_L = pass field value"
*----------------------------------------------------------------------*
*  IF gw_matnr-bestq IS NOT INITIAL.
  READ TABLE gt_bestq INTO gw_bestq WITH KEY domvalue_l = gw_matnr-bestq BINARY SEARCH.
  IF sy-subrc EQ 0.
    gw_final-st_text = gw_bestq-ddtext .
  ENDIF.
  gw_final-sobkz = gw_matnr-sobkz .
*-----------------------------END:Part:1-----------------------------------------------------------------*

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_DATA_PART2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM insert_data_part2 .
*-----------------------------Part:2---------------------------------------------------------------------*
  DATA lv_gdsmov TYPE vbuk-wbstk.
  CLEAR:gw_vbap,lv_gdsmov.
  IF gw_matnr-vbeln IS NOT INITIAL AND gw_matnr-posnr IS NOT INITIAL.
*    SORT gt_vbap BY vbeln posnr .

    READ TABLE gt_vbap INTO gw_vbap WITH KEY vbeln = gw_matnr-vbeln posnr = gw_matnr-posnr BINARY SEARCH.
*    CHECK sy-subrc EQ 0 .
* -----------------------------------------------------------------------*
*                                      *
* -----------------------------------------------------------------------*

    gw_final-auart        = gw_vbap-auart.
    gw_final-vbeln        = gw_vbap-vbeln.
    gw_final-posnr        = gw_vbap-posnr.
    gw_final-kwmeng       = gw_vbap-kwmeng.
*    gw_final-vrkme        = gw_vbap-vrkme.
    gw_final-zz_sortorder = gw_vbap-zz_sortorder.
    gw_final-zzassortdt   = gw_vbap-zzassortdt.
    gw_final-vkbur_text   = gw_vbap-sf_text.
    gw_final-vkgrp_text   = gw_vbap-sg_text.
    gw_final-kdmat        = gw_vbap-kdmat.
*    gw_final-zzkvgr1      = gw_vbap-zzkvgr1.
    gw_final-zztradenm    = gw_vbap-zztradenm.
    gw_final-zzppcmtdt    = gw_vbap-zzppcmtdt.
    gw_final-dev_no       = gw_vbap-dev_no.                       " Add on 05-04-2019
    gw_final-dev_line     = gw_vbap-dev_line.                     " Add on 05-04-2019
    gw_final-mou_order    = gw_vbap-mou_order.                    " Add on 05-04-2019
    gw_final-zzcusreqd    = gw_vbap-zzcusreqd.                    " Add on 13-05-2019


    PERFORM concatenate_brand_desc USING gw_vbap-zzkvgr1 gw_vbap-brnd_text CHANGING gv_concat .
    gw_final-zzkvgr1_text = gv_concat .                                   " Dispatch SO/Line

    PERFORM conversion_unit_sales USING gw_vbap-vrkme CHANGING gw_final-vrkme  .

* -----------------------------------------------------------------------*
* Ship TO Party and Sold to Party                                        *
* -----------------------------------------------------------------------*

    READ TABLE gt_vbpa INTO gw_vbpa WITH KEY vbeln = gw_matnr-vbeln parvw = 'AG' BINARY SEARCH.
    IF sy-subrc EQ 0.
      gw_final-kunnr_sp = gw_vbpa-name1 .
    ENDIF.

    READ TABLE gt_vbpa INTO gw_vbpa WITH KEY vbeln = gw_matnr-vbeln parvw = 'WE' BINARY SEARCH.
    IF sy-subrc EQ 0.
      gw_final-kunnr_sh = gw_vbpa-name1 .
    ENDIF.

    READ TABLE gt_vbpa INTO gw_vbpa WITH KEY vbeln = gw_matnr-vbeln parvw = 'RE' BINARY SEARCH.
    IF sy-subrc EQ 0.
      gw_final-kunnr_bill      = gw_vbpa-kunnr.
      gw_final-kunnr_bill_name = gw_vbpa-name1 .
    ENDIF.
* -----------------------------------------------------------------------*
* Sales Priceing Condition                                               *
* -----------------------------------------------------------------------*
    IF gw_vbap-knumv IS NOT INITIAL .
      CLEAR: gw_konv.
      READ TABLE gt_konv INTO gw_konv WITH KEY knumv = gw_vbap-knumv kposn = gw_vbap-posnr BINARY SEARCH .
      IF sy-subrc EQ 0.
        gw_final-so_price = gw_konv-kbetr .
        gw_final-so_valu = gw_final-menge * gw_final-so_price .
      ENDIF.
    ENDIF.
    CLEAR:gw_vbpa.
* -----------------------------------------------------------------------*
* Sales District Description and Sales District Code                     *
* -----------------------------------------------------------------------*

    READ TABLE gt_vbkd INTO gw_vbkd WITH KEY vbeln = gw_matnr-vbeln posnr = gw_matnr-posnr  BINARY SEARCH.
    IF sy-subrc NE 0 .
      READ TABLE gt_vbkd INTO gw_vbkd WITH KEY vbeln = gw_matnr-vbeln posnr = '' BINARY SEARCH.
    ENDIF.
    IF sy-subrc EQ 0 AND gw_vbkd-bzirk IS NOT INITIAL.
      gw_final-bzirk = gw_vbkd-bzirk.
      gw_final-bztxt = gw_vbkd-bztxt.
    ENDIF.
    IF gw_final-bzirk IS NOT INITIAL.

*      SELECT SINGLE final_seg mkt_seg FROM zsd_segment INTO ( gw_final-final_seg, gw_final-mkt_seg )
*                                                       WHERE code = gw_final-bzirk. " Added by Rohit on 10.02.2020 MKT Added on 26.03.2020
      gs_zsd_segment = VALUE #( gt_zsd_segment[ code = gw_final-bzirk ] OPTIONAL ).
      IF gs_zsd_segment-code IS NOT INITIAL.
        gw_final-final_seg = gs_zsd_segment-final_seg.
        gw_final-mkt_seg = gs_zsd_segment-mkt_seg.
      ENDIF.
      CLEAR : gs_zsd_segment.
    ENDIF.
* -----------------------------------------------------------------------*
* Sales DELIVERY  Details                                                *
* -----------------------------------------------------------------------*
    IF gw_matnr-vbeln IS NOT INITIAL AND gw_matnr-posnr IS NOT INITIAL .
      CLEAR:gw_lips.

      READ TABLE gt_lips INTO gw_lips WITH KEY vgbel = gw_matnr-vbeln vgpos = gw_matnr-posnr charg = gw_matnr-charg BINARY SEARCH.
      IF sy-subrc NE 0.
        READ TABLE gt_lips_v INTO gw_lips WITH KEY vgbel = gw_matnr-vbeln vgpos = gw_matnr-posnr charg = gw_matnr-charg BINARY SEARCH.
      ENDIF.
      IF sy-subrc EQ 0 AND gw_lips IS NOT INITIAL.
*        SELECT SINGLE wbstk FROM vbuk INTO lv_gdsmov WHERE vbeln = gw_lips-vbeln. "Logic added by Shashank on 14th July 2020
        lv_gdsmov = VALUE #( gt_vbuk[ vbeln = gw_lips-vbeln ]-wbstk OPTIONAL ).
        IF lv_gdsmov = 'C'.
          gw_final-vbeln_dl = space.
          gw_final-erdat    = space.
          gw_final-lfimg    = 0.
          gw_final-open_qty = 0.
        ELSE.
          gw_final-vbeln_dl = gw_lips-vbeln.
          gw_final-erdat    = gw_lips-erdat .
          gw_final-lfimg    = gw_lips-lfimg .
          gw_final-open_qty = gw_final-menge - gw_final-lfimg .
        ENDIF.

      ENDIF.
      CLEAR:gw_lips.
    ENDIF.
* -----------------------------------------------------------------------*
* For block Quantity                                                     *
* -----------------------------------------------------------------------*
    IF gw_matnr-bestq EQ 'S' AND gw_matnr-charg IS NOT INITIAL.
      SORT gt_request BY zbale_no .

      READ TABLE gt_request INTO gw_request WITH KEY zbale_no = gw_matnr-charg BINARY SEARCH .
      IF sy-subrc EQ 0.
        gw_final-zreq_no = gw_request-zreq_no.
        gw_final-zstat  = gw_request-zstat .
      ENDIF.
    ENDIF.
* -----------------------------------------------------------------------*
* SALES ORDER STATUS                                                     *
* -----------------------------------------------------------------------*
    DATA: lv_string TYPE char30,
          lv_inact  TYPE jest-inact.

    CONCATENATE 'VB' gw_matnr-vbeln gw_matnr-posnr INTO lv_string .
    CONDENSE lv_string .
    gw_final-so_status = COND #( WHEN VALUE #( gt_jeststatus[ objnr = lv_string ]-inact OPTIONAL ) IS INITIAL
                              THEN 'Approved' ELSE 'Pending' ).
*    SELECT SINGLE inact FROM jest INTO lv_inact WHERE objnr EQ lv_string AND stat EQ 'E0007' .
*    IF  lv_inact EQ ''.
*      gw_final-so_status = 'Approved'.
*    ELSE.
*      gw_final-so_status = 'Pending'.
*    ENDIF.
*    CLEAR:lv_string,lv_inact .
* -----------------------------------------------------------------------*
* Ageing from delivery date and assortment date,Ageing for PPC date,
* Customar requirment date                                               *
* -----------------------------------------------------------------------*
    DATA: lv_date TYPE sy-datum,
          lv_char TYPE char20.
    CLEAR: lv_date,lv_char.

    IF gw_final-erdat IS NOT INITIAL .
      lv_date = gw_final-erdat .
      PERFORM calculate_date_range USING lv_date CHANGING lv_char .
      gw_final-age_del  = lv_char .
      CLEAR:lv_date,lv_char .
    ENDIF.

    IF gw_final-zzassortdt IS NOT INITIAL .
      lv_date = gw_final-zzassortdt .
      PERFORM calculate_date_range USING lv_date CHANGING lv_char .
      gw_final-age_asort = lv_char .
      CLEAR:lv_date,lv_char .
    ENDIF.

    IF gw_final-zzppcmtdt IS NOT INITIAL .
      lv_date = gw_final-zzppcmtdt .
      PERFORM calculate_date_range USING lv_date CHANGING lv_char .
      gw_final-age_ppcdt = lv_char .
      CLEAR:lv_date,lv_char .
    ENDIF.

    IF gw_final-zzcusreqd IS NOT INITIAL .
      lv_date = gw_final-zzcusreqd .
      PERFORM calculate_date_range USING lv_date CHANGING lv_char .
      gw_final-age_crdt = lv_char .
      CLEAR:lv_date,lv_char .
    ENDIF.
  ENDIF.
* -----------------------------------------------------------------------*
*   STOCK PRICE & Stock Value                             *
* -----------------------------------------------------------------------*

  TRY .                                     " Handel Exception
      IF gw_matnr-sobkz EQ 'E'.

*    SORT gt_ebew BY vbeln posnr bwkey matnr charg .
        READ TABLE gt_ebew INTO gw_ebew WITH KEY vbeln = gw_matnr-vbeln posnr = gw_matnr-posnr bwkey = gw_matnr-werks matnr = gw_matnr-matnr
                                                 charg = gw_matnr-charg BINARY SEARCH .
        IF sy-subrc EQ 0.
          CASE gw_ebew-vprsv.
            WHEN 'S'.
              gw_final-stk_price = gw_ebew-stprs.
            WHEN 'V'.
              gw_final-stk_price = gw_ebew-verpr.
          ENDCASE.
        ENDIF.
      ELSE.
        IF gw_matnr-charg IS NOT INITIAL.
          READ TABLE gt_mbew_charg INTO gw_mbew_charg WITH KEY bwkey = gw_matnr-werks matnr = gw_matnr-matnr charg = gw_matnr-charg BINARY SEARCH .
          IF sy-subrc EQ 0.
            MOVE-CORRESPONDING gw_mbew_charg TO gw_mbew .
          ENDIF.
        ELSE.
          READ TABLE gt_mbew INTO gw_mbew WITH KEY bwkey = gw_matnr-werks matnr = gw_matnr-matnr BINARY SEARCH .
        ENDIF.
        IF sy-subrc EQ 0.
          IF gw_mbew-peinh IS NOT INITIAL.
            CASE gw_mbew-vprsv.
              WHEN 'S'.
                gw_final-stk_price = gw_mbew-stprs / gw_mbew-peinh.
              WHEN 'V'.
                gw_final-stk_price = gw_mbew-verpr / gw_mbew-peinh.
            ENDCASE.
          ELSE.
            CASE gw_mbew-vprsv.
              WHEN 'S'.
                gw_final-stk_price = gw_mbew-stprs .
              WHEN 'V'.
                gw_final-stk_price = gw_mbew-verpr.
            ENDCASE.
          ENDIF.   " IF gw_mbew-peinh IS NOT INITIAL.
        ENDIF.    " gw_mbew is not initial
      ENDIF.     " IF gw_matnr-sobkz EQ 'E'.
      gw_final-stk_value = gw_final-stk_price * gw_final-menge.            " STOCK VALUE
    CATCH cx_root.
  ENDTRY.
* -----------------------------------------------------------------------*
*   BATCH CREATION AGEING and WM AGEING Date                             *
* -----------------------------------------------------------------------*

  IF gw_final-fvdt1 IS NOT INITIAL .
    lv_date = gw_final-fvdt1 .
    PERFORM calculate_date_range USING lv_date CHANGING lv_char .
    gw_final-age_batch  = lv_char .
    CLEAR:lv_date,lv_char .
  ENDIF.
  IF gw_final-fvdt2 IS NOT INITIAL AND gw_final-lgnum IS NOT INITIAL.
    lv_date = gw_final-fvdt2 .
    PERFORM calculate_date_range USING lv_date CHANGING lv_char .
    gw_final-age_wm  = lv_char .
    CLEAR:lv_date,lv_char .
  ENDIF.

* -----------------------------------------------------------------------*
*  Add on 12-12-2018: by sirajit rqust by Pinky Mam & Sanjoy
*         Sales order Garige Plan qty & Issue Qty & last Issue Date      *
* -----------------------------------------------------------------------*
  IF gw_matnr-werks EQ '1012'.
    "~~~~~~~~ Sales order Garige Plan qty~~~~~~~~~*
    PERFORM so_gry_plan_qty USING gw_vbap .

    "~~~~~~~~ Sales order Garige Issue qty~~~~~~~~*
    IF gw_matnr-matkl IN rt_issue_matkl.
      CLEAR:gw_pp261.
      READ TABLE gt_pp261 INTO gw_pp261 WITH KEY werks     = gw_matnr-werks mat_kdauf = gw_matnr-vbeln mat_kdpos = gw_matnr-posnr BINARY SEARCH .
      IF sy-subrc EQ 0 AND gw_pp261 IS NOT INITIAL.
        gw_final-grig_issu_qty = gw_pp261-menge .
        gw_final-last_issue_dt = gw_pp261-budat .
      ENDIF.
      CLEAR:gw_tt_btch_stck.
      READ TABLE gt_tt_btch_stck INTO gw_tt_btch_stck WITH KEY werks = gw_matnr-werks vbeln = gw_matnr-vbeln posnr = gw_matnr-posnr BINARY SEARCH .
      IF sy-subrc EQ 0.
        gw_final-tt_so_stock = gw_tt_btch_stck-menge .
      ENDIF.
    ENDIF.
  ENDIF.
* -----------------------------------------------------------------------*
  CLEAR:gw_vbap,sy-subrc,gw_ebew.
*-----------------------------END:Part:2-----------------------------------------------------------------*
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_DATA_PART3
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM insert_data_part3 .
*  break 121177.
  CLEAR: l_flag, gw_mseg,lv_date,lv_char ,gt_outtab.
*-----------------------------Part:3----------------------------------------------------------------------*
  CHECK gw_matnr-matnr IS NOT INITIAL.
***  IF gw_matnr-matnr IS NOT INITIAL.

  IF gw_matnr-charg IS NOT INITIAL.
    PERFORM get_transaction_date CHANGING gw_mseg .
  ELSEIF gw_matnr-charg IS INITIAL.
    l_flag = 'X' .
    READ TABLE gt_mseg_blnk INTO gw_mseg WITH KEY werks = gw_matnr-werks matnr = gw_matnr-matnr lgort = gw_matnr-lgort BINARY SEARCH .
    IF sy-subrc EQ 0 AND gw_mseg-budat IS NOT INITIAL.
      gw_final-fvdt2 = gw_mseg-budat .                  " Latest Transection Date
      lv_date        = gw_final-fvdt2 .
      PERFORM calculate_date_range USING lv_date CHANGING lv_char .
      gw_final-age_batch  = lv_char .                        " Aging Date from Today - Latest Transection Date
      CLEAR:lv_date,lv_char,l_flag  .
    ENDIF.
  ENDIF."  IF gw_matnr-charg IS NOT INITIAL.

* -----------------------------------------------------------------------*
*  Get MSEG Data as per logic                                            *
* -----------------------------------------------------------------------*
  IF l_flag IS INITIAL .
    gw_final-fvdt2 = gw_mseg-cpudt.
    gw_final-cputm = gw_mseg-cputm.
    gw_final-mblnr = gw_mseg-mblnr.
    gw_final-zeile = gw_mseg-zeile.
    gw_final-unloading = gw_mseg-ablad.             "Added by Shashank on 06th Feb 2020
    gw_final-bwart = gw_mseg-bwart.
    gw_final-aufnr = gw_mseg-aufnr.                 "Chnage logic on 11-12-2018 get data from batch
    gw_final-kdauf = gw_mseg-kdauf.
    gw_final-steuc = gw_mseg-steuc .   " Material HSN CODE
*------------------- PO / Line------------------------------------------*
    IF gw_mseg-ebeln IS NOT INITIAL AND gw_mseg-ebelp IS NOT INITIAL.
      CLEAR: gv_order,gv_line,gv_concat .
      gv_order = gw_mseg-ebeln .
      gv_line  = gw_mseg-ebelp .
      PERFORM concatenate_order_line USING gv_order gv_line
                                     CHANGING gv_concat .
      gw_final-ebeln = gv_concat .                                   " PO /Line

*----------------- PO / Line Status------------------------------------"Added By Shashank for Purchase Order Status"
      READ TABLE gt_ekpo_st INTO gw_ekpo_st WITH KEY ebeln = gw_mseg-ebeln ebelp = gw_mseg-ebelp BINARY SEARCH.
      IF sy-subrc = 0.
        gw_final-pursts = 'Open'.
      ELSE.
        gw_final-pursts = 'Close'.
      ENDIF.
*------------------- PR / Line------------------------------------------*
*      IF gw_mseg-ebeln IS NOT INITIAL AND gw_mseg-ebelp IS NOT INITIAL.
      CLEAR: gw_ekpo,gv_order,gv_line,gv_concat,gt_outtab.
      READ TABLE gt_ekpo INTO gw_ekpo WITH KEY ebeln = gw_mseg-ebeln ebelp = gw_mseg-ebelp BINARY SEARCH .
      IF sy-subrc EQ 0.
        "~~~~~~~~Add on 22-1-2019 by surajit~~~~~~~~~~~~~~~~~" Start
        "  In normal Venddor name in STO Plant Name          "
        "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
        gw_final-supply_name = gw_ekpo-name1.
        IF gw_final-supply_name IS INITIAL.
          gw_final-supply_name = gw_ekpo-sto_name1.
        ENDIF.
        "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~" End
        gv_order             = gw_ekpo-banfn .
        gv_line              = gw_ekpo-bnfpo .
        PERFORM concatenate_order_line USING gv_order gv_line CHANGING gv_concat .
        gw_final-banfn = gv_concat .                                   " PO /Line
        IF gw_ekpo-banfn IS NOT INITIAL AND gw_ekpo-bnfpo IS NOT INITIAL.
          READ TABLE gt_eban INTO gw_eban WITH KEY banfn = gw_ekpo-banfn bnfpo = gw_ekpo-bnfpo BINARY SEARCH.
          IF sy-subrc = 0.   " Added by Hiren bhoi and Sanskriti
            IF s_werks-low = '1062' OR s_werks-low = '2426'.   " Dev id - 0001 Added By Rahul Koshti plant- 2426
              gw_final-bednr = gw_eban-bednr.
            ENDIF.
          ENDIF.

          PERFORM user_name USING gw_eban-ernam CHANGING gw_final-pr_creator.


          "Added by Shashank on 20th Nov 2020 for PR L1 Approval
          CALL FUNCTION 'ME_CHANGEDOC_SELECT'
            EXPORTING
              i_document_category = 'B'
              i_document_number   = gw_ekpo-banfn
              i_document_item     = gw_ekpo-bnfpo
              i_all_items         = 'X'
            IMPORTING
              e_outtab            = gt_outtab.
          DELETE gt_outtab WHERE fname NE 'FRGZU' AND f_old EQ 'X'.
          SORT gt_outtab BY udate DESCENDING utime DESCENDING.
          READ TABLE gt_outtab INTO DATA(gs_outtab) WITH KEY fname = 'FRGKZ' f_old = space ebeln = gw_ekpo-banfn ebelp = gw_ekpo-bnfpo.
          IF sy-subrc = 0.
            PERFORM user_name USING gs_outtab-username CHANGING gw_final-pr_l1approve.
          ELSE.
            READ TABLE gt_outtab INTO gs_outtab WITH KEY ebeln = gw_ekpo-banfn ebelp = gw_ekpo-bnfpo.
            IF sy-subrc = 0.
              PERFORM user_name USING gs_outtab-username CHANGING gw_final-pr_l1approve.
            ENDIF.
          ENDIF.
*          SORT GT_OUTTAB BY FNAME.
*          DELETE GT_OUTTAB WHERE FNAME NE 'FRGKZ'.
*          READ TABLE GT_OUTTAB INTO DATA(GS_OUTTAB) WITH KEY FNAME = 'FRGKZ' F_OLD = SPACE EBELN = GW_EKPO-BANFN EBELP = GW_EKPO-BNFPO.
*          IF SY-SUBRC = 0.
*            PERFORM USER_NAME USING GS_OUTTAB-USERNAME CHANGING GW_FINAL-PR_L1APPROVE.
*          ENDIF.
          "Added by Shashank on 20th Nov 2020 for PR L1 Approval
          REFRESH gt_outtab.
        ENDIF.
*------------------- PO Type -------------------------------------------*
        IF gw_ekpo-pstyp IS NOT INITIAL.
          READ TABLE gt_pstyp INTO gw_pstyp WITH KEY pstyp = gw_ekpo-pstyp BINARY SEARCH.
          gw_final-pstyp_text = gw_pstyp-ptext .
        ENDIF.
      ENDIF.
    ENDIF.
* -----------------------------------------------------------------------*
* Purchase Order Stander Text                                            *
* -----------------------------------------------------------------------*

    REFRESH:lv_tline.
    CLEAR: lv_tline,lv_poline .

    IF gw_mseg-ebeln IS NOT INITIAL AND gw_mseg-ebelp IS NOT INITIAL.

      CONCATENATE gw_mseg-ebeln gw_mseg-ebelp INTO lv_poline .
      CONDENSE lv_poline  .

      CALL FUNCTION 'READ_TEXT'
        EXPORTING
*         CLIENT                  = SY-MANDT
          id                      = 'F01'
          language                = 'E'
          name                    = lv_poline
          object                  = 'EKPO'
        TABLES
          lines                   = lv_tline
        EXCEPTIONS
          id                      = 1
          language                = 2
          name                    = 3
          not_found               = 4
          object                  = 5
          reference_check         = 6
          wrong_access_to_archive = 7
          OTHERS                  = 8.

      LOOP AT lv_tline.
        IF gw_final-po_text IS NOT INITIAL.
          CONCATENATE gw_final-po_text lv_tline-tdline INTO lv_tline-tdline .
        ELSE.
          gw_final-po_text = lv_tline-tdline .
        ENDIF.
      ENDLOOP.
      CLEAR:lv_tline,lv_tline[].
    ENDIF.

* -----------------------------------------------------------------------*
* Get Data From ZMM_MIGO_HDR,ZMM_WEIGHINHDR base on MABLNR               *
* -----------------------------------------------------------------------*
    gw_final-zinvoino     = gw_mseg-zinvoino.
    gw_final-zinvoidt     = gw_mseg-zinvoidt.
    gw_final-zgateentryno = gw_mseg-zgateentryno.
    gw_final-zentrydate   = gw_mseg-zentrydate.
* -----------------------------------------------------------------------*
*                                      *
* -----------------------------------------------------------------------*
    IF gw_mseg-matnr IS NOT INITIAL AND gw_mseg-mjahr IS NOT INITIAL AND gw_mseg-zeile IS NOT INITIAL.
*        SORT gt_qals BY mjahr mblnr matnr zeile .
      READ TABLE gt_qals INTO gw_qals WITH KEY mjahr = gw_mseg-mjahr
                                               mblnr = gw_mseg-mblnr
                                               zeile = gw_mseg-zeile
                                               matnr = gw_mseg-matnr BINARY SEARCH .."BINARY SEARCH .
      IF sy-subrc EQ 0.
        gw_final-prueflos = gw_qals-prueflos .
      ENDIF.
    ENDIF.
* -----------------------------------------------------------------------*
*                                      *
* -----------------------------------------------------------------------*
    IF gw_matnr-charg IS NOT INITIAL.
*        SORT gt_mch1 BY matnr charg  .
      READ TABLE gt_mch1 INTO gw_mch1 WITH KEY matnr = gw_matnr-matnr
                                               charg = gw_matnr-charg  BINARY SEARCH .
      IF sy-subrc EQ 0.
        gw_final-self_life = gw_mch1-vfdat .
        gw_final-hsdat     = gw_mch1-hsdat.
      ENDIF.
    ELSE.
      gw_final-self_life = gw_mseg-vfdat.
    ENDIF.

    "Begin of Insert by Sushen on 25.12.2024++,Dev id:6066,Reqby Parth
    READ TABLE gt_mcha INTO gw_mcha WITH KEY werks = gw_matnr-werks
                                             matnr = gw_matnr-matnr
                                             charg = gw_matnr-charg  BINARY SEARCH.
    IF sy-subrc EQ 0 .
      gw_final-self_life = gw_mcha-vfdat .
      gw_final-hsdat     = gw_mcha-hsdat.
      gw_final-mfaging   = sy-datum - gw_mcha-hsdat.
    ENDIF.
    "End of Insert by Sushen on 25.12.2024++,Dev id:6066,Reqby Parth
* -----------------------------------------------------------------------*
* Get Greige Issue Qty and Total So line                                     *
* -----------------------------------------------------------------------*
    IF gw_matnr-vbeln IS NOT INITIAL.

*      gw_final-so_line = VALUE #( gt_vbap_line[ vbeln = gw_matnr-vbeln ]-cnt OPTIONAL ).
      READ TABLE gt_vbap_line INTO gs_vbap_line WITH KEY vbeln = gw_matnr-vbeln.
      IF sy-subrc = 0.
        gw_final-so_line = gs_vbap_line-cnt.
      ELSE.

        SELECT COUNT( * ) FROM vbap INTO gw_final-so_line WHERE vbeln EQ gw_matnr-vbeln  .

        gs_vbap_line-vbeln =   gw_matnr-vbeln.
        gs_vbap_line-cnt =   gw_final-so_line.
        APPEND gs_vbap_line TO gt_vbap_line.
        CLEAR : gs_vbap_line.
      ENDIF.
      CLEAR : gs_vbap_line.
*      gw_final-so_line = REDUCE #( INIT i = 0 FOR gs_vbap IN gt_vbap WHERE ( vbeln = gw_matnr-vbeln ) NEXT i = i + 1 ).
    ENDIF.

  ENDIF. " IF l_flag IS INITIAL .

*-----------------------------------------------------------------------*
* Non Batch Mannage Material & 'OTHER' Batch Material Agging            *
*-----------------------------------------------------------------------*
  READ TABLE gt_marc INTO gw_marc WITH KEY werks = gw_matnr-werks
                                           matnr = gw_matnr-matnr BINARY SEARCH .
  IF sy-subrc EQ 0.
    CLEAR:lv_date .

    PERFORM non_batch_agging USING gw_matnr
                                   ' '                 " Non Batch Asign Material
                             CHANGING lv_date .
    IF lv_date IS NOT INITIAL.
      PERFORM calculate_date_range USING lv_date CHANGING lv_char .
      gw_final-age_batch  = lv_char .      " Aging Date from Today - Latest Transection Date
*        gw_final-FVDT1      = lv_date .      " Non batch Stock date
    ENDIF.
  ELSEIF gw_matnr-charg CS 'OTHER'.      " If 'Other' Name Batch Maintain
    CLEAR:lv_date,gw_final-age_batch .

    PERFORM non_batch_agging USING gw_matnr
                                   'X'                      " Batch Assign Material
                             CHANGING lv_date .
    IF lv_date IS NOT INITIAL.
      PERFORM calculate_date_range USING lv_date CHANGING lv_char .
      gw_final-age_batch  = lv_char .         " Aging Date from Today - Latest Transection Date
*        gw_final-FVDT1      = lv_date .      " Non batch Stock date
    ENDIF.

  ENDIF."READ TABLE gt_marc INTO gw_marc

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_DATA_PART4
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM insert_data_part4 .
* -----------------------------------------------------------------------*
*  Read Characteristic Value                                             *
* -----------------------------------------------------------------------*
*  SORT : gt_mm_stck_rpt BY matkl klart.
  READ TABLE gt_mm_stck_rpt WITH KEY matkl = gw_matnr-matkl BINARY SEARCH TRANSPORTING NO FIELDS.
  IF sy-subrc = 0.
    DATA(lv_tabix) = sy-tabix.

*  LOOP AT gt_mm_stck_rpt INTO gw_mm_stck_rpt WHERE matkl EQ gw_matnr-matkl.
    LOOP AT gt_mm_stck_rpt INTO gw_mm_stck_rpt FROM lv_tabix. "WHERE matkl EQ gw_matnr-matkl.
      IF gw_mm_stck_rpt-matkl <> gw_matnr-matkl.
        EXIT.
      ENDIF.

      CLEAR  :gw_ppmatch,gw_ppbatch.
      REFRESH:gt_btch_char_tab[],gt_btch_char_tab[].
      CASE gw_mm_stck_rpt-klart.
        WHEN 022.
          READ TABLE gt_ppbatch INTO gw_ppbatch WITH KEY werks = gw_matnr-werks matnr = gw_matnr-matnr charg = gw_matnr-charg  BINARY SEARCH .
          CHECK sy-subrc EQ 0 .
          gt_btch_char_tab[] = gw_ppbatch-char_tab[] .
          CHECK gt_btch_char_tab[] IS NOT INITIAL.
          SORT gt_btch_char_tab[] BY atnam .
          PERFORM insert_char_value USING gw_mm_stck_rpt gt_btch_char_tab .
        WHEN 001.
*        SORT gt_ppmatch BY matnr classtype classnum .
          READ TABLE gt_ppmatch INTO gw_ppmatch WITH KEY matnr = gw_matnr-matnr classtype = '001' BINARY SEARCH .
          CHECK sy-subrc EQ 0 .
          gt_btch_char_tab[] = gw_ppmatch-char_tab[] .
          CHECK gt_btch_char_tab[] IS NOT INITIAL.
          SORT gt_btch_char_tab[] BY atnam .
          PERFORM insert_char_value USING gw_mm_stck_rpt gt_btch_char_tab .
        WHEN 200.
*        SORT gt_ppmatch BY matnr classtype classnum .
          READ TABLE gt_ppmatch INTO gw_ppmatch WITH KEY matnr = gw_matnr-matnr classtype = '200' BINARY SEARCH .
          CHECK sy-subrc EQ 0 .
          gt_btch_char_tab[] = gw_ppmatch-char_tab[] .
          CHECK gt_btch_char_tab[] IS NOT INITIAL.
          SORT gt_btch_char_tab[] BY atnam .
          PERFORM insert_char_value USING gw_mm_stck_rpt gt_btch_char_tab .
        WHEN 300.
*        SORT gt_ppmatch BY matnr cuobj .
          READ TABLE gt_ppmatchn INTO gw_ppmatch WITH KEY matnr = gw_matnr-matnr cuobj = gw_matnr-cuobj BINARY SEARCH .
          CHECK sy-subrc EQ 0 .
          gt_btch_char_tab[] = gw_ppmatch-char_tab[] .
          CHECK gt_btch_char_tab[] IS NOT INITIAL.
          SORT gt_btch_char_tab[] BY atnam .
          PERFORM insert_char_value USING gw_mm_stck_rpt gt_btch_char_tab .
        WHEN '' .
          CLEAR: gt_btch_char_tab .
          PERFORM insert_char_value USING gw_mm_stck_rpt gt_btch_char_tab .
      ENDCASE.
      CLEAR:gw_ppmatch,gw_ppbatch.
      REFRESH:gt_btch_char_tab[],gt_btch_char_tab[].
    ENDLOOP.             "    End:
  ENDIF.

*------------------------------------------------------------------------------------------------------------------*
*&&&&            Logic: In general, BTCH_AUM_QTY = Batch Qty * ZSD_MAT_UOM-CHAR VAL
*&&&&                   If char is KG_CONE then, BTCH_AUM_QTY = Batch Qty / ZSD_MAT_UOM-CHAR VAL
*------------------------------------------------------------------------------------------------------------------*

  IF gw_final-menge IS NOT INITIAL AND gw_final-meins IS NOT INITIAL AND gw_final-btch_aum_qty IS INITIAL.
    READ TABLE gt_mm_stck_rpt INTO gw_mm_stck_rpt WITH KEY matkl = gw_matnr-matkl
                                                           klart = '022' BINARY SEARCH.
    CHECK sy-subrc EQ 0 .                            " If batch data not found exit

    READ TABLE gt_ppbatch INTO gw_ppbatch WITH KEY werks = gw_matnr-werks
                                                   matnr = gw_matnr-matnr
                                                   charg = gw_matnr-charg  BINARY SEARCH .
*                                                   read_char_val = '' BINARY SEARCH .
    CHECK sy-subrc EQ 0.

    REFRESH: gt_btch_char_tab[].
    gt_btch_char_tab[] = gw_ppbatch-char_tab[].
    CHECK gt_btch_char_tab[] IS NOT INITIAL .

    SORT gt_btch_char_tab[] BY atnam .

    READ TABLE gt_mat_uom WITH KEY matkl = gw_final-matkl
                                   meins = gw_final-meins BINARY SEARCH TRANSPORTING NO FIELDS.
    IF sy-subrc = 0.
      DATA(lv_tabix1) = sy-tabix.
      LOOP AT gt_mat_uom INTO gw_mat_uom FROM lv_tabix1. "  WHERE matkl EQ gw_final-matkl AND
*                                             meins EQ gw_final-meins.
        IF gw_mat_uom-matkl <> gw_final-matkl OR gw_mat_uom-meins <> gw_final-meins.
          EXIT.
        ENDIF.
        IF gw_final-btch_aum_qty IS NOT INITIAL ."OR
*         gw_mat_uom-matkl NE gw_matnr-matkl   OR
*         gw_mat_uom-meins NE gw_final-meins   .      "
*
          EXIT.
        ENDIF.

        READ TABLE gt_btch_char_tab[] ASSIGNING FIELD-SYMBOL(<fs2>)
                                      WITH KEY atnam = gw_mat_uom-zchar_con BINARY SEARCH.
        CHECK sy-subrc EQ 0 .

        PERFORM conversion_unit_sales USING gw_mat_uom-vrkme CHANGING gw_final-btch_aum_uom .

        SPLIT <fs2>-atwrt AT '' INTO <fs2>-atwrt lv_atnam.  "  Data Come like This : 0.17740 K/M
        TRY.
            CASE gw_mat_uom-zchar_con.
              WHEN gc_kg_cone.
                gw_final-btch_aum_qty = gw_final-menge / <fs2>-atwrt .
              WHEN gc_kg_pc OR gc_kg_bale.
                CASE gw_final-meins.
                  WHEN 'KG'.
                    gw_final-btch_aum_qty = gw_final-menge / <fs2>-atwrt .   "  for Knits
                  WHEN 'ST'.
                    gw_final-btch_aum_qty = gw_final-menge * <fs2>-atwrt .   " For composit
                ENDCASE.
              WHEN OTHERS.
                gw_final-btch_aum_qty = gw_final-menge * <fs2>-atwrt .
            ENDCASE.
          CATCH cx_sy_zerodivide .
          CATCH cx_sy_conversion_no_number .
          CATCH cx_sy_arithmetic_overflow.
        ENDTRY.

      ENDLOOP.
    ENDIF.
  ENDIF.             "    End:  Batch AUM


*  CLEAR:gw_ppmatch.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_CHAR_VALUE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GW_MATKL  text
*      -->P_GT_BTCH_CHAR_TAB[]  text
*----------------------------------------------------------------------*
FORM insert_char_value USING pw_matkl TYPE ty_stck_rpt pt_btch_char_tab TYPE tt_conf_out .
  DATA: l_char  TYPE char10,
        fs_char TYPE conf_out,
        lv_yarn TYPE char30.

  FIELD-SYMBOLS:<fs_char_tab> TYPE conf_out.
*----------------------------------------------------------*
  CLEAR: fs_char,l_char,gw_mseg261,lv_yarn .

  TRY .
      CASE pw_matkl-klart.
        WHEN ''.
          IF pw_matkl-tabname IS NOT INITIAL .
            READ TABLE gt_mseg261 INTO gw_mseg261 WITH KEY charg = gw_matnr-charg BINARY SEARCH.
            CHECK sy-subrc EQ 0 .

            SELECT SINGLE (pw_matkl-fldname)
              FROM (pw_matkl-tabname)
              INTO l_char
              WHERE gidoc EQ gw_mseg261-mblnr
              AND loekz EQ ''.

            CHECK l_char IS NOT INITIAL .
            fs_char-atwrt = l_char .
            ASSIGN fs_char TO <fs_char_tab>.
          ENDIF.

        WHEN OTHERS.
          READ TABLE pt_btch_char_tab[] ASSIGNING <fs_char_tab> WITH KEY atnam = pw_matkl-atnam BINARY SEARCH.
      ENDCASE.

      "~~~~ Check Uper Logic is work ~~~~~~~~~"
      CHECK sy-subrc EQ 0 AND <fs_char_tab> IS ASSIGNED.

      "~~~~ Input Value into char ~~~~~~~~~"
      CASE pw_matkl-hdrdesc.
        WHEN 'ACTUAL GLM'.                            gw_final-actual_glm   =  <fs_char_tab>-atwrt.
        WHEN 'AIR PERMEABILITY'.                      gw_final-air_permit   =  <fs_char_tab>-atwrt.
        WHEN 'AREA OF ONE PC(SQ MT)'.                 gw_final-area_1pc     =  <fs_char_tab>-atwrt.
        WHEN 'ARM DETAILS'.                           gw_final-arm_dtls     =  <fs_char_tab>-atwrt.
        WHEN 'BALE/ROLL'.                             gw_final-bale_roll    =  <fs_char_tab>-atwrt.
        WHEN 'BEAM FALL'.                             gw_final-beam_fall    =  <fs_char_tab>-atwrt.
        WHEN 'BIG ROLL NO'.                           gw_final-big_rollno   =  <fs_char_tab>-atwrt.
*        WHEN 'BLEND'.                                 gw_final-blend =  <fs_char_tab>-atwrt.    " Change by Sanjoy: 02-11-2018
        WHEN 'BLEND' OR 'BLEND %'.
          CASE pw_matkl-klart.
            WHEN '022'.
              gw_final-blend =  <fs_char_tab>-atwrt.     " Change by Sanjoy: 02-11-2018
            WHEN OTHERS.
              gw_final-blend =  <fs_char_tab>-atwtb.    " Change by Sanjoy: 02-11-2018
          ENDCASE.

        WHEN 'BORDER'.                                gw_final-border       =  <fs_char_tab>-atwrt.
        WHEN 'CATEGORY YARN DYED/ NON YARN DYED'.     gw_final-ct_y_ny_dyed =  <fs_char_tab>-atwrt."
        WHEN 'CHART NO'.                              gw_final-chart_no     =  <fs_char_tab>-atwrt.
        WHEN 'CHART PREFIX'.                          gw_final-chart_prfx   =  <fs_char_tab>-atwrt.
        WHEN 'CHEMICAL FINISH'.                       gw_final-chem_finsh   =  <fs_char_tab>-atwrt.
        WHEN 'COATING'.                               gw_final-coating      =  <fs_char_tab>-atwrt.
        WHEN 'COMBO NAME'.                            gw_final-combo_name   =  <fs_char_tab>-atwrt.
        WHEN 'CONTRACTOR NAME'.                       gw_final-cont_name    =  <fs_char_tab>-atwrt.
        WHEN 'CREEL'.                                 gw_final-creel        =  <fs_char_tab>-atwrt.
        WHEN 'DESIGN NO'.                             gw_final-design_no    =  <fs_char_tab>-atwrt.
        WHEN 'DEVELOPMENT SAMPLE REF'.                gw_final-dev_smpl_ref =  <fs_char_tab>-atwrt.
        WHEN 'DIA OF BAD'.                            gw_final-dia_bad      =  <fs_char_tab>-atwrt.
        WHEN 'DIA'.                                   gw_final-dia          =  <fs_char_tab>-atwrt.
        WHEN 'GAUGE'.                                 gw_final-gauge        =  <fs_char_tab>-atwrt.
        WHEN 'DIAMETER'.                              gw_final-diameter     =  <fs_char_tab>-atwrt.
        WHEN 'DIMENSION'.                             gw_final-dimension    =  <fs_char_tab>-atwrt.
        WHEN 'FABRIC NAME/SERIALNO'.                  gw_final-fab_name_slno =  <fs_char_tab>-atwrt.
        WHEN 'FIBER COMPOSITION'.                     gw_final-fibr_comp    =  <fs_char_tab>-atwrt.
        WHEN 'FINAL TAG'.                             gw_final-final_tag    =  <fs_char_tab>-atwrt.

        WHEN 'FINISH CODE'.                           gw_final-finish_code  =  <fs_char_tab>-atwrt.

        WHEN 'PRODUCT CATEGORY'.

          gw_final-prod_cat     =  <fs_char_tab>-atwrt.
          gw_final-prod_cat_desc     =  <fs_char_tab>-atwtb.

        WHEN 'FINISH GSM'.                            gw_final-finish_gsm   =  <fs_char_tab>-atwrt.
        WHEN 'FOAM DENSITY'.                          gw_final-form_density =  <fs_char_tab>-atwrt.
        WHEN 'FOAM THICKNESS MM'.                     gw_final-form_thik_mm =  <fs_char_tab>-atwrt.
        WHEN 'FORM OF PACKING'.                       gw_final-form_pack    =  <fs_char_tab>-atwrt.
        WHEN 'FR / NFR'.                              gw_final-fr_nfr       =  <fs_char_tab>-atwrt.
        WHEN 'GC/FENTS REMARK'.                       gw_final-gc_fents_rmk =  <fs_char_tab>-atwrt.
        WHEN 'GREIGE GSM'.                            gw_final-greige_gsm   =  <fs_char_tab>-atwrt.
        WHEN 'GROSS WT'.                              gw_final-gross_wt     =  <fs_char_tab>-atwrt.
        WHEN 'HEIGHT'.                                gw_final-height       =  <fs_char_tab>-atwrt.
        WHEN 'INITIAL TAG'.                           gw_final-initial_tag  =  <fs_char_tab>-atwrt.
        WHEN 'INSPECTION REMARK'.                     gw_final-insp_rmk     =  <fs_char_tab>-atwrt.
        WHEN 'INSPECTOR  1'.                          gw_final-insptor_1    =  <fs_char_tab>-atwrt.
        WHEN 'INSPECTOR 2'.                           gw_final-insptor_2    =  <fs_char_tab>-atwrt.
        WHEN 'INSPECTOR NAME'.                        gw_final-insptor_name =  <fs_char_tab>-atwrt.
        WHEN 'KATCHA PACKING SLIP'.                   gw_final-ktch_pck_slp =  <fs_char_tab>-atwrt.
        WHEN 'KNOTTABILITY CODE'.                     gw_final-knotabl_code =  <fs_char_tab>-atwrt.
        WHEN 'LAB DIP NO'.                            gw_final-lab_dip_no   =  <fs_char_tab>-atwrt.
        WHEN 'LENGTH'.                                gw_final-length       =  <fs_char_tab>-atwrt.
        WHEN 'LENGTH OF BAG'.                         gw_final-length_bag   =  <fs_char_tab>-atwrt.
        WHEN 'MACHINE/LOOM NO'.                       gw_final-mchin_loom_no =  <fs_char_tab>-atwrt.
        WHEN 'METER_KG'.                              gw_final-meter_kg     =  <fs_char_tab>-atwrt.
        WHEN 'NET WT'.                                gw_final-net_wt       =  <fs_char_tab>-atwrt.
        WHEN 'NO OF ENDS'.                            gw_final-no_ends      =  <fs_char_tab>-atwrt.
        WHEN 'NO OF PIECE'.                           gw_final-no_piece     =  <fs_char_tab>-atwrt.
        WHEN 'NO OF RINGS'.                           gw_final-no_rings     =  <fs_char_tab>-atwrt.
        WHEN 'NOW BALE NO'.                           gw_final-now_bal_no   =  <fs_char_tab>-atwrt.
        WHEN 'NOW ROLL NO'.                           gw_final-now_rol_no   =  <fs_char_tab>-atwrt.
        WHEN 'OEM NAME'.                              gw_final-oem_name     =  <fs_char_tab>-atwrt.
*        WHEN 'OLD MATERIAL NO'.                       gw_final-old_mtrl_no  =  <fs_char_tab>-atwrt.
        WHEN 'ON LOOM EPI'.                           gw_final-on_loom_epi  =  <fs_char_tab>-atwrt.
        WHEN 'ON LOOM PPI'.                           gw_final-on_loom_ppi  =  <fs_char_tab>-atwrt.
        WHEN 'OPEN WIDTH/ TUBULAR'.                   gw_final-opn_wth_tublr =  <fs_char_tab>-atwrt.
        WHEN 'ORGANICCERTIFICATION'.                 gw_final-organic_certifkt =  <fs_char_tab>-atwtb.
        WHEN 'ORIGINAL SALES ORDER'.
          gw_final-org_sono =  <fs_char_tab>-atwrt.
          IF gw_final-org_sono IS NOT INITIAL.
*            gw_final-org_auart = VALUE #( gt_vbak[ vbeln = gw_final-org_sono ]-auart OPTIONAL ).
            READ TABLE gt_vbak_auart INTO gs_vbak_auart WITH KEY vbeln = gw_final-org_sono.
            IF sy-subrc = 0.
              gw_final-org_auart =  gs_vbak_auart-auart.
            ELSE.
              SELECT SINGLE auart INTO gw_final-org_auart FROM vbak WHERE vbeln EQ gw_final-org_sono .
              gs_vbak_auart-vbeln =   gw_final-org_sono.
              gs_vbak_auart-auart = gw_final-org_auart.
              APPEND gs_vbak_auart TO gt_vbak_auart.
              CLEAR : gs_vbak_auart .
            ENDIF.
            CLEAR : gs_vbak_auart.
          ENDIF.
        WHEN 'ORIGINAL SO LINE'.                      gw_final-org_soline      =  <fs_char_tab>-atwrt.
        WHEN 'PACKAGE LENGTH'.                        gw_final-pck_length      =  <fs_char_tab>-atwrt.
        WHEN 'PHYSICAL BEAM GROUP'.                   gw_final-phycl_beam_gr   =  <fs_char_tab>-atwrt.
        WHEN 'PHYSICAL BEAM NO'.                      gw_final-phycl_beam_no   =  <fs_char_tab>-atwrt.
        WHEN 'PIECE LENGTH'.                          gw_final-piece_length    =  <fs_char_tab>-atwrt.
        WHEN 'PKG SIZE'.                              gw_final-pck_size        =  <fs_char_tab>-atwrt.
        WHEN 'POINTS PER 100 SQ M'.                   gw_final-point_pr_100sqm =  <fs_char_tab>-atwrt.
        WHEN 'POINTS PER 100 SQ YD'.                  gw_final-point_pr_100sqy =  <fs_char_tab>-atwrt.
        WHEN 'PRINT CODE'.                            gw_final-print_code      =  <fs_char_tab>-atwrt.
        WHEN 'PROFILE COLOR'.                         gw_final-profile_color   =  <fs_char_tab>-atwrt.

        WHEN 'QUALITCY CODE'.        " Read Quality Code description

          gw_final-qlty_code =  <fs_char_tab>-atwrt.
          gw_final-qltdsc    =  <fs_char_tab>-atwtb.

        WHEN 'REED SPACE'.              gw_final-reed_space       =  <fs_char_tab>-atwrt.
        WHEN 'RESIN CODE'.              gw_final-resin_code       =  <fs_char_tab>-atwrt.
        WHEN 'ROLL NO'.                 gw_final-roll_no          =  <fs_char_tab>-atwrt.
        WHEN 'ROPE / SLASHER'.          gw_final-rope_slasher     =  <fs_char_tab>-atwrt.
        WHEN 'SCRIM GSM'.               gw_final-scrim_gsm        =  <fs_char_tab>-atwrt.
        WHEN 'SETCODE'.                 gw_final-set_code         =  <fs_char_tab>-atwrt.

        WHEN 'SHADE / COLOUR'.
          gw_final-shade_colour     =  <fs_char_tab>-atwrt.
          "~~~ Add on 11-12-2018 by surajit rqst by Pinky mam~~~" Start
          PERFORM material_desc USING  gw_final-shade_colour CHANGING gw_final-shd_colr_text .
          "~~~ Add on 11-12-2018 by surajit rqst by Pinky mam~~~" End

        WHEN 'SHADE CODE'.              gw_final-shade_code       =  <fs_char_tab>-atwrt.
        WHEN 'SHADE COMMENT'.           gw_final-shade_comnt      =  <fs_char_tab>-atwrt.
        WHEN 'SHADE GROUP'.             gw_final-shade_gr         =  <fs_char_tab>-atwrt.
        WHEN 'SHADE LOT'.               gw_final-shade_lot        =  <fs_char_tab>-atwrt.
        WHEN 'SIZE SET NO'.             gw_final-size_set_no      =  <fs_char_tab>-atwrt.
        WHEN 'STANDARD GLM '.           gw_final-stand_glm        =  <fs_char_tab>-atwrt.
        WHEN 'STITCH LENGTH'.           gw_final-stich_length     =  <fs_char_tab>-atwrt.
        WHEN 'STRUCTURE'.               gw_final-structure        =  <fs_char_tab>-atwrt.
        WHEN 'SUPPLIER LOT'.            gw_final-supply_lot       =  <fs_char_tab>-atwrt.
        WHEN 'SUPPLIER NAME'.           gw_final-supply_name      =  <fs_char_tab>-atwrt.
        WHEN 'SURFACE FINISH'.          gw_final-surface_finish   =  <fs_char_tab>-atwrt.
        WHEN 'TOTAL DEFECT'.            gw_final-ttl_defect       =  <fs_char_tab>-atwrt.
        WHEN 'TOTAL POINTS'.            gw_final-ttl_point        =  <fs_char_tab>-atwrt.
        WHEN 'TOTAL THICKNESS MM'.      gw_final-ttl_thik_mm      =  <fs_char_tab>-atwrt.
        WHEN 'TYPE'.                    gw_final-type             =  <fs_char_tab>-atwrt.
        WHEN 'TYPE OF BAG'.             gw_final-type_bag         =  <fs_char_tab>-atwrt.
        WHEN 'UNWASHED SHADE'.          gw_final-unwash_shade     =  <fs_char_tab>-atwrt.
        WHEN 'USEABLE WIDTH'.           gw_final-useable_width    =  <fs_char_tab>-atwrt.
        WHEN 'UV / NON UV'.             gw_final-uv_nuv           =  <fs_char_tab>-atwrt.
        WHEN 'VARIETY'.                 gw_final-veriety          =  <fs_char_tab>-atwrt.
        WHEN 'WARP COUNT'.              gw_final-warp_count       =  <fs_char_tab>-atwrt.
        WHEN 'WARP LOT NO'.             gw_final-warp_lot_no      =  <fs_char_tab>-atwrt.
        WHEN 'WARP SUPPLIER'.           gw_final-warp_supply      =  <fs_char_tab>-atwrt.
        WHEN 'WARPABILITY CODE'.        gw_final-warp_able_code   =  <fs_char_tab>-atwrt.
        WHEN 'WASH LOT'.                gw_final-wash_lot         =  <fs_char_tab>-atwrt.
        WHEN 'WASH STATUS'.             gw_final-wash_status      =  <fs_char_tab>-atwrt.
        WHEN 'WASHED SHADE'.            gw_final-wash_shade       =  <fs_char_tab>-atwrt.
        WHEN 'WEAVE'.                   gw_final-wave             =  <fs_char_tab>-atwrt.
*        WHEN 'WEAVING PLANT'.           gw_final-weaving_plant    =  <fs_char_tab>-atwrt.
        WHEN 'WEFT COUNT'.              gw_final-weft_count       =  <fs_char_tab>-atwrt.
        WHEN 'WEFT LOT NO'.             gw_final-weft_lot_no      =  <fs_char_tab>-atwrt.
        WHEN 'WEFT SUPPLIER'.           gw_final-weft_supply      =  <fs_char_tab>-atwrt.
        WHEN 'WEIGHT OF HAND MOLD'.     gw_final-wt_hand_mold     =  <fs_char_tab>-atwrt.
        WHEN 'WEIGHT OF WARP'.          gw_final-wt_warp          =  <fs_char_tab>-atwrt.
        WHEN 'WEIGHT OF WEFT'.          gw_final-wt_weft          =  <fs_char_tab>-atwrt.
        WHEN 'WF MAT 1'.                gw_final-wf_mat1          =  <fs_char_tab>-atwrt.
        WHEN 'WF MAT 2'.                gw_final-wf_mat2          =  <fs_char_tab>-atwrt.
        WHEN 'WF MAT 3'.                gw_final-wf_mat3          =  <fs_char_tab>-atwrt.
        WHEN 'WF MAT 4'.                gw_final-wf_mat4          =  <fs_char_tab>-atwrt.
        WHEN 'WIDTH'.                   gw_final-width            =  <fs_char_tab>-atwrt.
        WHEN 'WIDTH ETE'.               gw_final-wdith_ete        =  <fs_char_tab>-atwrt.
        WHEN 'WIP BATCH NO'.            gw_final-wip_btch_no      =  <fs_char_tab>-atwrt.
        WHEN 'WP MAT 1'.                gw_final-wp_mat1          =  <fs_char_tab>-atwrt.
        WHEN 'WP MAT 2'.                gw_final-wp_mat2          =  <fs_char_tab>-atwrt.
        WHEN 'WP MAT 3'.                gw_final-wp_mat3          =  <fs_char_tab>-atwrt.
        WHEN 'WP MAT 4'.                gw_final-wp_mat4          =  <fs_char_tab>-atwrt.
        WHEN 'WT PER GRATING'.          gw_final-wt_pr_grating    =  <fs_char_tab>-atwrt.
        WHEN 'YARN USE'.                gw_final-yarn_use         =  <fs_char_tab>-atwrt.
        WHEN 'MIXING DETAIL'.           gw_final-mix_dtls         =  <fs_char_tab>-atwrt.
        WHEN 'KG_CONE'.                 gw_final-kg_cone          =  <fs_char_tab>-atwrt.
        WHEN 'ROPE POSITION NO'.        gw_final-rpn              =  <fs_char_tab>-atwrt.
        WHEN 'DYED YARN LOT NO'.        gw_final-dylno            =  <fs_char_tab>-atwrt.
        WHEN 'REMARK'.                  gw_final-remark           =  <fs_char_tab>-atwrt.
        WHEN 'NO OF WRP BREAKS'.        gw_final-wrp_brk          =  <fs_char_tab>-atwrt.
        WHEN 'KG_METER'.                gw_final-kg_meter         =  <fs_char_tab>-atwrt.
        WHEN 'YARN 1 SOURCE'.           gw_final-yarn1            = <fs_char_tab>-atwrt.
        WHEN 'YARN 2 SOURCE'.           gw_final-yarn2            = <fs_char_tab>-atwrt.
        WHEN 'YARN 3 SOURCE'.           gw_final-yarn3            = <fs_char_tab>-atwrt.
        WHEN 'YARN 4 SOURCE'.           gw_final-yarn4            = <fs_char_tab>-atwrt.
        WHEN 'SZG BATCH'.               gw_final-szg_btch         = <fs_char_tab>-atwrt.
        WHEN 'SIZE SET SR NO'.          gw_final-szg_set_sl       = <fs_char_tab>-atwrt.
        WHEN 'DYEING M/C'.              gw_final-dyeing_mc        = <fs_char_tab>-atwrt.
        WHEN 'BRK@COMB1 OCC @MTRS' .    gw_final-brk_comb1        = <fs_char_tab>-atwrt.
        WHEN 'BRK@COMB2 OCC @MTRS' .    gw_final-brk_comb2        = <fs_char_tab>-atwrt.
        WHEN 'BRK@COMB3 OCC @MTRS' .    gw_final-brk_comb3        = <fs_char_tab>-atwrt.
        WHEN 'LAPR1 OCC @MTRS' .        gw_final-lapr1            = <fs_char_tab>-atwrt.
        WHEN 'LAPR2 OCC @MTRS' .        gw_final-lapr2            = <fs_char_tab>-atwrt.
        WHEN 'LAPR3 OCC @MTRS' .        gw_final-lapr3            = <fs_char_tab>-atwrt.
        WHEN 'OPERATOR' .               gw_final-operator         = <fs_char_tab>-atwrt.
        WHEN 'ROPE LOT NO1' .           gw_final-rope_no1         = <fs_char_tab>-atwrt.
        WHEN 'ROPE LOT NO2' .           gw_final-rope_no2         = <fs_char_tab>-atwrt.
        WHEN 'ROPE LOT NO3' .           gw_final-rope_no3         = <fs_char_tab>-atwrt.
        WHEN 'ROPE LOT NO4' .           gw_final-rope_no4         = <fs_char_tab>-atwrt.
        WHEN 'QLTY DEGRADE REASON'.     gw_final-qlty_degrad      = <fs_char_tab>-atwrt.
        WHEN 'ISSUE LOT NO1'.           gw_final-isu_lt_no1       = <fs_char_tab>-atwrt.
        WHEN 'ISSUE LOT NO2' .          gw_final-isu_lt_no2       = <fs_char_tab>-atwrt.
        WHEN 'ISSUE LOT NO3' .          gw_final-isu_lt_no3       = <fs_char_tab>-atwrt.
        WHEN 'ISSUE LOT NO4' .          gw_final-isu_lt_no4       = <fs_char_tab>-atwrt.
        WHEN 'NO OF ENDS PER BEAM'.     gw_final-nepb             = <fs_char_tab>-atwrt.
        WHEN 'BLW BREAKS @YARN1' .      gw_final-blw1             = <fs_char_tab>-atwrt.
        WHEN 'BLW BREAKS @YARN2' .      gw_final-blw2             = <fs_char_tab>-atwrt.
        WHEN 'BLW BREAKS @YARN3' .      gw_final-blw3             = <fs_char_tab>-atwrt.
        WHEN 'BLW BREAKS @YARN4' .      gw_final-blw4             = <fs_char_tab>-atwrt.
        WHEN 'MAT CATEGORY' .           gw_final-mat_cat          = <fs_char_tab>-atwrt.      " Add On 17.09.2018 by Bharat Bhai
        WHEN 'MAT DRGNO' .              gw_final-mat_drgno        = <fs_char_tab>-atwrt.      " Add On 17.09.2018 by Bharat Bhai
        WHEN 'TRADE NAME' .             gw_final-trd_name         = <fs_char_tab>-atwrt.      " Add On 20.09.2018 by Nidhi
        WHEN 'STITCH' .                 gw_final-stitch           = <fs_char_tab>-atwrt.      " Add On 20.09.2018 by Nidhi
        WHEN 'FREE FIELD1' .            gw_final-free1            = <fs_char_tab>-atwrt.      " Add On 11.12.2018 by surajit Rqst by Pinky
        WHEN 'FREE FIELD2' .            gw_final-free2            = <fs_char_tab>-atwrt.      " Add On 11.12.2018 by surajit Rqst by Pinky
        WHEN 'FREE FIELD3' .            gw_final-free3            = <fs_char_tab>-atwrt.      " Add On 11.12.2018 by surajit Rqst by Pinky
        WHEN 'FREE FIELD4' .            gw_final-free4            = <fs_char_tab>-atwrt.      " Add On 11.12.2018 by surajit Rqst by Pinky
        WHEN 'FREE FIELD5' .            gw_final-free5            = <fs_char_tab>-atwrt.      " Add On 11.12.2018 by surajit Rqst by Pinky
        WHEN 'PRODUCTION ORDER' .       gw_final-aufnr            = <fs_char_tab>-atwrt.      " Add On 11.12.2018 by surajit Rqst by Pinky

        WHEN 'YARN1 DESC' .
          lv_yarn       = <fs_char_tab>-atwrt.                                                " Add On 13.12.2018 by surajit Rqst by Sanjoy
          PERFORM material_desc USING  lv_yarn CHANGING gw_final-yarn1_desc .
        WHEN 'YARN2 DESC' .
          lv_yarn       = <fs_char_tab>-atwrt.                                                " Add On 13.12.2018 by surajit Rqst by Sanjoy
          PERFORM material_desc USING  lv_yarn CHANGING gw_final-yarn2_desc .
        WHEN 'YARN3 DESC' .
          lv_yarn       = <fs_char_tab>-atwrt.                                                " Add On 13.12.2018 by surajit Rqst by Sanjoy
          PERFORM material_desc USING  lv_yarn CHANGING gw_final-yarn3_desc .
        WHEN 'YARN4 DESC' .
          lv_yarn       = <fs_char_tab>-atwrt.                                                 " Add On 13.12.2018 by surajit Rqst by Sanjoy
          PERFORM material_desc USING  lv_yarn CHANGING gw_final-yarn4_desc .
        WHEN 'DEFECT CODE' .                                                                   " Add On 11-2-2019 by surajit
          gw_final-defect_code   = <fs_char_tab>-atwrt.
          IF gw_final-defect_code IS NOT INITIAL AND gw_final-defect_code NA gc_spcl_char .
            PERFORM defect_code CHANGING gw_final-defect_code .
          ENDIF.
        WHEN 'CKT NO'.
          gw_final-k_no =   <fs_char_tab>-atwrt.
        WHEN 'VED_IND'.
          gw_final-vedind = <fs_char_tab>-atwrt.            "Added by Shashank on 20th Nov 2020 Rqst by Saurabh
      ENDCASE.

    CATCH cx_sy_conversion_no_number .
    CATCH cx_root .
  ENDTRY.
*  CLEAR:l_ppbatch,l_ppbatch[].
*  ENDLOOP.
ENDFORM.
FORM gl_details.
**Harsad's code commented by aditya vora
***  """"""""""""""""' start added HARSHAD 02-06-21 """"""""""'
  "" add 3 characteristics columns
  TYPES: BEGIN OF ty_objek,
           cuobj_bm TYPE mcha-cuobj_bm, " CHAR18
           objek    TYPE ausp-objek,    " CHAR50
         END OF ty_objek.
  TYPES:BEGIN OF ty_ausp0,
          objek   TYPE ausp-objek,
          atinn   TYPE ausp-atinn,
          atzhl   TYPE ausp-atzhl,
          mafid   TYPE ausp-mafid,
          klart   TYPE ausp-klart,
          adzhl   TYPE ausp-adzhl,
          atwrt   TYPE ausp-atwrt,
          str(10) TYPE c,
        END OF ty_ausp0.

  DATA:lt_ausp0 TYPE STANDARD TABLE OF ty_ausp0,
       ls_ausp0 TYPE ty_ausp0.
  DATA: gt_objek TYPE STANDARD TABLE OF ty_objek,
        wa_objek TYPE ty_objek.

  TYPES : BEGIN OF ty_mspr,
            matnr TYPE mspr-matnr,
            werks TYPE mspr-werks,
            lgort TYPE mspr-lgort,
            charg TYPE mspr-charg,
            sobkz TYPE mspr-pspnr,
            pspnr TYPE mspr-pspnr,
          END OF ty_mspr.

  DATA : gt_mspr TYPE STANDARD TABLE OF   ty_mspr,
         gs_mspr TYPE ty_mspr.


  IF gt_final IS NOT INITIAL.
    SELECT matnr, werks, charg, cuobj_bm FROM mcha
      INTO TABLE @DATA(gt_mcha0)
      FOR ALL ENTRIES IN @gt_final
      WHERE matnr = @gt_final-matnr
        AND werks = @gt_final-werks
        AND charg = @gt_final-charg.
  ENDIF.
  SORT : gt_mcha0 BY matnr charg werks.
  IF gt_mcha0 IS NOT INITIAL.
    LOOP AT gt_mcha0 INTO DATA(wa_mcha).
      wa_objek-cuobj_bm = wa_mcha-cuobj_bm.
      wa_objek-objek    = wa_mcha-cuobj_bm.
      " CONCATENATE '0000000000' wa_mcha-cuobj_bm INTO wa_objek-objek.
      APPEND wa_objek TO gt_objek.
      CLEAR: wa_objek.
    ENDLOOP.

    SORT : gt_objek BY cuobj_bm.
  ENDIF.
  " BREAK: v00029.
  IF gt_objek IS NOT INITIAL.
    SELECT objek, atinn, atzhl, mafid, klart, adzhl, atwrt FROM ausp
      INTO TABLE @DATA(gt_ausp0)
      FOR ALL ENTRIES IN @gt_objek
      WHERE objek = @gt_objek-objek
        AND klart = '022'.

    MOVE-CORRESPONDING gt_ausp0[]  TO lt_ausp0[].

    IF lt_ausp0[] IS NOT INITIAL.
      SELECT atinn , atnam
        FROM cabn
        FOR ALL ENTRIES IN @lt_ausp0
        WHERE atinn = @lt_ausp0-atinn
        INTO TABLE @DATA(gt_cabn).
    ENDIF.
    SORT gt_cabn BY atinn.
    LOOP AT lt_ausp0 ASSIGNING FIELD-SYMBOL(<fs_ausp0>).
      <fs_ausp0>-str = VALUE #( gt_cabn[ atinn = <fs_ausp0>-atinn ]-atnam OPTIONAL ).
*      CALL FUNCTION 'CONVERSION_EXIT_ATINN_OUTPUT'
*        EXPORTING
*          input  = <fs_ausp0>-atinn
*        IMPORTING
*          output = <fs_ausp0>-str.

    ENDLOOP.
  ENDIF.
***  """"""""""""""""' end added HARSHAD 02-06-21 """"""""""'

  IF gt_final[] IS NOT INITIAL.
    SELECT mblnr, budat_mkpf, charg, mjahr FROM mseg
    INTO TABLE @DATA(gt_mseg)
    FOR ALL ENTRIES IN @gt_final
    WHERE mblnr = @gt_final-mblnr
    AND budat_mkpf = @gt_final-fvdt2
    AND charg = @gt_final-charg.
  ENDIF.
  IF gt_mseg IS NOT INITIAL.
    """" 26-06-21 on behalf of @Jigar's requirement /
    """" ADD field GS_ACDOCA-RACCT """"""""""""
    "SELECT awref, aworg, ktosl, racct FROM acdoca " uncommented query by Harshad 26-06-21
    SELECT rldnr, rbukrs, gjahr, belnr, docln, aworg, awref, racct, ktosl " added key fields
      FROM acdoca
      INTO TABLE @DATA(gt_acdoca)
      FOR ALL ENTRIES IN @gt_mseg
      WHERE awref = @gt_mseg-mblnr
        "AND aworg = @gt_mseg-mjahr
        AND ktosl = 'BSX'.
    """" End field GS_ACDOCA-RACCT """"""""""""

*    SORT : gt_mseg by
    gt_final1[] = gt_final[].
    SORT gt_mseg BY mblnr budat_mkpf charg.
    SORT gt_acdoca BY awref aworg ktosl.

    gt_final_ausp = VALUE #( FOR ls_ausp IN gt_final WHERE ( werks = '1021' )
                            ( matnr = ls_ausp-matnr ) ).
    SORT : gt_final_ausp BY matnr.
    DELETE ADJACENT DUPLICATES FROM gt_final_ausp COMPARING matnr.
    IF gt_final_ausp[] IS NOT INITIAL.
      IF sy-sysid = 'ATQ' OR sy-sysid = 'ATP'.
        DATA(lv_atinn) = '0000002766'.
      ELSEIF sy-sysid = 'ATD'.
        lv_atinn = '0000001085'.
      ENDIF.
      SELECT objek, atinn, klart, atwrt
        FROM ausp
        FOR ALL ENTRIES IN @gt_final_ausp
        WHERE objek = @gt_final_ausp-matnr
        AND  atinn = @lv_atinn
        AND  klart = '001'
        INTO TABLE @DATA(gt_ausp).
    ENDIF.
    CLEAR : gt_final_ausp[].
    SORT : lt_ausp0 BY objek str.

*_Begin of inser by Sushen on 21.09.2023 , Devid 4298  , Req by Kunal
    gt_final_lc = gt_final.
    DELETE gt_final_lc WHERE sobkz NE 'Q'.
    IF gt_final_lc IS NOT INITIAL.
      SELECT   matnr
               werks
               lgort
               charg
               sobkz
               pspnr
               FROM mspr
               INTO TABLE gt_mspr
               FOR ALL ENTRIES IN gt_final_lc
               WHERE matnr = gt_final_lc-matnr
               AND   werks = gt_final_lc-werks
               AND   charg = gt_final_lc-charg.
      SORT gt_mspr ASCENDING BY matnr werks charg.
    ENDIF.
*_End of inser by Sushen on 21.09.2023 , Devid 4298  , Req by Kunal

    LOOP AT gt_final INTO gw_final.
      gd_tabix = sy-tabix.
      READ TABLE gt_mseg INTO DATA(gs_mseg) WITH KEY mblnr = gw_final-mblnr
                                                     budat_mkpf = gw_final-fvdt2
                                                     charg = gw_final-charg BINARY SEARCH.
      IF sy-subrc = 0.
        gv_mjahr = gs_mseg-mjahr .
        """"""""""" added by Harshad 26-06-21 """""""""""""""""
        """"""""""" end added by Harshad 26-06-21 """""""""""""""""
        READ TABLE gt_acdoca INTO DATA(gs_acdoca)
                             WITH KEY awref = gs_mseg-mblnr
                                      aworg = gv_mjahr
                                      ktosl = 'BSX' BINARY SEARCH.
        IF gs_acdoca IS NOT INITIAL.
          gw_final-racct = gs_acdoca-racct.
        ENDIF.
      ENDIF.

*********************Added by Surbhi Dadhich***********************
      IF gw_final-werks = '1021'.
        gw_final-sort_cat = VALUE #( gt_ausp[ objek = gw_final-matnr ]-atwrt OPTIONAL ).
      ENDIF.
*********************Added by Surbhi Dadhich***********************
      IF gw_final-werks = '1065'.
        READ TABLE gt_mcha0 INTO DATA(gs_mcha0) WITH KEY matnr = gw_final-matnr
                                                         charg = gw_final-charg
                                                         werks = gw_final-werks BINARY SEARCH.
        IF sy-subrc = 0.
          READ TABLE gt_objek INTO wa_objek WITH KEY cuobj_bm = gs_mcha0-cuobj_bm BINARY SEARCH.
          IF sy-subrc = 0.

            READ TABLE lt_ausp0 INTO DATA(gs_ausp1) WITH KEY objek = wa_objek-objek
                                                             str = 'P_PROJ' BINARY SEARCH.
            IF sy-subrc = 0.
              gw_final-proj_atwrt = gs_ausp1-atwrt.
            ENDIF.
            READ TABLE lt_ausp0 INTO DATA(gs_ausp2) WITH KEY objek = wa_objek-objek
                                                             str = 'P_CUST' BINARY SEARCH.
            IF sy-subrc = 0.
              gw_final-cust_atwrt = gs_ausp2-atwrt.
            ENDIF.

            READ TABLE lt_ausp0 INTO DATA(gs_ausp3) WITH KEY objek = wa_objek-objek
                                                             str = 'P_MASS' BINARY SEARCH.
            IF sy-subrc = 0.
              gw_final-mass_atwrt = gs_ausp3-atwrt.
            ENDIF.

          ENDIF.

*        gw_final-mass_atwrt = wa_ausp1-atwtb. " CHAR VALUE
        ENDIF.
      ENDIF.
      """"""""""""""""' end added HARSHAD 02-06-21 """"""""""'

*      MODIFY GT_FINAL1 FROM GW_FINAL1 INDEX SY-TABIX.

*_Begin of inser by Sushen on 21.09.2023 , Devid 4298  , Req by Kunal
      READ TABLE gt_mspr INTO gs_mspr WITH KEY matnr = gw_final-matnr werks = gw_final-werks charg = gs_mspr-charg BINARY SEARCH.
      IF sy-subrc = 0.
        gw_final-wbs_ele = gs_mspr-pspnr.
      ENDIF.
*_End of Insert by Sushen on 21.09.2023 ,Devid 4298 , Req by Kunal

      MODIFY gt_final INDEX gd_tabix FROM gw_final.
      CLEAR : gw_final,gs_ausp1,gs_ausp2,gs_ausp3.
    ENDLOOP.
  ENDIF.

*  IF s_werks-low = '1021' OR s_werks-high = '1021'.
*    PERFORM batch_aging.   "Added by Surbhi Dadhich
*    SORT gt_final BY charg.
*  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  BATCH_AGING
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*************************Added by Surbhi dadhich************************
*FORM batch_aging.
*  PERFORM sr_no1.
*  PERFORM sr_no2.
*  PERFORM sr_no4.
*ENDFORM.
*************************Added by Surbhi dadhich************************
*&---------------------------------------------------------------------*
*&      Form  BUILD_ALV
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM build_alv .
*Build Field Catalog
  PERFORM build_fcat.

*Build Layout
  PERFORM build_layout USING 'X' 'X' '' '' '' '' ''.

*Set Variant
  PERFORM build_variant .

*Build Sort
*  PERFORM build_sort USING 'PRD_TYPE' 'X' '' '' 'GT_FINAL' '' CHANGING gv_pos .
*  PERFORM build_sort USING 'SORT_PRF' 'X' '' '' 'GT_FINAL' '' CHANGING gv_pos .
*  PERFORM build_sort USING 'SORT_NO'  'X' '' 'X' 'GT_FINAL' '' CHANGING gv_pos .

*Build Top of Page
  PERFORM build_top_of_page.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  DISPLAY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM display .


  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_callback_program     = sy-repid
      i_callback_top_of_page = 'TOP_OF_PAGE'
      is_layout              = gw_lay
      it_fieldcat            = gt_fcat
      it_sort                = gt_sort
      i_save                 = 'A'
      is_variant             = gw_variant
    TABLES
      t_outtab               = gt_final
    EXCEPTIONS
      program_error          = 1
      OTHERS                 = 2.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  BUILD_FCAT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM build_fcat .
  PERFORM build_field USING 'FVDT1'               TEXT-100 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FVDT2'               TEXT-101 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'CPUTM'               TEXT-378 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WERKS'               TEXT-102 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LGORT'               TEXT-103 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SCI_VALUE'           TEXT-412 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'COTTON_CAT'          TEXT-413 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LGOBE'               TEXT-104 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'MATKL'               TEXT-105 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WGBEZ'               TEXT-106 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'MATNR'               TEXT-107 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'MAKTX'               TEXT-108 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'CHARG'               TEXT-109 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'RACCT'               TEXT-470 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'OPERATION'           TEXT-402 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DEPARTDESC'          TEXT-403 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'MENGE'               TEXT-111 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'MEINS'               TEXT-112 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'QLTY_CODE'           TEXT-113 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'QLTDSC'              TEXT-114 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BTCH_AUM_QTY'        TEXT-115 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'BTCH_AUM_UOM'        TEXT-116 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PCK_SIZE'            TEXT-119 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SUPPLY_LOT'          TEXT-120 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LGNUM'               TEXT-121 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LNUMT'               TEXT-122 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LGTYP'               TEXT-123 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LGPLA'               TEXT-124 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ST_TEXT'             TEXT-125 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SOBKZ'               TEXT-126 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'AUART'               TEXT-127 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'VBELN'               TEXT-128 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'POSNR'               TEXT-129 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  IF r1 = 'X' OR r2 = 'X'.
    PERFORM build_field USING 'AUFNR1'              'Prd Order' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
    PERFORM build_field USING 'SERNR'               'BOM expl.number' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  ENDIF.
  PERFORM build_field USING 'KWMENG'              TEXT-130 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'VRKME'               TEXT-131 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZZ_SORTORDER'        TEXT-132 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZZASSORTDT'          TEXT-133 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'KUNNR_SH'            TEXT-134 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'KUNNR_SP'            TEXT-135 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'VBELN_DL'            TEXT-136 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ERDAT'               TEXT-137 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LFIMG'               TEXT-138 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'OPEN_QTY'            TEXT-139 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'SO_PRICE'            TEXT-140 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'SO_VALU'             TEXT-141 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'BZTXT'               TEXT-142 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BZIRK'               TEXT-143 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FINAL_SEG'           TEXT-405 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'MKT_SEG'             TEXT-407 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'VKBUR_TEXT'          TEXT-145 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'VKGRP_TEXT'          TEXT-146 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'KDMAT'               TEXT-147 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZZKVGR1_TEXT'        TEXT-148 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZZTRADENM'           TEXT-149 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZREQ_NO'             TEXT-150 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'AGE_DEL'             TEXT-151 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'AGE_ASORT'           TEXT-152 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZSTAT'               TEXT-153 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SO_STATUS'           TEXT-154 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZZPPCMTDT'           TEXT-155 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'STK_PRICE'           TEXT-156 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'STK_VALUE'           TEXT-157 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'ORG_AUART'           TEXT-158 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ORG_SONO'            TEXT-159 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ORG_SOLINE'          TEXT-160 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'AGE_BATCH'           TEXT-161 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
*  PERFORM build_field USING 'AGE_BATCH1'          TEXT-471 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'AGE_WM'              TEXT-162 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DEV_NO'              TEXT-380 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DEV_LINE'            TEXT-381 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'MOU_ORDER'           TEXT-382 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'AGE_PPCDT'           TEXT-383 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZZCUSREQD'           TEXT-384 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'AGE_CRDT'            TEXT-385 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WO_NO'               TEXT-386 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'MBLNR'               TEXT-163 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZEILE'               TEXT-164 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BWART'               TEXT-165 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'EBELN'               TEXT-166 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PURSTS'              TEXT-399 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BANFN'               TEXT-360 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  IF s_werks-low = '1062' OR s_werks-low = '2426'.   " Dev id - 0001 Added By Rahul Koshti plant- 2426
    PERFORM build_field USING 'BEDNR'               TEXT-476 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos. " added by hiren and sanskriti
  ENDIF.
  PERFORM build_field USING 'PR_CREATOR'          TEXT-361 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'AUFNR'               TEXT-167 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'POSTAT'              TEXT-401 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'KDAUF'               TEXT-168 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PSTYP_TEXT'          TEXT-169 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BWTAR'               TEXT-170 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PO_TEXT'             TEXT-171 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZINVOINO'            TEXT-172 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZINVOIDT'            TEXT-173 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZGATEENTRYNO'        TEXT-175 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZENTRYDATE'          TEXT-176 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'METER_KG'            TEXT-177 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'VMSAV'               TEXT-178 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'SUPPLY_NAME'         TEXT-179 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PRUEFLOS'            TEXT-180 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PCK_LENGTH'          TEXT-182 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SELF_LIFE'           TEXT-183 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'HSDAT'               TEXT-184 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  "Insert by Sushen on 25.12.2024++,Dev id:6066,Reqby Parth
  PERFORM build_field USING 'MFAGING'             'Manufactur Aging Days' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.

  PERFORM build_field USING 'ROLL_NO'             TEXT-185 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'TTL_DEFECT'          TEXT-186 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'TTL_POINT'           TEXT-187 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FORM_PACK'           TEXT-188 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WARP_COUNT'          TEXT-189 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WEFT_COUNT'          TEXT-190 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ON_LOOM_EPI'         TEXT-191 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'ON_LOOM_PPI'         TEXT-192 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'REED_SPACE'          TEXT-193 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WAVE'                TEXT-194 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LAB_DIP_NO'          TEXT-195 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FINISH_GSM'          TEXT-196 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SHADE_COMNT'         TEXT-197 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'USEABLE_WIDTH'       TEXT-198 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BIG_ROLLNO'          TEXT-199 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WP_MAT1'             TEXT-200 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WP_MAT2'             TEXT-201 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WP_MAT3'             TEXT-202 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WP_MAT4'             TEXT-203 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WF_MAT1'             TEXT-204 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WF_MAT2'             TEXT-205 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WF_MAT3'             TEXT-206 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WF_MAT4'             TEXT-207 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'AIR_PERMIT'          TEXT-208 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'KTCH_PCK_SLP'        TEXT-210 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'CHART_PRFX'          TEXT-211 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'CHART_NO'            TEXT-212 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PIECE_LENGTH'        TEXT-213 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DESIGN_NO'           TEXT-214 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'TYPE_BAG'            TEXT-215 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'NO_RINGS'            TEXT-216 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LENGTH_BAG'          TEXT-217 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DIA_BAD'             TEXT-218 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'TTL_THIK_MM'         TEXT-219 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DIA'                 TEXT-220 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'GAUGE'               TEXT-362 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'OPN_WTH_TUBLR'       TEXT-221 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'STRUCTURE'           TEXT-222 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DIMENSION'           TEXT-223 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LENGTH'              TEXT-224 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PROFILE_COLOR'       TEXT-225 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FR_NFR'              TEXT-226 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'UV_NUV'              TEXT-227 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'RESIN_CODE'          TEXT-228 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'TYPE'                TEXT-229 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WT_HAND_MOLD'        TEXT-230 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WIDTH'               TEXT-231 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'AREA_1PC'            TEXT-232 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WT_PR_GRATING'       TEXT-233 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FAB_NAME_SLNO'       TEXT-234 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WARP_ABLE_CODE'      TEXT-235 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'KNOTABL_CODE'        TEXT-236 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'NO_ENDS'             TEXT-237 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FIBR_COMP'           TEXT-238 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SURFACE_FINISH'      TEXT-239 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'CHEM_FINSH'          TEXT-240 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'OEM_NAME'            TEXT-241 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DEV_SMPL_REF'        TEXT-242 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FORM_DENSITY'        TEXT-243 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SCRIM_GSM'           TEXT-244 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FORM_THIK_MM'        TEXT-245 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BALE_ROLL'           TEXT-246 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BEAM_FALL'           TEXT-247 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'CREEL'               TEXT-248 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SHADE_CODE'          TEXT-249 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FINISH_CODE'         TEXT-250 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PRINT_CODE'          TEXT-251 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PHYCL_BEAM_NO'       TEXT-252 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PHYCL_BEAM_GR'       TEXT-253 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'YARN_USE'            TEXT-254 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ROPE_SLASHER'        TEXT-255 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ARM_DTLS'            TEXT-256 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BORDER'              TEXT-257 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'COATING'             TEXT-258 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'COMBO_NAME'          TEXT-259 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DIAMETER'            TEXT-260 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'HEIGHT'              TEXT-262 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SHADE_COLOUR'        TEXT-263 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'CONT_NAME'           TEXT-264 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'NOW_ROL_NO'          TEXT-265 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'NOW_BAL_NO'          TEXT-266 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'CT_Y_NY_DYED'        TEXT-267 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'VERIETY'             TEXT-268 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'MCHIN_LOOM_NO'       TEXT-269 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WEAVING_PLANT'       TEXT-270 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SIZE_SET_NO'         TEXT-271 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WT_WARP'             TEXT-272 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WT_WEFT'             TEXT-273 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'INSP_RMK'            TEXT-274 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'INSPTOR_NAME'        TEXT-275 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WARP_SUPPLY'         TEXT-276 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WARP_LOT_NO'         TEXT-277 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WEFT_SUPPLY'         TEXT-278 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WEFT_LOT_NO'         TEXT-279 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'INITIAL_TAG'         TEXT-280 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FINAL_TAG'           TEXT-281 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BLEND'               TEXT-282 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SHADE_LOT'           TEXT-283 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SHADE_GR'            TEXT-284 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WASH_LOT'            TEXT-285 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WDITH_ETE'           TEXT-287 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'POINT_PR_100SQM'     TEXT-289 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'POINT_PR_100SQY'     TEXT-290 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'NO_PIECE'            TEXT-291 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WASH_SHADE'          TEXT-292 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'UNWASH_SHADE'        TEXT-293 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SET_CODE'            TEXT-294 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WASH_STATUS'         TEXT-295 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WIP_BTCH_NO'         TEXT-296 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'INSPTOR_1'           TEXT-297 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'INSPTOR_2'           TEXT-298 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'GROSS_WT'            TEXT-299 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'NET_WT'              TEXT-300 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ACTUAL_GLM'          TEXT-301 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'GC_FENTS_RMK'        TEXT-302 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'STAND_GLM'           TEXT-303 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'GREIGE_GSM'          TEXT-304 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'STICH_LENGTH'        TEXT-305 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'VARIANCE'            TEXT-306 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'VARIANCE_P'          TEXT-307 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'GRIG_ISSU_QTY'       TEXT-315 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'SO_LINE'             TEXT-316 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'GRIG_PLN_QTY'        TEXT-317 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'STEUC'               TEXT-318 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'OLD_MTRL_NO'         TEXT-319 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ORGANIC_CERTIFKT'    TEXT-320 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'KUNNR_BILL'          TEXT-321 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'KUNNR_BILL_NAME'     TEXT-322 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'MIX_DTLS'            TEXT-323 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'KG_CONE'             TEXT-324 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'RPN'                 TEXT-325 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DYLNO'               TEXT-326 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'REMARK'              TEXT-327 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'WRP_BRK'             TEXT-328 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'KG_METER'            TEXT-329 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'YARN1'               TEXT-330 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'YARN2'               TEXT-331 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'YARN3'               TEXT-332 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'YARN4'               TEXT-333 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SZG_BTCH'            TEXT-334 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SZG_SET_SL'          TEXT-335 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DYEING_MC'           TEXT-336 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BRK_COMB1'           TEXT-337 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BRK_COMB2'           TEXT-338 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BRK_COMB3'           TEXT-339 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LAPR1'               TEXT-340 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LAPR2'               TEXT-341 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'LAPR3'               TEXT-342 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'OPERATOR'            TEXT-343 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ROPE_NO1'            TEXT-344 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ROPE_NO2'            TEXT-345 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ROPE_NO3'            TEXT-346 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ROPE_NO4'            TEXT-347 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'QLTY_DEGRAD'         TEXT-348 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ISU_LT_NO1'          TEXT-349 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ISU_LT_NO2'          TEXT-350 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ISU_LT_NO3'          TEXT-351 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ISU_LT_NO4'          TEXT-352 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'NEPB'                TEXT-353 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BLW1'                TEXT-354 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BLW2'                TEXT-355 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BLW3'                TEXT-356 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'BLW4'                TEXT-357 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'MAT_CAT'             TEXT-358 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'MAT_DRGNO'           TEXT-359 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'STITCH'              TEXT-363 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FREE1'               TEXT-364 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FREE2'               TEXT-365 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FREE3'               TEXT-366 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FREE4'               TEXT-367 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'FREE5'               TEXT-368 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'QTY_YRD'             TEXT-369 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'SHD_COLR_TEXT'       TEXT-370 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'YARN1_DESC'          TEXT-371 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'YARN2_DESC'          TEXT-372 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'YARN3_DESC'          TEXT-373 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'YARN4_DESC'          TEXT-374 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'GRY_PEND_ISSUE'      TEXT-375 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'LAST_ISSUE_DT'       TEXT-376 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'TT_SO_STOCK'         TEXT-377 'GT_FINAL' '25' '' '' '' '' '' '' ''  CHANGING gv_colpos. """"
  PERFORM build_field USING 'DEFECT_CODE'         TEXT-379 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'DT_DOCLN'            TEXT-387 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'UNLOADING'           TEXT-404 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos. " Added by Shashank on 06th Feb 2020
  PERFORM build_field USING 'PROD_CAT'            TEXT-406 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PROD_CAT_DESC'       TEXT-406 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'K_NO'                TEXT-408 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'VEDIND'              TEXT-410 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PR_L1APPROVE'        TEXT-411 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'SORT_CAT'            TEXT-472 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'PROJ_ATWRT'          TEXT-473 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos. " added Harshad 02-06-21 Aditya Vora
  PERFORM build_field USING 'CUST_ATWRT'          TEXT-474 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos. " added Harshad 02-06-21
  PERFORM build_field USING 'MASS_ATWRT'          TEXT-475 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos. " added Harshad 02-06-21
  PERFORM build_field USING 'ZTP'          TEXT-777 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos. " SOC : 4414
  PERFORM build_field USING 'WBS_ELE'          'WBS Element' 'GT_FINAL' '15' '' '' '' '' '' '' ''  CHANGING gv_colpos. "Dev id :4298
*************************************************************Soc By DevId-4728
  PERFORM build_field USING 'K_FS'               'Fabric Structure' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'K_FB'               'Fabric Blend%' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
*************************************************************Eoc By DevId-4728
*------------------------------------------->Soc By Devid-5287
  PERFORM build_field USING 'ZWASH_STATUS'      'Wash status' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZWASH_LOT_NO'      'Wash Lot Number' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZWASH_SHADE_BLOCK'      'Wash Shade block' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZUNWASH_SHADE_BLOCK'      'Unwash Shade block' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZTAPPER_SEQ'      'Tapper sequence' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZNET_WT'      'Net Weight' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZGROSS_WT'      'Gross Weight' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZWASH_COUNTER'      'Wash counter' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZDPT_SYD'      'Dpt/100 syd' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZINT_TAG'      'Initial tag' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZBATCH_STATUS'      'Batch status' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZWASH_TARGET'      'Wash target' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZMC_NO'      'M/C No.' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
  PERFORM build_field USING 'ZNET_WIDTH'      'Net Width' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
*------------------------------------------->Eoc By Devid-5287
*****************************soc 6216 add by saxi**************************
  IF r1 = 'X'.
    PERFORM build_field USING 'K_NS'      'No of Separator' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
    PERFORM build_field USING 'K_TS'      'Type of Package' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos.
    PERFORM build_field USING 'W_KSLN'    'Finishing Group Number' 'GT_FINAL' '40' '' '' '' '' '' '' ''  CHANGING gv_colpos."**Added by Devid - 6712
  ENDIF.
*************************eoc 6216  add by saxi*****************************
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  BUILD_TOP_OF_PAGE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM build_top_of_page .
  DATA : lv_info  TYPE slis_entry.
  DATA : lv_lines TYPE slis_entry.
  DATA:  lv_time  TYPE char10 .

  lv_info = 'Plant Wise Stock Details Report'.
  PERFORM build_heading USING 'H'  ''                     CHANGING lv_info .
  CLEAR: lv_info .
  CONCATENATE sy-datum+6(2) '.' sy-datum+4(2) '.' sy-datum+0(4) INTO lv_info .
  CONDENSE lv_info .
  PERFORM build_heading USING 'S'  'Run Date-'            CHANGING lv_info .
  CLEAR: lv_info .
  WRITE: sy-uzeit TO lv_time USING EDIT MASK '__:__:__'.
  lv_info = lv_time .
  PERFORM build_heading USING 'S'  'Run Time-'            CHANGING lv_info .
  lv_info = s_werks-low.

  IF c2 IS INITIAL AND c3 IS INITIAL.                   " If data direct show
    PERFORM build_heading USING 'S'  'Plant-'              CHANGING lv_info.
    lv_info = s_lgort-low.
    PERFORM build_heading USING 'S'  'Storage Location-'   CHANGING lv_info.
  ELSEIF c2 IS NOT INITIAL OR c3 IS NOT INITIAL .      " If data get from application server
    lv_info = po_varnt .
    PERFORM build_heading USING 'S'  'Variant Name-'        CHANGING lv_info.
  ENDIF.


  DESCRIBE TABLE gt_final .
  lv_info = sy-tfill.
  PERFORM build_heading USING 'S' 'Total No of Records-' CHANGING lv_info.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_DATA_PART5
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM insert_data_part5 .

* ------------ Variance & Its Perccentage --------------*
  TRY .
      gw_final-variance   = gw_final-stand_glm - gw_final-actual_glm .
      gw_final-variance_p = gw_final-variance / gw_final-stand_glm .

    CATCH cx_sy_zerodivide .
  ENDTRY.

* ------------ Return Sales Order/ Line --------------*
  IF gw_final-vbeln IS NOT INITIAL AND gw_final-posnr IS NOT INITIAL.
    CLEAR:gw_vbkd.

    READ TABLE gt_vbkd INTO gw_vbkd WITH KEY vbeln = gw_final-vbeln
                                             posnr = gw_final-posnr  BINARY SEARCH .
    IF sy-subrc NE 0.
      READ TABLE gt_vbkd INTO gw_vbkd WITH KEY vbeln = gw_final-vbeln BINARY SEARCH. " Add On 12-12-2019
    ENDIF.
    IF gw_vbkd IS NOT INITIAL.
      gw_final-wo_no = gw_vbkd-bstkd_e .          " Add on 27-06-2019

      SHIFT gw_vbkd-posex_e LEFT DELETING LEADING '0'.
      SHIFT gw_vbkd-bstkd_e LEFT DELETING LEADING '0'.

      IF gw_vbkd-posex_e IS NOT INITIAL AND gw_vbkd-bstkd_e IS NOT INITIAL.
        CONCATENATE gw_vbkd-bstkd_e '/' gw_vbkd-posex_e INTO gw_final-kdauf .
        CONDENSE gw_final-kdauf .
      ELSEIF gw_vbkd-posex_e IS NOT INITIAL.
        gw_final-kdauf = gw_vbkd-posex_e .
      ELSEIF  gw_vbkd-bstkd_e IS NOT INITIAL.
        gw_final-kdauf = gw_vbkd-posex_e .
      ENDIF.
    ENDIF."IF gw_vbkd IS NOT INITIAL.
  ENDIF.
* ------------ Trade Name for 1021 Get from Charactaristic --------------*
  IF gw_final-werks EQ '1021'.
    CLEAR: gw_final-zztradenm .
    gw_final-zztradenm = gw_final-trd_name .
  ENDIF.
*------------ Left Deleting leding Zero ---------------------------------*
  SHIFT gw_final-matnr LEFT DELETING LEADING '0'.

**------------ Material Sort description ---------------------------------*
*  IF gw_final-matnr IS NOT INITIAL.
*    CLEAR: lv_name,lv_con_id.
*
*    lv_name = gw_final-matnr.
*    REFRESH lt_line.
*
*    CALL FUNCTION 'READ_TEXT'
*      EXPORTING
*        client                  = sy-mandt
*        id                      = lc_id4
*        language                = lc_lan
*        name                    = lv_name
*        object                  = lc_material
*      TABLES
*        lines                   = lt_line
*      EXCEPTIONS
*        id                      = 1
*        language                = 2
*        name                    = 3
*        not_found               = 4
*        object                  = 5
*        reference_check         = 6
*        wrong_access_to_archive = 7
*        OTHERS                  = 8.
*    IF lt_line[] IS NOT INITIAL.
*      LOOP AT lt_line INTO DATA(lw_line).
*        CONCATENATE lv_con_id lw_line-tdline INTO lv_con_id.
*        CLEAR lw_line.
*      ENDLOOP.
*    ENDIF.
*    gw_final-prd_desc = lv_con_id.
*  ELSEIF lw_sales-spart NE lc_divi-15.
*    gw_final-prd_desc = lw_sales-arktx.
*  ENDIF.
*ENDIF.

*---------------Add on 11-12-2018: Quantity in Yard ------------------------------*
  IF gw_final-menge IS NOT INITIAL AND gw_final-meins EQ 'M' ." OR
    gw_final-qty_yrd = gw_final-menge * gc_yard  .

  ELSEIF gw_final-btch_aum_qty IS NOT INITIAL AND gw_final-btch_aum_uom EQ 'M' .
    gw_final-qty_yrd = gw_final-btch_aum_qty * gc_yard  .

  ENDIF.

*-----------------------------------------------------------------------------------*
*  Add on 11-12-2018: Weaving plant for 1012 plant as per rqst by Pinky & sanjoy
*-----------------------------------------------------------------------------------*
  IF gw_final-werks EQ '1012'.

    "~~~~~~~~~ Weaving Plant~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
    IF gw_final-weaving_plant IS INITIAL AND gw_final-mchin_loom_no IS NOT INITIAL AND
                                             gw_final-mchin_loom_no NA gc_spcl_char.

      SELECT SINGLE c~stand, c~veran,
                  d~ktext AS t1,
                  e~ktext AS t2
          FROM kako AS a
           INNER JOIN ( crca AS b INNER JOIN crhd AS c ON b~objty EQ c~objty AND b~objid EQ c~objid AND
                              c~werks EQ @gw_final-werks ) ON a~kapie EQ b~kapid
           LEFT OUTER JOIN tc24  AS d ON c~veran EQ d~veran AND d~werks EQ @gw_final-werks
           LEFT OUTER JOIN t499s AS e ON c~stand EQ e~stand AND e~werks EQ @gw_final-werks

         INTO @DATA(lv_kako)
         WHERE a~name  EQ @gw_final-mchin_loom_no+0(8) ."AND
*               a~werks EQ @gw_mseg-werks.

      IF sy-subrc EQ 0 .
        gw_final-weaving_plant  = lv_kako-t1.               " Waveing Plant
*        gw_final-wave_dpart = lv_kako-t2.               " Waving Depertment
      ENDIF.
    ENDIF. " IF gw_final-weaving_plant IS INITIAL

  ENDIF.  " IF gw_final-werks EQ '1012'.

*---------------------------------------------------------------------------------*
*  Add On 07-01-2019: 1)Pending Grey issue 2)Last issue date 3)Total stock against Sales order
*---------------------------------------------------------------------------------*
  IF gw_final-werks EQ '1012' AND gw_final-matkl IN rt_issue_matkl.
    gw_final-gry_pend_issue = gw_final-grig_pln_qty - gw_final-grig_issu_qty .
  ENDIF.

*--------------***>>> Unit conversion  <<<***-------------------------------------*

  IF gw_final-meins IS NOT INITIAL.
    CALL FUNCTION 'CONVERSION_EXIT_CUNIT_OUTPUT'
      EXPORTING
        input          = gw_final-meins
        language       = sy-langu
      IMPORTING
        output         = gw_final-meins
      EXCEPTIONS
        unit_not_found = 1
        OTHERS         = 2.
  ENDIF.

*--------------***>>> Batch Aum for COmposit Materila GRP PSF & GRS <<<***----------*
  IF gw_final-menge IS NOT INITIAL AND ( gw_matnr-matkl EQ 'PSF' OR gw_matnr-matkl EQ 'GRS' ).

    CLEAR: gw_ppbatch,gt_btch_char_tab[].

    SORT gt_ppmatch BY matnr cuobj .
    READ TABLE gt_ppmatch INTO gw_ppmatch WITH KEY matnr = gw_matnr-matnr
                                                   cuobj = gw_matnr-cuobj BINARY SEARCH .

    IF sy-subrc EQ 0 AND gw_ppmatch-char_tab[] IS NOT INITIAL.

      TRY .
          gt_btch_char_tab[] = gw_ppmatch-char_tab[] .
          SORT gt_btch_char_tab[] BY atnam .
          CASE gw_matnr-matkl.
            WHEN 'GRS'.
              READ TABLE gt_btch_char_tab[] ASSIGNING FIELD-SYMBOL(<fs_char>) WITH KEY atnam = 'C_WTSQ' BINARY SEARCH.
              IF sy-subrc EQ 0 AND <fs_char> IS ASSIGNED.
                gw_final-btch_aum_qty = gw_final-menge * <fs_char>-atwrt .
                gw_final-btch_aum_uom = 'KG'.
              ENDIF.
            WHEN 'PSF'.
              READ TABLE gt_btch_char_tab[] ASSIGNING <fs_char> WITH KEY atnam = 'C_WKMC' BINARY SEARCH.
              IF sy-subrc EQ 0 AND <fs_char> IS ASSIGNED.
                gw_final-btch_aum_qty = gw_final-menge * <fs_char>-atwrt .
                gw_final-btch_aum_uom = 'KG'.
              ENDIF.
          ENDCASE.
        CATCH cx_sy_zerodivide .
        CATCH cx_sy_conversion_no_number .
        CATCH cx_sy_arithmetic_overflow.
      ENDTRY.
    ENDIF.
  ENDIF.

*--------------***>>> Batch 315 Latest Data <<<***----------*
  IF gt_mseg_315 IS NOT INITIAL.
    CLEAR:gw_mseg_315.
    READ TABLE gt_mseg_315 INTO gw_mseg_315 WITH KEY werks = gw_final-werks
                                                     matnr = gw_final-matnr
                                                     charg = gw_final-charg BINARY SEARCH.
    IF sy-subrc EQ 0.
      gw_final-dt_docln = |{ gw_mseg_315-cpudt DATE = ENVIRONMENT }|
                         && |/| && gw_mseg_315-mblnr && |-| && gw_mseg_315-zeile .
    ENDIF."READ TABLE gt_mseg_315 INTO gw_mseg_315

  ENDIF." IF gt_mseg_315 is NOT INITIAL.



ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SCREEN_MODIFY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM screen_modify .

*  ******************************************->Soc By DevId-4619

  SELECT SINGLE * FROM zpp_wps_auth
           INTO @DATA(lw_wps_auth)
           WHERE user_id = @sy-uname
           AND active = 'Y' .
  IF sy-subrc EQ 0.
    DATA(lw_flg) = 'X' .
  ENDIF.

  LOOP AT SCREEN .
    IF lw_flg IS NOT INITIAL.
      IF screen-group1  = 'A1'.
        screen-active = 1 .
        screen-input = 1 .
      ENDIF .
    ELSE.
      IF screen-group1  = 'A1'.
        screen-active = 0 .
        screen-input = 0 .
      ENDIF .
    ENDIF.
    MODIFY SCREEN.
  ENDLOOP.
******************************************->Eoc BY DevId-4619

  CASE gv_user_flag .
*  CASE sy-uname.
*    WHEN 'V00011' OR 'V00008' OR 'VC_PREPROD' OR 'VCERP_ABAP'.
    WHEN 'X'.
      LOOP AT SCREEN.
        CASE screen-name.
          WHEN 'R4' OR 'R5'.
            IF c2 IS INITIAL AND c3 IS INITIAL.
              screen-active = 0 .
              CLEAR:r5.
              r4 = 'X'.
            ENDIF.
        ENDCASE.
        MODIFY SCREEN.
      ENDLOOP.

    WHEN OTHERS.
      LOOP AT SCREEN.
        CASE screen-name.
          WHEN 'C1'.
            screen-active = 0 .
          WHEN 'R4' OR 'R5'.
            IF c2 IS INITIAL AND c3 IS INITIAL.
              screen-active = 0 .
              CLEAR:r5.
              r4 = 'X'.
            ENDIF.
        ENDCASE.
        MODIFY SCREEN.
      ENDLOOP.
  ENDCASE.
*****Added by V00041 on 15.02.2022 req by Bhavin
  SELECT SINGLE zactive
  FROM ztmm_param
  INTO @DATA(lv_flg)
  WHERE zparam1 = 'ZMM_REPORTS'
    AND zparam2 = 'MM_REPORTS'
    AND zvalue = @sy-uname.
  IF lv_flg = abap_false.
    LOOP AT SCREEN.
      IF screen-group1 = 'M4'.
        screen-input = 0.
      ENDIF.
      MODIFY SCREEN.
    ENDLOOP.
    CLEAR : p_dlist, p_subj.
  ENDIF.
****************  EOC

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CHECK_VALIDATION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM check_validation .

  "----------------Soc By Devid-4619
  IF p_send = 'X' AND p_key IS INITIAL .
    MESSAGE 'Please enter P-key' TYPE 'E'.
  ENDIF.
  "----------------Eoc By Devid-4619

  IF sy-ucomm EQ 'ONLI'.
    IF r1 EQ 'X' OR r3 EQ 'X'.
      IF s_lgort[] IS INITIAL .
*        MESSAGE 'Please Enter Storage Location / Storage Location Group ' TYPE 'E'.
        MESSAGE 'Please Enter Storage Location ' TYPE 'E'.
      ENDIF.
    ELSEIF r2 EQ 'X'.
      IF s_lgnum[] IS INITIAL.
        MESSAGE 'Please Enter Warehouse Number' TYPE 'E'.
      ENDIF.
    ENDIF.
  ENDIF.

  IF c1 IS NOT INITIAL.
    CLEAR: c2,c3.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CONCATENATE_BRAND_DESC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GV_ORDER  text
*      -->P_GV_LINE  text
*      <--P_GV_CONCAT  text
*----------------------------------------------------------------------*
FORM concatenate_brand_desc  USING    p_order TYPE char3
                                      p_line  TYPE char20
                             CHANGING p_concat TYPE char30.
  CLEAR:p_concat .
  IF p_line IS NOT INITIAL.
    SHIFT p_line LEFT DELETING LEADING '0'.
  ENDIF.
  IF p_order IS NOT INITIAL AND p_line IS NOT INITIAL.
    CONCATENATE p_order '-' p_line INTO p_concat .
  ELSEIF p_order IS NOT INITIAL .
    p_concat = p_order .
  ELSEIF p_line IS NOT INITIAL .
    p_concat = p_line.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  STNDR_PRICE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_L_PRICE_MTVFP  text
*----------------------------------------------------------------------*
*FORM stndr_price  USING    p_mtvfp TYPE char2
*                           p_vprsv TYPE char1,
*                           p_stprs TYPE
*                           p_verpr TYPE
*  CLEAR: gw_final-stk_price .
*
*  CASE p_mtvfp.
*    WHEN '02'.
*      gw_final-stk_price = l_price-stprs / l_price-peinh.
*    WHEN OTHERS.
*      IF p_vprsv EQ 'S'.
*        gw_final-stk_price = l_price-stprs.
*      ELSEIF p_vprsv EQ 'V'.
*        gw_final-stk_price = l_price-verpr.
*      ENDIF.
*  ENDCASE.
*  CLEAR: p_mtvfp.
*ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CONCATENATE_ORDER_LINE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GV_ORDER  text
*      -->P_GV_LINE  text
*      <--P_GV_CONCAT  text
*----------------------------------------------------------------------*
FORM concatenate_order_line  USING    p_order TYPE char30
                                      p_line  TYPE char30
                             CHANGING p_concat TYPE char30.
  CLEAR:p_concat .
  IF p_line IS NOT INITIAL.
    SHIFT p_line LEFT DELETING LEADING '0'.
  ENDIF.
  IF p_order IS NOT INITIAL AND p_line IS NOT INITIAL.
    CONCATENATE p_order '/' p_line INTO p_concat .
  ELSEIF p_order IS NOT INITIAL .
    p_concat = p_order .
  ELSEIF p_line IS NOT INITIAL .
    p_concat = p_line.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  USER_NAME
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GW_EBAN_ERNAM  text
*      <--P_GW_FINAL_PR_CREATOR  text
*----------------------------------------------------------------------*
FORM user_name USING p_code TYPE user CHANGING p_name TYPE ad_name1.
  CHECK p_code IS NOT INITIAL .
  CLEAR: p_name .
  READ TABLE gt_usr21 INTO gw_usr21 WITH KEY bname = p_code BINARY SEARCH.
  IF sy-subrc EQ 0.
    p_name = gw_usr21-name_text .
  ENDIF.
  CLEAR: sy-subrc, p_code .
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CONVERSION_UNIT_SALES
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_<FS_UOM>_VRKME  text
*      <--P_GW_FINAL_BTCH_AUM_UOM  text
*----------------------------------------------------------------------*
FORM conversion_unit_sales USING p_vrkme TYPE vrkme CHANGING p_uom TYPE vrkme.
  CALL FUNCTION 'CONVERSION_EXIT_CUNIT_OUTPUT'
    EXPORTING
      input          = p_vrkme
      language       = sy-langu
    IMPORTING
      output         = p_uom
    EXCEPTIONS
      unit_not_found = 1
      OTHERS         = 2.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  UPLOAD_TO_SERVR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM upload_to_servr .

*  DATA: l_file TYPE string .
  DATA: l_char TYPE string.
  CLEAR:l_index,l_char.

*  IF l_file IS INITIAL.
*    CONCATENATE s_werks-low '_' s_lgort-low sy-datum sy-uzeit '.txt' INTO l_file .
*    CONDENSE l_file.
*  ENDIF.

**  CASE sy-mandt. " commented HARSHAD 28-06-21
**    WHEN 110.
**      CONCATENATE l_dfile l_file INTO l_file.
**      CONDENSE l_file .
**    WHEN 200.
**      CONCATENATE l_qfile l_file INTO l_file.
**      CONDENSE l_file .
**    WHEN 300 OR 310.
**      CONCATENATE l_pfile l_file INTO l_file.
**      CONDENSE l_file .
**  ENDCASE.

  CASE sy-sysid. " Added HARSHAD 28-06-21
    WHEN 'ATD'. " OR 'ATD110'.
      CONCATENATE l_dfile l_file INTO l_file.
      CONDENSE l_file .
    WHEN 'ATQ'.
      CONCATENATE l_qfile l_file INTO l_file.
      CONDENSE l_file .
    WHEN 'ATP'.
      CONCATENATE l_pfile l_file INTO l_file.
      CONDENSE l_file .
  ENDCASE.

  IF l_file IS NOT INITIAL.
    TRY .
        OPEN DATASET l_file FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
        IF sy-subrc NE 0.
          EXIT.
        ENDIF.


        LOOP AT gt_final ASSIGNING FIELD-SYMBOL(<l_final>).

          l_index = 1 .
          DO  .
            ASSIGN COMPONENT l_index OF STRUCTURE <l_final> TO <l_data> .
            IF sy-subrc NE 0.
              TRANSFER l_string TO l_file.
              EXIT .
            ENDIF.
            l_char = <l_data> .

            CASE l_index.
              WHEN 1.
                l_string = l_char .
              WHEN OTHERS.
                CONCATENATE l_string '#$#' l_char INTO  l_string.
                CONDENSE l_string .
            ENDCASE.
            l_index = l_index + 1 .
            CLEAR:l_char.
          ENDDO.
        ENDLOOP.
        CLOSE DATASET l_file.

*        BREAK-POINT .
        PERFORM mail_send USING 'E'.
      CATCH cx_sy_file_authority .                   " if not Authorize
    ENDTRY.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  DOWNLOAD_FROM_SERVR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM download_from_servr .
  TYPES:BEGIN OF ty_time,
          file   TYPE char90,
          date   TYPE sy-datum,
          time   TYPE sy-timlo,
          chnage TYPE c,
        END OF ty_time.

*  DATA: l_file TYPE string.
  DATA: l_char1 TYPE string,
        l_char2 TYPE string,
        l_dir   TYPE eps2filnam,
        l_yr    TYPE char4,
        l_mth   TYPE c LENGTH 2,
        l_dy    TYPE c LENGTH 2,
        l_day   TYPE char10.

  DATA: lt_dir        TYPE STANDARD TABLE OF eps2fili,

        lt_time       TYPE STANDARD TABLE OF ty_time,
        lw_time       TYPE ty_time,

        l_time_stmp   TYPE char30,
        lv_time_stamp TYPE tzonref-tstamps.

  DATA: l_table TYPE RANGE OF char90 WITH HEADER LINE.

  FIELD-SYMBOLS: <fs_final> TYPE ty_final,
                 <fs_char>  TYPE data.

  CLEAR:l_index,l_char1,l_char2,l_file.

  IF l_file IS INITIAL.

    IF po_varnt IS NOT INITIAL .
      CONCATENATE po_varnt '_AM.TXT' INTO l_file .
      CONDENSE l_file.
      l_table-sign   = 'I'.
      l_table-option = 'EQ'.
      l_table-low    = l_file .
      APPEND l_table.
      CLEAR: l_table-low,l_file.

      CONCATENATE po_varnt '_PM.TXT' INTO l_file .
      CONDENSE l_file.
      l_table-low = l_file .
      APPEND l_table.
      CLEAR: l_table,l_file.
*
*    IF s_werks-low IS NOT INITIAL AND s_lgort-low IS NOT INITIAL.
*
*      CONCATENATE s_werks-low '_' s_lgort-low '_AM.TXT' INTO l_file .
*      CONDENSE l_file.
*      l_table-sign   = 'I'.
*      l_table-option = 'EQ'.
*      l_table-low    = l_file .
*      APPEND l_table.
*      CLEAR: l_table-low,l_file.
*
*      CONCATENATE s_werks-low '_' s_lgort-low '_PM.TXT' INTO l_file .
*      CONDENSE l_file.
*      l_table-low = l_file .
*      APPEND l_table.
*      CLEAR: l_table,l_file.

**      CASE sy-mandt. " Commneted by Harshad 28-06-21
**        WHEN 110.
**          CONCATENATE l_dfile l_file INTO l_file .
**          CONDENSE l_file .
**        WHEN 200.
**          CONCATENATE l_qfile l_file INTO l_file .
**          CONDENSE l_file .
**        WHEN 300 OR 310.
**          CONCATENATE l_pfile l_file INTO l_file .
**          CONDENSE l_file .
**      ENDCASE.

      CASE sy-sysid. " Added HARSHAD 28-06-21
        WHEN 'ATD'. "100' OR 'ATD110'.
          CONCATENATE l_dfile l_file INTO l_file.
          CONDENSE l_file .
        WHEN 'ATQ'.
          CONCATENATE l_qfile l_file INTO l_file.
          CONDENSE l_file .
        WHEN 'ATP'.
          CONCATENATE l_pfile l_file INTO l_file.
          CONDENSE l_file .
      ENDCASE.

      l_dir = l_file .

      CALL FUNCTION 'EPS2_GET_DIRECTORY_LISTING'
        EXPORTING
          iv_dir_name            = l_dir
        TABLES
          dir_list               = lt_dir
        EXCEPTIONS
          invalid_eps_subdir     = 1
          sapgparam_failed       = 2
          build_directory_failed = 3
          no_authorization       = 4
          read_directory_failed  = 5
          too_many_read_errors   = 6
          empty_directory_list   = 7
          OTHERS                 = 8.
      IF sy-subrc NE 0.
        MESSAGE 'No file Found' TYPE 'I' DISPLAY LIKE 'E'.
        EXIT.
      ENDIF.

      IF lt_dir[] IS NOT INITIAL.
        DELETE lt_dir[] WHERE name NOT IN l_table[] .
        CLEAR:l_table[].
      ENDIF.

      IF lt_dir[] IS INITIAL.
        MESSAGE ' No data Found' TYPE 'S' DISPLAY LIKE 'E'.
        LEAVE LIST-PROCESSING.
        EXIT.
      ENDIF.

      LOOP AT lt_dir INTO DATA(lw_dir).
        lw_time-file = lw_dir-name .
        l_time_stmp = lw_dir-mtim.

        REPLACE ALL OCCURRENCES OF '.' IN l_time_stmp WITH ''.
        REPLACE ALL OCCURRENCES OF ':' IN l_time_stmp WITH ''.
        CONDENSE l_time_stmp NO-GAPS.

        l_dy  = l_time_stmp+0(2).
        l_mth = l_time_stmp+2(2).
        l_yr  = l_time_stmp+4(4).
        CONCATENATE l_yr l_mth l_dy INTO l_day .
        CONDENSE l_day NO-GAPS.

        lw_time-date = l_day .
        lw_time-time = l_time_stmp+8(6).

        APPEND lw_time TO lt_time.
        CLEAR:lw_time,l_time_stmp,l_dy,l_mth,l_yr.
      ENDLOOP.

*-------------------------------------------------------
      IF c2 IS NOT INITIAL.
        SORT lt_time BY date DESCENDING time DESCENDING.
        READ TABLE lt_time INTO lw_time INDEX 1 .
      ELSEIF c3 IS NOT INITIAL.
        SORT lt_time BY date time .
        READ TABLE lt_time INTO lw_time INDEX 1 .
      ENDIF.

      IF sy-subrc EQ 0.
        CLEAR:l_file.
        l_file = lw_time-file .
*        CASE sy-mandt.
*          WHEN 110.
*            CONCATENATE l_dfile l_file INTO l_file .
*            CONDENSE l_file .
*          WHEN 200.
*            CONCATENATE l_qfile l_file INTO l_file .
*            CONDENSE l_file .
*          WHEN 300 OR 310.
*            CONCATENATE l_pfile l_file INTO l_file .
*            CONDENSE l_file .
*        ENDCASE.


        CASE sy-sysid..   "Changes Added by Aditya Vora 02/07/2021
          WHEN 'ATD'.
            CONCATENATE l_dfile l_file INTO l_file .
            CONDENSE l_file .
          WHEN 'ATQ'.
            CONCATENATE l_qfile l_file INTO l_file .
            CONDENSE l_file .
          WHEN 'ATP'.
            CONCATENATE l_pfile l_file INTO l_file .
            CONDENSE l_file .
        ENDCASE.
      ENDIF.
    ELSE.
      MESSAGE 'Please Enter Plant & Storage Loc' TYPE 'I' DISPLAY LIKE 'E'.
      EXIT.
    ENDIF.
  ENDIF.

  IF l_file IS NOT INITIAL.
    ASSIGN gw_final TO <fs_final> .

    OPEN DATASET l_file FOR INPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc NE 0.
      MESSAGE 'No File Found' TYPE 'I' DISPLAY LIKE 'E'.
      EXIT.
    ENDIF.

    DO.
      READ DATASET l_file INTO l_data.
      IF sy-subrc NE 0.
        EXIT.
      ENDIF.

      l_index = 1 .
      DO .
        SPLIT l_data AT '#$#' INTO l_char1 l_char2 .

        ASSIGN COMPONENT l_index OF STRUCTURE <fs_final> TO <fs_char> .
        IF sy-subrc NE 0.
          gw_final = <fs_final> .
          APPEND gw_final TO gt_final .
          CLEAR: gw_final.
          EXIT.
        ENDIF.
        <fs_char> = l_char1.

        l_data = l_char2 .
        l_index = l_index + 1 .
        CLEAR:l_char1,l_char2 .
      ENDDO.
    ENDDO.
    CLOSE DATASET l_file.
  ENDIF.

  CLEAR: l_file,l_index.
  REFRESH: lt_dir,lt_time .

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CREATE_APP_FILE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM create_app_file .

  IF c1 IS NOT INITIAL .

    IF po_varnt IS NOT INITIAL AND s_werks-low IS NOT INITIAL AND s_werks-low IS NOT INITIAL.

      CLEAR:l_file,c2,c3.

      IF sy-uzeit LE '115959'.
*        CONCATENATE s_werks-low '_' s_lgort-low '_' sy-slset '_AM.TXT' INTO l_file .
        CONCATENATE  po_varnt '_AM.TXT' INTO l_file .
        CONDENSE l_file.
      ELSE.
*        CONCATENATE s_werks-low '_' s_lgort-low '_' sy-slset '_PM.TXT' INTO l_file .
        CONCATENATE po_varnt '_PM.TXT' INTO l_file .
        CONDENSE l_file.
      ENDIF.
*      BREAK-POINT.
      PERFORM mail_send USING 'S'.

    ELSE.
      MESSAGE 'Please select varient' TYPE 'E'.
    ENDIF.
  ENDIF.

  IF c2 IS NOT INITIAL AND c3 IS NOT INITIAL.
    MESSAGE 'Please select only Latest Or Old' TYPE 'E' .
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  EXCEL_DOWNLOAD
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM excel_download .

  TYPES: BEGIN OF ty_char,                       " Field Description
           char TYPE c LENGTH 40,
         END OF ty_char.

  DATA: l_filename TYPE string,                  " Path Location
        l_path     TYPE string,
        l_fullpath TYPE string.

  DATA: lt_hdr        TYPE STANDARD TABLE OF ty_char,
        lw_hdr        TYPE ty_char,

        lt_fieldcat_f TYPE lvc_t_fcat,
        lw_fieldcat_f LIKE lvc_s_fcat,

        lt_final      TYPE lvc_t_fcat,
        lw_final      LIKE lvc_s_fcat,

        new_table_f   TYPE REF TO data,
        new_line_f    TYPE REF TO data.

  FIELD-SYMBOLS:<l_table_f> TYPE STANDARD TABLE,
                <l_line_f>  TYPE any,
                <l_char>    TYPE any.

  CLEAR: l_filename,l_path,l_fullpath,lt_hdr[],lw_hdr,lt_fieldcat_f[],lw_fieldcat_f .

  CALL METHOD cl_gui_frontend_services=>file_save_dialog         " Get path directory
    EXPORTING
      default_extension         = 'xls'
    CHANGING
      filename                  = l_filename
      path                      = l_path
      fullpath                  = l_fullpath
    EXCEPTIONS
      cntl_error                = 1
      error_no_gui              = 2
      not_supported_by_gui      = 3
      invalid_default_file_name = 4
      OTHERS                    = 5.

  IF sy-subrc NE 0 OR l_fullpath IS INITIAL.
    MESSAGE 'No path found' TYPE 'E'.
  ENDIF.

  IF gt_fcat[] IS NOT INITIAL.
    CLEAR:gw_fcat .

    LOOP AT gt_fcat INTO gw_fcat .                    " Dynamic table type & Filed Name

*      MOVE-CORRESPONDING gw_fcat TO lw_fieldcat_f .

      lw_fieldcat_f-fieldname = gw_fcat-fieldname.
      lw_fieldcat_f-scrtext_l = gw_fcat-seltext_l.
      lw_fieldcat_f-intlen    = '40'.
      lw_fieldcat_f-datatype  = 'CHAR'.
      lw_fieldcat_f-inttype   = 'C'.


      APPEND lw_fieldcat_f TO lt_fieldcat_f.
      CLEAR: lw_fieldcat_f .

      lw_hdr-char = gw_fcat-seltext_l.
      APPEND lw_hdr TO lt_hdr.
      CLEAR:lw_hdr,gw_fcat.
    ENDLOOP.
*---------------------------------------------------------------------------------------*
    IF p_layo IS NOT INITIAL.
      CLEAR:gw_variant.
      gw_variant-variant    = p_layo .
      gw_variant-report     = sy-cprog .
*      gw_variant-dependvars = ''.

      CALL FUNCTION 'LVC_VARIANT_SELECT'        " Get Fieldcat of varient
        EXPORTING
          i_dialog            = ''
*         i_user_specific     = ''
*         i_default           = 'X'
          it_default_fieldcat = lt_fieldcat_f
        IMPORTING
          et_fieldcat         = lt_final
        CHANGING
          cs_variant          = gw_variant
        EXCEPTIONS
          wrong_input         = 1
          fc_not_complete     = 2
          not_found           = 3
          program_error       = 4
          data_missing        = 5
          OTHERS              = 6.
    ENDIF.
*---------------------------------------------------------------------------------------*
    IF lt_final[] IS NOT INITIAL.                        "  Create Dynamic table
      REFRESH: lt_fieldcat_f[],lt_hdr[].

      DELETE lt_final WHERE no_out IS NOT INITIAL .
      lt_fieldcat_f = lt_final .

      SORT lt_fieldcat_f BY col_pos .
      SORT lt_final BY col_pos .

      LOOP AT lt_final INTO lw_final.                   " Field Name
        lw_hdr-char = lw_final-scrtext_l.
        APPEND lw_hdr TO lt_hdr.
        CLEAR:lw_hdr,lw_final.
      ENDLOOP.
      FREE:lt_final[].
    ENDIF.
*---------------------------------------------------------------------------------------*
    IF lt_fieldcat_f IS NOT INITIAL.                        "  Create Dynamic table
      CALL METHOD cl_alv_table_create=>create_dynamic_table
        EXPORTING
          it_fieldcatalog = lt_fieldcat_f
        IMPORTING
          ep_table        = new_table_f.

      ASSIGN new_table_f->* TO <l_table_f>.
      CREATE DATA new_line_f LIKE LINE OF <l_table_f>.
      ASSIGN new_line_f->* TO <l_line_f>.
    ENDIF.
*---------------------------------------------------------------------------------------*
    IF lt_hdr IS NOT INITIAL.

      LOOP AT lt_hdr INTO lw_hdr.
        ASSIGN COMPONENT sy-tabix OF STRUCTURE <l_line_f> TO <l_char>.
        IF sy-subrc EQ 0.
          <l_char> = lw_hdr-char.
        ENDIF.
      ENDLOOP.

      APPEND <l_line_f> TO <l_table_f>.
      UNASSIGN: <l_line_f>,<l_char> .
      FREE:lt_hdr.
      CLEAR:lw_hdr.
    ENDIF.
  ENDIF.
*---------------------------------------------------------------------------------------*
  IF <l_table_f> IS ASSIGNED.

    CALL METHOD cl_gui_frontend_services=>gui_download
      EXPORTING
        filename                = l_fullpath
        filetype                = 'ASC'
        append                  = ''
        write_field_separator   = 'X'
        trunc_trailing_blanks   = 'X'
*       header                  = ''
      CHANGING
        data_tab                = <l_table_f>
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        not_supported_by_gui    = 22
        error_no_gui            = 23
        OTHERS                  = 24.

  ENDIF.

  IF gt_final[] IS NOT INITIAL.
    IF <l_table_f> IS ASSIGNED.
      UNASSIGN: <l_line_f>.
      ASSIGN new_line_f->* TO <l_line_f>.

      CLEAR:<l_table_f>,gw_final.

      DATA: lv_date  TYPE d,                " Get Fate Formate
            lv_value TYPE char40.           " Get Date formate

      LOOP AT gt_final[] INTO gw_final.

        MOVE-CORRESPONDING gw_final TO <l_line_f> .

        ASSIGN COMPONENT 'FVDT1' OF STRUCTURE <l_line_f> TO FIELD-SYMBOL(<fs_date>).
        IF <fs_date> IS ASSIGNED.
          PERFORM convert_date CHANGING <fs_date> .
        ENDIF.

        UNASSIGN <fs_date>.
        ASSIGN COMPONENT 'FVDT2' OF STRUCTURE <l_line_f> TO <fs_date>.
        IF <fs_date> IS ASSIGNED.
          PERFORM convert_date CHANGING <fs_date> .
        ENDIF.

        ASSIGN COMPONENT 'CPUTM' OF STRUCTURE <l_line_f> TO FIELD-SYMBOL(<fs_time>).
        IF <fs_time> IS ASSIGNED.
          PERFORM convert_time CHANGING <fs_time> .
          UNASSIGN <fs_time>.
        ENDIF.

        UNASSIGN <fs_date>.
        ASSIGN COMPONENT 'ERDAT' OF STRUCTURE <l_line_f> TO  <fs_date>."FIELD-SYMBOL(<fs_date>).
        IF <fs_date> IS ASSIGNED.
          PERFORM convert_date CHANGING <fs_date> .
        ENDIF.

        UNASSIGN <fs_date>.
        ASSIGN COMPONENT 'HSDAT' OF STRUCTURE <l_line_f> TO  <fs_date>."FIELD-SYMBOL(<fs_date>).
        IF <fs_date> IS ASSIGNED.
          PERFORM convert_date CHANGING <fs_date> .
        ENDIF.

        UNASSIGN <fs_date>.
        ASSIGN COMPONENT 'ZZASSORTDT' OF STRUCTURE <l_line_f> TO  <fs_date>."FIELD-SYMBOL(<fs_date>).
        IF <fs_date> IS ASSIGNED.
          PERFORM convert_date CHANGING <fs_date> .
        ENDIF.

        UNASSIGN <fs_date>.
        ASSIGN COMPONENT 'ZZPPCMTDT' OF STRUCTURE <l_line_f> TO <fs_date>."FIELD-SYMBOL(<fs_date>).
        IF <fs_date> IS ASSIGNED.
          PERFORM convert_date CHANGING <fs_date> .
        ENDIF.

        UNASSIGN <fs_date>.
        ASSIGN COMPONENT 'ZINVOIDT' OF STRUCTURE <l_line_f> TO  <fs_date>."FIELD-SYMBOL(<fs_date>).
        IF <fs_date> IS ASSIGNED.
          PERFORM convert_date CHANGING <fs_date> .
        ENDIF.

        UNASSIGN <fs_date>.
        ASSIGN COMPONENT 'ZENTRYDATE' OF STRUCTURE <l_line_f> TO  <fs_date>."FIELD-SYMBOL(<fs_date>).
        IF <fs_date> IS ASSIGNED.
          PERFORM convert_date CHANGING <fs_date> .
        ENDIF.

*        APPEND <l_line_f> TO <l_table_f>  .
        UNASSIGN: <fs_date>.
        ASSIGN COMPONENT 'LAST_ISSUE_DT' OF STRUCTURE <l_line_f> TO  <fs_date>."FIELD-SYMBOL(<fs_date>).
        IF <fs_date> IS ASSIGNED.
          PERFORM convert_date CHANGING <fs_date> .
        ENDIF.

        UNASSIGN: <fs_date>.
        ASSIGN COMPONENT 'ZZCUSREQD' OF STRUCTURE <l_line_f> TO  <fs_date>."FIELD-SYMBOL(<fs_date>).
        IF <fs_date> IS ASSIGNED.
          PERFORM convert_date CHANGING <fs_date> .
        ENDIF.

        APPEND <l_line_f> TO <l_table_f>  .
        UNASSIGN: <fs_date>.
      ENDLOOP.

    ENDIF.

    CALL METHOD cl_gui_frontend_services=>gui_download
      EXPORTING
        filename                = l_fullpath
        filetype                = 'ASC'
        append                  = 'X'
        write_field_separator   = 'X'
        trunc_trailing_blanks   = 'X'
*       dat_mode                = 'D'
      CHANGING
        data_tab                = <l_table_f>
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        not_supported_by_gui    = 22
        error_no_gui            = 23
        OTHERS                  = 24.
  ENDIF.

  IF sy-subrc EQ 0.
    MESSAGE 'Download Successful' TYPE 'S'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_VARIENT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM set_varient .

  CHECK sy-batch IS INITIAL.
  CLEAR po_varnt.
  MOVE sy-slset TO po_varnt.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CLEAR_CHECK_BOX
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM clear_check_box .

  IF gv_user_flag IS INITIAL.
    CLEAR: c1.
  ENDIF.
*  CASE sy-uname.
**  CASE sy-uname.
**    WHEN 'V00011' OR 'V00008' OR 'VC_PREPROD' OR 'VCERP_ABAP'.
*    WHEN OTHERS.
*      CLEAR:c1.
*  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CONVERT_DATE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_<FS_DATE>  text
*----------------------------------------------------------------------*
FORM convert_date  CHANGING p_date  TYPE char40.

  DATA: lv_date  TYPE d,
        lv_value TYPE char40.

  CLEAR: lv_date,lv_value.

  lv_date = p_date.
  WRITE lv_date TO lv_value.
  CONDENSE lv_value.
  p_date = lv_value.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_DEFAULT_LAYOUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_P_LAYO  text
*----------------------------------------------------------------------*
FORM get_default_layout CHANGING cv_layout TYPE disvariant-variant.

  DATA:ls_variant TYPE disvariant.

  CALL FUNCTION 'REUSE_ALV_VARIANT_DEFAULT_GET'
    EXPORTING
      i_save        = 'A'
    CHANGING
      cs_variant    = ls_variant
    EXCEPTIONS
      wrong_input   = 1
      not_found     = 2
      program_error = 3
      OTHERS        = 4.
  IF sy-subrc = 0.
    cv_layout = ls_variant-variant.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SELECT_ALV_VARIANT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_P_LAYO  text
*----------------------------------------------------------------------*
FORM select_alv_variant CHANGING cv_layout TYPE disvariant-variant.

  DATA: ls_variant TYPE disvariant.

  ls_variant-report = sy-repid.

  CALL FUNCTION 'REUSE_ALV_VARIANT_F4'
    EXPORTING
      is_variant    = ls_variant
      i_save        = 'A'
    IMPORTING
      es_variant    = ls_variant
    EXCEPTIONS
      not_found     = 1
      program_error = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE 'S' NUMBER sy-msgno
      WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ELSE.
    cv_layout = ls_variant-variant.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  BUILD_VARIANT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM build_variant .
  gw_variant-variant = p_layo .
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  filter_output_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM filter_output_data .

*  CHECK GT_FINAL IS NOT INITIAL .
*  DELETE GT_FINAL WHERE WERKS NOT IN   S_WERKS[].             " Plant
*  DELETE GT_FINAL WHERE LGORT NOT IN   S_LGORT[].             " Storage location
*  DELETE GT_FINAL WHERE LGNUM NOT IN   S_LGNUM[].             " Ware House
*  DELETE GT_FINAL WHERE MATNR NOT IN   S_MATNR[].             " Material
*  DELETE GT_FINAL WHERE MATKL NOT IN   S_MATKL[].             " Materila Grp
*  DELETE GT_FINAL WHERE LGTYP NOT IN   S_LGTYP[].             " Storage Type
*  DELETE GT_FINAL WHERE LGPLA NOT IN   S_LGPLA[].             " Storage Bin
**  DELETE gt_final WHERE bestq NOT IN   s_bestq[].             " Stock Category
*  DELETE GT_FINAL WHERE SOBKZ NOT IN   S_SOBKZ[].             " Special stock indicator
*  DELETE GT_FINAL WHERE VBELN NOT IN   S_VBELN[].             " Sales order
*  DELETE GT_FINAL WHERE POSNR NOT IN   S_POSNR[].             " Line item no
*  DELETE GT_FINAL WHERE CHARG NOT IN   S_CHARG[].             " Batch No
*  DELETE GT_FINAL WHERE BZIRK NOT IN   S_BZIRK[].             " Sales district

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SELECT_USER
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM select_user .
  CLEAR:gv_user_flag.
  SELECT SINGLE * FROM tvarvc INTO @DATA(lv_user) WHERE name EQ 'ZMMSTOCK_USER' AND low EQ @sy-uname.
  IF sy-subrc EQ 0.
    gv_user_flag = 'X'.
  ELSE.
    CLEAR:gv_user_flag .
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  MAIL_SEND
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM mail_send USING p_txt.
  DATA: lv_string TYPE string,
        lv_count  TYPE i.
* Data Declarations
  DATA: lt_mailsubject     TYPE sodocchgi1.
  DATA: lt_mailrecipients TYPE STANDARD TABLE OF somlrec90,
        lw_mailrecipients TYPE somlrec90.
  DATA: lt_mailtxt TYPE STANDARD TABLE OF soli,
        lw_mailtxt TYPE soli.

  SELECT *
    FROM zmm_mail_stock
    INTO TABLE @DATA(it_mail)
    WHERE variant EQ @po_varnt.

  IF it_mail[] IS NOT INITIAL.
* Recipients
    LOOP AT it_mail INTO DATA(lw_mail).
      lw_mailrecipients-rec_type  = 'U'.
      lw_mailrecipients-receiver = lw_mail-mailid.
      lw_mailrecipients-express = 'X'.
      APPEND lw_mailrecipients TO lt_mailrecipients .
      CLEAR: lw_mailrecipients, lw_mail.
    ENDLOOP."LOOP AT it_mail INTO DATA(lw_mail).
**********************Added by V00041 on 11.02.2022 req by Bhavin
    LOOP AT gt_receiver_email INTO gs_receiver_email.
      lw_mailrecipients-rec_type  = 'U'.
      lw_mailrecipients-receiver = gs_receiver_email.
      lw_mailrecipients-express = 'X'.
      APPEND lw_mailrecipients TO lt_mailrecipients .
      CLEAR: lw_mailrecipients, lw_mail.
    ENDLOOP.
**********************EOC
* Subject.
    lt_mailsubject-obj_name = 'Scheduler for ZMMSTOCK_NEW'.
    lt_mailsubject-obj_langu = sy-langu.
    IF p_txt EQ 'S'.
      CONCATENATE 'Scheduler | ZMMSTOCK_NEW |' po_varnt '| Start' INTO lt_mailsubject-obj_descr
      SEPARATED BY space.
    ELSEIF p_txt EQ 'E'.
      CONCATENATE 'Scheduler | ZMMSTOCK_NEW |' po_varnt '| End' INTO lt_mailsubject-obj_descr
      SEPARATED BY space.
    ENDIF."IF p_txt eq 'S'.

    lt_mailsubject-skip_scren = 'X'.

* Mail Contents
    CLEAR lw_mailtxt.
    CONCATENATE 'Dear Sir/Madam' ',' INTO lw_mailtxt-line.
    APPEND lw_mailtxt TO lt_mailtxt.

    "Blank Line
    CLEAR lw_mailtxt.
    APPEND lw_mailtxt TO lt_mailtxt.

    CLEAR lw_mailtxt.
    CONCATENATE 'Please find the below mentioned details for current scheduler:' '' INTO lw_mailtxt-line.
    APPEND lw_mailtxt TO lt_mailtxt.

    "Blank Line
    CLEAR lw_mailtxt.
    APPEND lw_mailtxt TO lt_mailtxt.

    CLEAR lw_mailtxt.
    CONCATENATE 'T-Code Name:--' 'ZMMSTOCK_NEW' INTO lw_mailtxt-line.
    APPEND lw_mailtxt TO lt_mailtxt.

    CLEAR lw_mailtxt.
    CONCATENATE 'Scheduled Variant Name:--' po_varnt INTO lw_mailtxt-line.
    APPEND lw_mailtxt TO lt_mailtxt.

    CLEAR lw_mailtxt.
    IF p_txt EQ 'S'.
      CONCATENATE 'Scheduled Start Date:--' sy-datum+6(2) '.' sy-datum+4(2) '.' sy-datum+0(4)
      INTO lw_mailtxt-line.
    ELSEIF p_txt EQ 'E'.
      CONCATENATE 'Scheduled End Date:--' sy-datum+6(2) '.' sy-datum+4(2) '.' sy-datum+0(4)
      INTO lw_mailtxt-line.
    ENDIF."IF p_txt eq 'S'.
    APPEND lw_mailtxt TO lt_mailtxt.

    CLEAR lw_mailtxt.
    IF p_txt EQ 'S'.
      CONCATENATE 'Scheduled Start Time:--' sy-timlo+0(2) '.' sy-timlo+2(2) '.'
      sy-timlo+4(2) INTO lw_mailtxt-line.
    ELSEIF p_txt EQ 'E'.
      CONCATENATE 'Scheduled End Time:--' sy-timlo+0(2) '.' sy-timlo+2(2) '.'
          sy-timlo+4(2) INTO lw_mailtxt-line.
    ENDIF."IF p_txt eq 'S'.
    APPEND lw_mailtxt TO lt_mailtxt.

    "Blank Line
    CLEAR lw_mailtxt.
    APPEND lw_mailtxt TO lt_mailtxt.

    CLEAR lw_mailtxt.
    CONCATENATE 'This is an auto generated email.' 'Please do not reply.' INTO lw_mailtxt-line SEPARATED BY space.
    APPEND lw_mailtxt TO lt_mailtxt.
  ENDIF."IF it_mail[] IS NOT INITIAL

* Send Mail
  IF lt_mailsubject IS NOT INITIAL AND lt_mailrecipients[] IS NOT INITIAL.
    CALL FUNCTION 'SO_NEW_DOCUMENT_SEND_API1'
      EXPORTING
        document_data              = lt_mailsubject
      TABLES
        object_content             = lt_mailtxt[]
        receivers                  = lt_mailrecipients[]
      EXCEPTIONS
        too_many_receivers         = 1
        document_not_sent          = 2
        document_type_not_exist    = 3
        operation_no_authorization = 4
        parameter_error            = 5
        x_error                    = 6
        enqueue_error              = 7
        OTHERS                     = 8.
    IF sy-subrc EQ 0.
      COMMIT WORK.
*   Push mail out from SAP outbox
      SUBMIT rsconn01 WITH mode = 'INT' AND RETURN.
    ENDIF."IF sy-subrc EQ 0.
  ENDIF."IF lt_mailsubject[] IS NOT INITIAL AND lt_mailrecipients[] IS NOT INITIAL.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  FREE_ITAB
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM free_itab .
  FREE: gt_bestq, gt_btch_char_tab, gt_cpudt, gt_eban, gt_ebew, gt_konv, gt_lgobe, gt_lips, gt_lips_v,
  gt_lnumt, gt_lqua, gt_lqua1, gt_maktx, gt_mara_basic, gt_mara_basic, gt_mard, gt_mat_uom, gt_matkl,
  gt_matkl1, gt_matnr, gt_mbew, gt_mch1, gt_mcha, gt_mchb, gt_mm_stck_rpt, gt_mseg, gt_mseg261, gt_mseg_blnk,
*  gt_mseg_dest, gt_mseg_src, gt_mska, gt_mtch_char_tab, gt_ppbatch, gt_ppmatch, gt_pstyp, gt_qals, gt_request,
  gt_mseg_dest, gt_mska, gt_mtch_char_tab, gt_ppbatch, gt_ppmatch, gt_pstyp, gt_qals, gt_request,
  gt_usr21, gt_vbap, gt_vbkd, gt_vbpa, gt_wgbez,gw_ekpo_st,gt_mseg_315,gt_mseg_e,gt_mseg_ne,gt_mseg_oth.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GEY_MATKL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM gey_matkl .

  rt_pln_matkl-sign = 'I'.
  rt_pln_matkl-option = 'EQ'.

  rt_pln_matkl-low = 'NYF'.
  APPEND rt_pln_matkl.
  CLEAR rt_pln_matkl-low .

  rt_pln_matkl-low = 'YFF'.
  APPEND rt_pln_matkl.
  CLEAR rt_pln_matkl-low .

  rt_pln_matkl-low = 'ISF'.
  APPEND rt_pln_matkl.
  CLEAR rt_pln_matkl-low .

  rt_pln_matkl-low = 'IYF'.
  APPEND rt_pln_matkl.
  CLEAR rt_pln_matkl-low .

  "~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~"
  rt_issue_matkl-sign = 'I'.
  rt_issue_matkl-option = 'EQ'.

  rt_issue_matkl-low = 'YGF'.
  APPEND rt_issue_matkl.
  CLEAR rt_issue_matkl-low .

  rt_issue_matkl-low = 'IGF'.
  APPEND rt_issue_matkl.
  CLEAR rt_issue_matkl-low .

  rt_issue_matkl-low = 'NGF'.
  APPEND rt_issue_matkl.
  CLEAR rt_issue_matkl-low .

  rt_issue_matkl-low = 'ISG'.
  APPEND rt_issue_matkl.
  CLEAR rt_issue_matkl-low .

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SO_GRY_PLAN_QTY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GW_VBAP  text
*----------------------------------------------------------------------*
FORM so_gry_plan_qty  USING    p_vbap TYPE ty_vbap.

  "~~~~~~~~~ Grey Plan qty ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
  IF gw_final-kwmeng IS NOT INITIAL AND p_vbap-matkl IN rt_pln_matkl[] ."( 'NYF''IYF''ISF''IYF' ).

    CLEAR:gw_ppmatch,gt_mtch_char_tab[],gv_fppr,gv_prsh.
    READ TABLE gt_ppmatch INTO gw_ppmatch WITH KEY matnr = gw_matnr-matnr
                                                   cuobj = gw_matnr-cuobj.

    IF sy-subrc EQ 0 AND gw_ppmatch-char_tab[] IS NOT INITIAL.
      gt_mtch_char_tab[] = gw_ppmatch-char_tab[] .
      SORT gt_mtch_char_tab[] BY atnam .

      READ TABLE gt_mtch_char_tab[] ASSIGNING FIELD-SYMBOL(<fs_char>) WITH KEY atnam = gc_w_fppr BINARY SEARCH .
      IF <fs_char> IS ASSIGNED AND <fs_char>-atwrt IS NOT INITIAL.
        gv_fppr = <fs_char>-atwrt .
      ENDIF.

      READ TABLE gt_mtch_char_tab[] ASSIGNING FIELD-SYMBOL(<fs_char1>) WITH KEY atnam = gc_w_prsh BINARY SEARCH .
      IF <fs_char1> IS ASSIGNED AND <fs_char1>-atwrt IS NOT INITIAL.
        gv_prsh = <fs_char1>-atwrt .
      ENDIF.
    ENDIF.

    IF gv_fppr IS NOT INITIAL.
      gw_final-grig_pln_qty = ( gw_final-kwmeng * 100 * 100 ) / ( gv_fppr  * ( 100 - gv_prsh ) ) .
    ENDIF.
  ENDIF.
*--------Add On 7-1-2019: If SO unit in YARD then its convert to Metre------------------*Start
  IF gw_final-vrkme IS NOT INITIAL.
    CASE gw_final-vrkme.
      WHEN 'M'.
*        CONTINUE .
      WHEN 'YD'.
        gw_final-grig_pln_qty = gw_final-grig_pln_qty / gc_yard .
      WHEN OTHERS.
        CLEAR: gw_final-grig_pln_qty.
    ENDCASE.
  ENDIF.
*--------Add On 7-1-2019: If SO unit in YARD then its convert to Metre------------------*End
  UNASSIGN: <fs_char>,<fs_char1> .
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  MATERIAL_DESC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LV_YARN  text
*      <--P_GW_FINAL_YARN1_DESC  text
*----------------------------------------------------------------------*
FORM material_desc  USING    p_yarn TYPE char30
                    CHANGING p_maktx TYPE char40.
  CLEAR: p_maktx .
  IF p_yarn IS NOT INITIAL .
*    p_maktx = VALUE #( gt_makt[ matnr = p_yarn ]-maktx OPTIONAL ).
    READ TABLE gt_makt INTO gs_makt WITH KEY matnr = p_yarn.
    IF sy-subrc = 0.
      p_maktx = gs_makt-maktx.
    ELSE.
      SELECT SINGLE maktx FROM makt INTO p_maktx WHERE matnr EQ p_yarn AND spras EQ 'E'.
      gs_makt-matnr = p_yarn.
      gs_makt-maktx = p_maktx.
      APPEND gs_makt TO gt_makt.
      CLEAR gs_makt.
      CHECK sy-subrc EQ 0 .

    ENDIF.
    CLEAR : gs_makt.
  ENDIF.



ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_TRANSACTION_DATE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GW_FINAL_FVDT2  text
*----------------------------------------------------------------------*
FORM get_transaction_date  CHANGING gw_mseg.
  READ TABLE gt_mseg_dest ASSIGNING FIELD-SYMBOL(<fs_dest>) WITH KEY dest COMPONENTS umwrk = gw_matnr-werks umlgo = gw_matnr-lgort
                                                                                     ummat = gw_matnr-matnr umcha = gw_matnr-charg ."BINARY SEARCH.
  READ TABLE gt_mseg_dest ASSIGNING FIELD-SYMBOL(<fs_src>) WITH KEY src COMPONENTS werks = gw_matnr-werks lgort = gw_matnr-lgort
                                                                                   matnr = gw_matnr-matnr charg = gw_matnr-charg ."BINARY SEARCH.
  IF <fs_dest> IS ASSIGNED AND <fs_src> IS ASSIGNED.
    IF     <fs_dest>-cpudt < <fs_src>-cpudt.
*      p_fvdt2 = <fs_dest>-cpudt.
      gw_mseg = <fs_dest> .
    ELSEIF <fs_dest>-cpudt > <fs_src>-cpudt.
*      p_fvdt2 = <fs_src>-cpudt.
      gw_mseg = <fs_src> .
    ELSEIF <fs_dest>-cpudt = <fs_src>-cpudt AND <fs_dest>-cputm < <fs_src>-cputm.
*      p_fvdt2 = <fs_dest>-cpudt.
      gw_mseg = <fs_dest> .
    ELSEIF <fs_dest>-cpudt = <fs_src>-cpudt AND <fs_dest>-cputm > <fs_src>-cputm.
*      p_fvdt2 = <fs_src>-cpudt.
      gw_mseg = <fs_src> .
    ENDIF.
  ELSEIF <fs_dest> IS ASSIGNED.
    gw_mseg = <fs_dest> .
  ELSEIF <fs_src> IS ASSIGNED.
    gw_mseg = <fs_src> .
  ENDIF.
  UNASSIGN: <fs_dest>, <fs_src>.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CONVERT_TIME
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_<FS_TIME>  text
*----------------------------------------------------------------------*
FORM convert_time  CHANGING p_time.

  DATA: lv_time  TYPE t,
        lv_value TYPE char40.

  CLEAR: lv_time,lv_value.

  lv_time = p_time.
  WRITE lv_time TO lv_value.
  CONDENSE lv_value.
  p_time = lv_value.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  DEFECT_CODE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GW_FINAL_DEFECT_CODE  text
*----------------------------------------------------------------------*
FORM defect_code  CHANGING p_defect_code.

  READ TABLE gt_defects INTO gw_defects WITH KEY  zplant  = gw_matnr-werks
                                                  matkl   = gw_matnr-matkl
                                                  zzevent = p_defect_code .
  IF  sy-subrc EQ 0.
    p_defect_code = p_defect_code && |-| && gw_defects-zzdesc .
  ELSE.
    CLEAR p_defect_code.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  NON_BATCH_AGGING
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GW_MATNR  text
*      <--P_LV_DATE  text
*----------------------------------------------------------------------*
FORM non_batch_agging  USING    p_matnr TYPE ty_matnr
                                p_asign TYPE char1
                       CHANGING p_date.
  DATA: l_menge TYPE menge_d.
  CLEAR: l_index,gw_mseg_e .

  CASE p_asign.
    WHEN ''.
      LOOP AT gt_mseg_ne INTO gw_mseg_e WHERE werks EQ p_matnr-werks AND matnr EQ p_matnr-matnr AND
                                              lgort EQ p_matnr-lgort AND
                                              kdauf EQ p_matnr-vbeln AND kdpos EQ p_matnr-posnr
                                 GROUP BY ( k1 = gw_mseg_e-werks k2 = gw_mseg_e-matnr k3 = gw_mseg_e-lgort
                                            k4 = gw_mseg_e-kdauf k5 = gw_mseg_e-kdpos ) INTO DATA(l_grp) .
        LOOP AT GROUP l_grp INTO gw_mseg_e.
          l_menge = l_menge + gw_mseg_e-menge .
          IF l_menge GE p_matnr-qnty.
            p_date = gw_mseg_e-budat .
            EXIT.
          ENDIF."IF p_matnr ge l_menge.
        ENDLOOP."LOOP AT GROUP l_grp INTO gw_mseg_e.
      ENDLOOP."LOOP AT gt_mseg_e INTO gw_mseg_e

      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"  Add on 16.12.2019
      " If upper logic not work on basis of so+line then run same
      " logic with out so+lone
      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
      IF p_date IS INITIAL.
        LOOP AT gt_mseg_ne INTO gw_mseg_e WHERE werks EQ p_matnr-werks AND matnr EQ p_matnr-matnr AND
                                                lgort EQ p_matnr-lgort
                           GROUP BY ( k1 = gw_mseg_e-werks k2 = gw_mseg_e-matnr k3 = gw_mseg_e-lgort )
                                    INTO DATA(l_grp2) .
          LOOP AT GROUP l_grp2 INTO gw_mseg_e.
            l_menge = l_menge + gw_mseg_e-menge .
            IF l_menge GE p_matnr-qnty.
              p_date = gw_mseg_e-budat .
              EXIT.
            ENDIF."IF p_matnr ge l_menge.
          ENDLOOP."LOOP AT GROUP l_grp INTO gw_mseg_e.
        ENDLOOP."LOOP AT gt_mseg_e INTO gw_mseg_e
      ENDIF."IF p_date is INITIAL.
      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"  End on 16.12.2019

    WHEN 'X'.

      LOOP AT gt_mseg_oth INTO gw_mseg_e WHERE werks EQ p_matnr-werks AND ummat EQ p_matnr-matnr AND
                                               umlgo EQ p_matnr-lgort AND umcha EQ p_matnr-charg "AND
                                GROUP BY ( k1 = gw_mseg_e-werks k2 = gw_mseg_e-ummat k3 = gw_mseg_e-umlgo
                                           k4 = gw_mseg_e-umcha )
                                INTO DATA(l_grp1) .
        LOOP AT GROUP l_grp1 INTO gw_mseg_e.
          l_menge = l_menge + gw_mseg_e-menge .
          IF l_menge GE p_matnr-qnty.
            p_date = gw_mseg_e-budat .
            EXIT.
          ENDIF."IF p_matnr ge l_menge.
        ENDLOOP."LOOP AT GROUP l_grp INTO gw_mseg_e.
      ENDLOOP."LOOP AT gt_mseg_e INTO gw_mseg_e
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  STCK_RPT_BY_PASS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM stck_rpt_by_pass .
*-------------------------------------------------------------------------* Start
*  By Pass Table-ZMM_STCK_RPT Data with New  New Table data-ZMM_STCK_NEW
*  Add BY Surajit On 27-12-2019 Rqst By Pinky
* Logic: 1)This logic not work for multiple plant,
*   2)1st Check Table ZMM_STCK_RPT, For Basic Data then Check Table ZMM_STCK_RPT_NEW
*     to Over write existig data for Perticula plant,that maintain on ZMM_STCK_RPT_NEW .
*-------------------------------------------------------------------------*
  DATA: lt_rpt_lc TYPE STANDARD TABLE OF ty_stck_rpt,
        lw_rpt_lc TYPE ty_stck_rpt.

  FREE: lt_rpt_lc,lw_rpt_lc .

  CHECK s_werks-low  NE '*'.
  CHECK s_werks-high EQ '' .
  CHECK lines( s_werks ) EQ 1 .

  lt_rpt_lc = gt_mm_stck_rpt .

  SELECT * FROM zmm_stck_rpt_new INTO TABLE gt_stck_rpt_new
           FOR ALL ENTRIES IN gt_matnr
           WHERE werks EQ gt_matnr-werks AND
                 matkl EQ gt_matnr-matkl .
  IF sy-subrc EQ 0.
    FREE: gt_mm_stck_rpt .

    LOOP AT gt_stck_rpt_new INTO gw_stck_rpt_new.
      READ TABLE lt_rpt_lc INTO lw_rpt_lc WITH KEY matkl   = gw_stck_rpt_new-matkl
                                                   hdrdesc = gw_stck_rpt_new-hdrdesc .
      IF sy-subrc EQ 0.
        lw_rpt_lc-klart = gw_stck_rpt_new-klart .
        lw_rpt_lc-class = gw_stck_rpt_new-class .
        lw_rpt_lc-atnam = gw_stck_rpt_new-atnam .

        MODIFY lt_rpt_lc FROM lw_rpt_lc INDEX sy-tabix TRANSPORTING klart class atnam .
      ENDIF. " READ TABLE gt_mm_stck_rpt

      CLEAR: lw_rpt_lc,gw_stck_rpt_new.
    ENDLOOP. " LOOP AT zmm_stck_rpt_new

    gt_mm_stck_rpt = lt_rpt_lc .
  ENDIF.  " SELECT * FROM zmm_stck_rpt_new
*-------------------------------------------------------------------------* End

  FREE: lw_rpt_lc,lt_rpt_lc.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SR_NO1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*************************Added by Surbhi dadhich************************
FORM sr_no1.
  REFRESH gt_final_sr.
  CLEAR : gv_qty, gv_qty1, gv_flag.
  LOOP AT gt_final INTO gw_final.
    IF gw_final-werks = '1021' AND gw_final-matkl = 'VGP'.
      IF gw_final-charg CP 'GRADE*'.
        APPEND gw_final TO gt_final_sr.
        CLEAR : gw_final.
      ENDIF.
    ENDIF.
  ENDLOOP.
  IF gt_final_sr IS NOT INITIAL.
    IF gt_mska2 IS NOT INITIAL.
      DATA(t_mska2) = gt_mska2[].
      REFRESH : gt_mska2.
      LOOP AT t_mska2 INTO DATA(fs_mska2).
        READ TABLE gt_final_sr INTO DATA(s_srr1) WITH KEY charg = fs_mska2-charg.
        IF sy-subrc = 0.
          APPEND fs_mska2 TO gt_mska2.
        ELSE.
*          DELETE GT_MSKA2 INDEX SY-TABIX.
        ENDIF.
        CLEAR : fs_mska2, s_srr1.
      ENDLOOP.
      IF gt_mska2 IS NOT INITIAL.
        SELECT mblnr, mjahr, bwart, xauto, matnr, werks, lgort, charg, sobkz, kdauf, kdpos, sjahr, smbln, menge,
        cpudt_mkpf, cputm_mkpf, mat_kdauf, mat_kdpos
        FROM mseg INTO TABLE @DATA(t_mseg)
        FOR ALL ENTRIES IN @gt_mska2
        WHERE werks = '1021'
        AND matnr = @gt_mska2-matnr
        AND charg = @gt_mska2-charg
        AND lgort = @gt_mska2-lgort
        AND sobkz = @gt_mska2-sobkz
        AND mat_kdauf = @gt_mska2-vbeln
        AND mat_kdpos = @gt_mska2-posnr
*      AND XAUTO = 'X'
        AND shkzg EQ 'S'
        AND sjahr = ' '
        AND smbln = ' '.
      ENDIF.
    ENDIF.
*    IF GV_MSKA = 'X'.
*      SELECT MBLNR, MJAHR, BWART, XAUTO, MATNR, WERKS, LGORT, CHARG, SOBKZ, KDAUF, KDPOS, SJAHR, SMBLN, MENGE,
*      CPUDT_MKPF, CPUTM_MKPF, MAT_KDAUF, MAT_KDPOS
*      FROM MSEG INTO TABLE @DATA(T_MSEG)
*      FOR ALL ENTRIES IN @GT_FINAL_SR
*      WHERE WERKS = '1021'
*      AND MATNR = @GT_FINAL_SR-MATNR
*      AND CHARG = @GT_FINAL_SR-CHARG
*      AND LGORT = @GT_FINAL_SR-LGORT
*      AND SOBKZ = @GT_FINAL_SR-SOBKZ
*      AND MAT_KDAUF = @GT_FINAL_SR-VBELN
*      AND MAT_KDPOS = @GT_FINAL_SR-POSNR
*      AND XAUTO = 'X'
*      AND SJAHR = ' '
*      AND SMBLN = ' '.
*    ELSEIF GV_MCHB = 'X'.
*      SELECT MBLNR MJAHR BWART XAUTO MATNR WERKS LGORT CHARG SOBKZ KDAUF KDPOS SJAHR SMBLN MENGE
*      CPUDT_MKPF CPUTM_MKPF
*FROM MSEG INTO TABLE T_MSEG
*FOR ALL ENTRIES IN GT_FINAL_SR
*WHERE WERKS = '1021'
*AND MATNR = GT_FINAL_SR-MATNR
*AND CHARG = GT_FINAL_SR-CHARG
*AND LGORT = GT_FINAL_SR-LGORT
*AND SOBKZ = GT_FINAL_SR-SOBKZ
*AND XAUTO = 'X'
*AND SJAHR = ' '
*AND SMBLN = ' '.
*    ENDIF.
  ENDIF.
  DATA(gt_final1_srr) = gt_final_sr.
  REFRESH gt_final_sr.
  IF t_mseg IS NOT INITIAL.
    SORT t_mseg BY charg cpudt_mkpf DESCENDING.
    DATA(t_msegg) = t_mseg[].
    SORT t_msegg BY charg cpudt_mkpf DESCENDING.
    LOOP AT t_msegg INTO DATA(s_msegg).
      ON CHANGE OF s_msegg-mat_kdauf.
        LOOP AT t_mseg INTO DATA(s_mseg) WHERE charg = s_msegg-charg AND mat_kdauf = s_msegg-mat_kdauf.
          DATA: lv_date TYPE sy-datum,
                lv_char TYPE char20.
          CLEAR: lv_date,lv_char.
*          IF GV_MSKA = 'X'.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg-matnr
                                                       charg = s_mseg-charg
                                                       lgort = s_mseg-lgort
                                                       sobkz = s_mseg-sobkz
                                                       vbeln = s_mseg-mat_kdauf
                                                       posnr = s_mseg-mat_kdpos.
          IF sy-subrc = 0.
            gd_tabix = sy-tabix.
            IF s_mseg-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              MODIFY gt_final FROM gw_final TRANSPORTING age_batch1 WHERE charg = gw_final-charg.
              CLEAR : gw_final.
            ENDIF.
          ENDIF.
*          ELSEIF GV_MCHB = 'X'.
*            READ TABLE GT_FINAL INTO GW_FINAL WITH KEY MATNR = S_MSEG-MATNR
*                                             CHARG = S_MSEG-CHARG
*                                             LGORT = S_MSEG-LGORT
*                                             SOBKZ = S_MSEG-SOBKZ.
*            IF SY-SUBRC = 0.
*              GD_TABIX = SY-TABIX.
*              IF S_MSEG-CPUDT_MKPF  IS NOT INITIAL .
*                LV_DATE =  S_MSEG-CPUDT_MKPF.
*                PERFORM CALCULATE_DATE_RANGE USING LV_DATE CHANGING LV_CHAR .
*                GW_FINAL-AGE_BATCH1  = LV_CHAR .
*                MODIFY GT_FINAL FROM GW_FINAL TRANSPORTING AGE_BATCH1 WHERE CHARG = GW_FINAL-CHARG.
*                CLEAR : GW_FINAL.
*              ENDIF.
*            ENDIF.
*          ENDIF.
        ENDLOOP.
      ENDON.
      CLEAR : s_msegg, s_mseg.
    ENDLOOP.


    LOOP AT t_msegg INTO s_msegg.
      ON CHANGE OF s_msegg-mat_kdauf.
        LOOP AT t_mseg INTO s_mseg WHERE charg = s_msegg-charg AND mat_kdauf = s_msegg-mat_kdauf..
*            DATA: LV_DATE TYPE SY-DATUM,
*                  LV_CHAR TYPE CHAR20.
          CLEAR: lv_date,lv_char.
*          IF GV_MSKA = 'X'.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg-matnr
                                                       charg = s_mseg-charg
                                                       lgort = s_mseg-lgort
                                                       sobkz = s_mseg-sobkz
                                                       vbeln = s_mseg-mat_kdauf
                                                       posnr = s_mseg-mat_kdpos.
          IF sy-subrc = 0.
            IF s_mseg-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              IF gv_aging = gw_final-age_batch1.
                gv_age = 'X'.
              ELSE.
                gv_age = ''.
              ENDIF.
              gv_aging = gw_final-age_batch1.
              CLEAR:lv_date,lv_char .
            ENDIF.
            READ TABLE gt_mska2 INTO DATA(s_mska2) WITH KEY werks = '1021'
                                                            matnr = gw_final-matnr
                                                            charg = gw_final-charg
                                                            lgort = gw_final-lgort
                                                            vbeln = gw_final-vbeln
                                                            posnr = gw_final-posnr.
            IF sy-subrc = 0.
            ENDIF.
            IF gv_flag IS INITIAL.
*                GV_QTY = GW_FINAL-MENGE - S_MSEG-MENGE.
              gv_qty = s_mska2-kalab - s_mseg-menge.
              CHECK gv_qty GE 0.
              gv_qty2 = s_mseg-menge.
            ELSE.
              gv_qty1 = gv_qty.
              gv_qty = gv_qty - s_mseg-menge.
              IF gv_qty1 EQ 0.
                CHECK gv_qty GE 0.
              ELSE.
                CHECK gv_qty GE 0 OR gv_qty1 GE 0 .
              ENDIF.
              IF gv_age = 'X'.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty = -1.
                  gv_qty1 = -1.
                ELSE.
                  gv_qty2 = gv_qty2 + s_mseg-menge.
                  gw_final-menge = gv_qty2.
                ENDIF.
              ELSE.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty = -1.
                  gv_qty1 = -1.
                ELSE.
                  gv_qty2 = s_mseg-menge.
                  gw_final-menge = s_mseg-menge.
                ENDIF.
              ENDIF.
              gv_qty1 = gv_qty.
            ENDIF.
            gv_flag = 'X'.
            IF gv_qty1  IS INITIAL.
              gw_final-menge = s_mseg-menge.
            ENDIF.

            APPEND gw_final TO gt_final_sr.
            CLEAR : gw_final.
          ELSE.
            CLEAR : gv_flag, gv_qty, gv_qty1, gv_aging, gv_age, gv_qty2.
          ENDIF.
*          ELSEIF GV_MCHB = 'X'.
*            READ TABLE GT_FINAL INTO GW_FINAL WITH KEY MATNR = S_MSEG-MATNR
*                                             CHARG = S_MSEG-CHARG
*                                             LGORT = S_MSEG-LGORT
*                                             SOBKZ = S_MSEG-SOBKZ.
*
*            IF SY-SUBRC = 0.
*              IF S_MSEG-CPUDT_MKPF  IS NOT INITIAL .
*                LV_DATE =  S_MSEG-CPUDT_MKPF.
*                PERFORM CALCULATE_DATE_RANGE USING LV_DATE CHANGING LV_CHAR .
*                GW_FINAL-AGE_BATCH1  = LV_CHAR .
*                IF GV_AGING = GW_FINAL-AGE_BATCH1.
*                  GV_AGE = 'X'.
*                ELSE.
*                  GV_AGE = ''.
*                ENDIF.
*                GV_AGING = GW_FINAL-AGE_BATCH1.
*                CLEAR:LV_DATE,LV_CHAR .
*              ENDIF.
*              IF GV_FLAG IS INITIAL.
*                GV_QTY = GW_FINAL-MENGE - S_MSEG-MENGE.
*                CHECK GV_QTY GE 0.
*                GV_QTY2 = S_MSEG-MENGE.
*              ELSE.
*                GV_QTY1 = GV_QTY.
*                GV_QTY = GV_QTY - S_MSEG-MENGE.
*                IF GV_QTY1 EQ 0.
*                  CHECK GV_QTY GE 0.
*                ELSE.
*                  CHECK GV_QTY GE 0 OR GV_QTY1 GE 0 .
*                ENDIF.
*                IF GV_AGE = 'X'.
*                  IF GW_FINAL-AGE_BATCH1 = 'More then 365'.
*                    GW_FINAL-MENGE = GV_QTY1.
*                    GV_QTY = -1.
*                    GV_QTY1 = -1.
*                  ELSE.
*                    GV_QTY2 = GV_QTY2 + S_MSEG-MENGE.
*                    GW_FINAL-MENGE = GV_QTY2.
*                  ENDIF.
*                ELSE.
*                  IF GW_FINAL-AGE_BATCH1 = 'More then 365'.
*                    GW_FINAL-MENGE = GV_QTY1.
*                    GV_QTY = -1.
*                    GV_QTY1 = -1.
*                  ELSE.
*                    GV_QTY2 = S_MSEG-MENGE.
*                    GW_FINAL-MENGE = S_MSEG-MENGE.
*                  ENDIF.
*                ENDIF.
*                GV_QTY1 = GV_QTY.
*              ENDIF.
*              GV_FLAG = 'X'.
*              IF GV_QTY1  IS INITIAL.
*                GW_FINAL-MENGE = S_MSEG-MENGE.
*              ENDIF.
*
*              APPEND GW_FINAL TO GT_FINAL_SR.
*              CLEAR : GW_FINAL.
*            ELSE.
*              CLEAR : GV_FLAG, GV_QTY, GV_QTY1, GV_AGING, GV_AGE, GV_QTY2.
*            ENDIF.
*          ENDIF.
          CLEAR : s_mseg.
        ENDLOOP.
        CLEAR : gv_qty, gv_qty1, gv_flag, gv_aging, gv_age, gv_qty2.
      ENDON.
      CLEAR : s_msegg , s_msegg.
    ENDLOOP.
  ENDIF.
  REFRESH : t_mseg.
  IF gt_final1_srr IS NOT INITIAL.
    IF gt_mchb2 IS NOT INITIAL.
      DATA(t_mchb2) = gt_mchb2[].
      REFRESH : gt_mchb2.
      LOOP AT t_mchb2 INTO DATA(fs_mchb2).
        READ TABLE gt_final1_srr INTO DATA(s_srr2) WITH KEY charg = fs_mchb2-charg.
        IF sy-subrc = 0.
          APPEND fs_mchb2 TO gt_mchb2.
        ELSE.
*          DELETE GT_MCHB2 FROM FS_MCHB2.
        ENDIF.
        CLEAR : fs_mchb2, s_srr2.
      ENDLOOP.
      REFRESH : t_mseg.
      IF gt_mchb2 IS NOT INITIAL.
        SELECT mblnr mjahr bwart xauto matnr werks lgort charg sobkz kdauf kdpos sjahr smbln menge
        cpudt_mkpf cputm_mkpf mat_kdauf mat_kdpos
        FROM mseg INTO TABLE t_mseg
        FOR ALL ENTRIES IN gt_mchb2
        WHERE werks = '1021'
        AND matnr = gt_mchb2-matnr
        AND charg = gt_mchb2-charg
        AND lgort = gt_mchb2-lgort
*      AND XAUTO = 'X'
        AND shkzg EQ 'S'
        AND sjahr = ''
        AND smbln = ''
        AND sobkz EQ ''.
      ENDIF.
    ENDIF.
  ENDIF.
  REFRESH : gt_final1_srr.
  IF t_mseg IS NOT INITIAL.
*    SORT GT_MCHB2 BY ,
*    SORT T_MSEG BY CHARG.
    SORT t_mseg BY charg cpudt_mkpf DESCENDING.
    t_msegg[] = t_mseg[].
    SORT t_msegg BY charg cpudt_mkpf DESCENDING.
    LOOP AT t_msegg INTO s_msegg.
      ON CHANGE OF s_msegg-charg.
        LOOP AT t_mseg INTO s_mseg WHERE charg = s_msegg-charg..
*          DATA: LV_DATE TYPE SY-DATUM,
*                LV_CHAR TYPE CHAR20.
          CLEAR: lv_date,lv_char.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg-matnr
                                           charg = s_mseg-charg
                                           lgort = s_mseg-lgort.
*                                           SOBKZ = S_MSEG1-SOBKZ
          IF sy-subrc = 0.
            gd_tabix = sy-tabix.
            IF s_mseg-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              MODIFY gt_final FROM gw_final TRANSPORTING age_batch1 WHERE charg = gw_final-charg.
              CLEAR : gw_final.
            ENDIF.
          ENDIF.
        ENDLOOP.
      ENDON.
      CLEAR : s_msegg, s_mseg.
    ENDLOOP.
    LOOP AT t_msegg INTO s_msegg.
      ON CHANGE OF s_msegg-charg.
        LOOP AT t_mseg INTO s_mseg WHERE charg = s_msegg-charg..
*            DATA: LV_DATE TYPE SY-DATUM,
*                  LV_CHAR TYPE CHAR20.
          CLEAR: lv_date,lv_char.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg-matnr
                                           charg = s_mseg-charg
                                           lgort = s_mseg-lgort.
*                                           SOBKZ = S_MSEG1-SOBKZ.
          IF sy-subrc = 0.
            IF s_mseg-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              IF gv_aging = gw_final-age_batch1.
                gv_age = 'X'.
              ELSE.
                gv_age = ''.
              ENDIF.
              gv_aging = gw_final-age_batch1.
              CLEAR:lv_date,lv_char .
            ENDIF.
            READ TABLE gt_mchb2 INTO DATA(s_mchb2) WITH KEY werks = '1021'
                                                            matnr = gw_final-matnr
                                                            charg = gw_final-charg
                                                            lgort = gw_final-lgort.
            IF sy-subrc = 0.
            ENDIF.
            IF gv_flag IS INITIAL.
              gv_qty = s_mchb2-clabs - s_mseg-menge.
*              GV_QTY = GW_FINAL-MENGE - S_MSEG1-MENGE.
              CHECK gv_qty GE 0.
              gv_qty2 = s_mseg-menge.

            ELSE.
              gv_qty1 = gv_qty.
              gv_qty = gv_qty - s_mseg-menge.
              IF gv_qty1 EQ 0.
                CHECK gv_qty GE 0.
              ELSE.
                CHECK gv_qty GE 0 OR gv_qty1 GE 0 .
              ENDIF.
              IF gv_age = 'X'.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty = -1.
                  gv_qty1 = -1.
                ELSE.
                  gv_qty2 = gv_qty2 + s_mseg-menge.
                  gw_final-menge = gv_qty2.
                ENDIF.
              ELSE.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty = -1.
                  gv_qty1 = -1.
                ELSE.
                  gv_qty2 = s_mseg-menge.
                  gw_final-menge = s_mseg-menge.
                ENDIF.
              ENDIF.
              gv_qty1 = gv_qty.
            ENDIF.
            gv_flag = 'X'.
*            IF GV_QTY1  IS INITIAL.
            gw_final-menge = s_mseg-menge.
*            ENDIF.
*            GW_FINAL-VBELN = ''.
*            GW_FINAL-POSNR = ''.
            APPEND gw_final TO gt_final_sr33.
            CLEAR : gw_final.
          ELSE.
            CLEAR : gv_flag, gv_qty , gv_qty1, gv_aging, gv_age, gv_qty2.
          ENDIF.

          CLEAR : s_mseg.
        ENDLOOP.
        CLEAR : gv_qty, gv_qty1, gv_flag, gv_aging, gv_age, gv_qty2.
      ENDON.
      CLEAR : s_msegg , s_mseg.
    ENDLOOP.
  ENDIF.
  IF gt_final_sr IS NOT INITIAL.
    SORT gt_final_sr BY menge DESCENDING age_batch1 DESCENDING charg DESCENDING.
    DATA : lv_menge TYPE mseg-menge.
    DATA : lv_bch   TYPE char20.
    DATA(ct_final_sr) = gt_final_sr.
    REFRESH : gt_final_sr.
    SORT ct_final_sr BY vbeln posnr age_batch1.
    LOOP AT ct_final_sr INTO DATA(s_final_sr).
      ON CHANGE OF s_final_sr-vbeln.
        LOOP AT ct_final_sr INTO DATA(ls_final_sr) WHERE vbeln = s_final_sr-vbeln AND charg = s_final_sr-charg.

*          ON CHANGE OF : LS_FINAL_SR-AGE_BATCH1.
          IF lv_bch NE ls_final_sr-age_batch1.
            LOOP AT ct_final_sr INTO DATA(cs_final_sr) WHERE vbeln = s_final_sr-vbeln
                                                       AND charg = s_final_sr-charg
                                                       AND age_batch1 = ls_final_sr-age_batch1.
              lv_menge = lv_menge + cs_final_sr-menge.
              CLEAR : cs_final_sr.
            ENDLOOP.
            lv_bch = ls_final_sr-age_batch1.

            ls_final_sr-menge = lv_menge.
            APPEND ls_final_sr TO gt_final_sr.
          ENDIF.
          CLEAR : ls_final_sr.
          CLEAR : lv_menge.
*          ENDON.
*          ENDON.
        ENDLOOP.
        CLEAR : lv_bch.
      ENDON.
      CLEAR : s_final_sr.
    ENDLOOP.
*    DELETE ADJACENT DUPLICATES FROM GT_FINAL_SR COMPARING AGE_BATCH1.
    SORT gt_final_sr BY menge ASCENDING age_batch1 ASCENDING charg ASCENDING.
    LOOP AT gt_final INTO gw_final.
      gd_tabix = sy-tabix.
      READ TABLE gt_final_sr INTO gw_final_sr WITH KEY mblnr = gw_final-mblnr.
      IF sy-subrc = 0.
        DELETE gt_final INDEX gd_tabix.
      ENDIF.
      CLEAR : gw_final, gw_final_sr.
    ENDLOOP.
  ENDIF.
  IF gt_final_sr33 IS NOT INITIAL.
    SORT gt_final_sr33 BY menge DESCENDING age_batch1 DESCENDING charg DESCENDING.
    DATA : lv_menge3 TYPE mseg-menge.
    DATA : lv_bch3   TYPE char20.
    DATA(ct_final_sr33) = gt_final_sr33.
    REFRESH : gt_final_sr33.
    SORT ct_final_sr33 BY charg vbeln posnr age_batch1.
    LOOP AT ct_final_sr33 INTO DATA(s_final_sr33).
      ON CHANGE OF s_final_sr33-charg.
*      ON CHANGE OF S_FINAL_SR33-VBELN.
        LOOP AT ct_final_sr33 INTO DATA(ls_final_sr33) WHERE vbeln = s_final_sr33-vbeln AND charg = s_final_sr33-charg.

*          ON CHANGE OF : LS_FINAL_SR-AGE_BATCH1.
          IF lv_bch3 NE ls_final_sr33-age_batch1.
            LOOP AT ct_final_sr33 INTO DATA(cs_final_sr33) WHERE vbeln = s_final_sr33-vbeln
                                                       AND charg = s_final_sr33-charg
                                                       AND age_batch1 = ls_final_sr33-age_batch1.
              lv_menge3 = lv_menge3 + cs_final_sr33-menge.
              CLEAR : cs_final_sr33.
            ENDLOOP.
            lv_bch3 = ls_final_sr33-age_batch1.

            ls_final_sr33-menge = lv_menge3.
            APPEND ls_final_sr33 TO gt_final_sr33.
          ENDIF.
          CLEAR : ls_final_sr33.
          CLEAR : lv_menge3.
*          ENDON.
*          ENDON.
        ENDLOOP.
        CLEAR : lv_bch3.
      ENDON.
      CLEAR : s_final_sr33.
    ENDLOOP.
*    DELETE ADJACENT DUPLICATES FROM GT_FINAL_SR33 COMPARING AGE_BATCH1.
    SORT gt_final_sr33 BY menge ASCENDING age_batch1 ASCENDING charg ASCENDING.
    LOOP AT gt_final INTO gw_final.
      gd_tabix = sy-tabix.
      READ TABLE gt_final_sr33 INTO gw_final_sr33 WITH KEY mblnr = gw_final-mblnr.
      IF sy-subrc = 0.
        DELETE gt_final INDEX gd_tabix.
*        DELETE GT_FINAL WHERE VBELN = GW_FINAL_SR33-VBELN.
      ENDIF.
      CLEAR : gw_final, gw_final_sr33.
    ENDLOOP.
    LOOP AT gt_final_sr33 INTO gw_final_sr33.
      gw_final_sr33-vbeln = ''.
      gw_final_sr33-posnr = ''.
      MODIFY gt_final_sr33 FROM gw_final_sr33.
      CLEAR : gw_final_sr33.
    ENDLOOP.
  ENDIF.
  IF gt_final_sr IS NOT INITIAL.
    APPEND LINES OF gt_final_sr TO gt_final.
    SORT gt_final BY mblnr.
  ENDIF.
  IF gt_final_sr33 IS NOT INITIAL.
    APPEND LINES OF gt_final_sr33 TO gt_final.
    SORT gt_final BY mblnr.
  ENDIF.
  LOOP AT gt_final INTO gw_final.
    gw_final-stk_value = gw_final-menge * gw_final-stk_price.
    MODIFY gt_final FROM gw_final TRANSPORTING stk_value.
    CLEAR : gw_final.
  ENDLOOP.

ENDFORM.
******&---------------------------------------------------------------------*
******&      Form  SR_NO2
******&---------------------------------------------------------------------*
******       text
******----------------------------------------------------------------------*
******************************Added by Surbhi dadhich************************
FORM sr_no2.
  REFRESH gt_final_sr1.
  CLEAR : gv_qty, gv_qty1, gv_flag.
  LOOP AT gt_final INTO gw_final.
    IF gw_final-werks = '1021'.
      IF gw_final-charg CP 'OTHER*'.
        APPEND gw_final TO gt_final_sr1.
        CLEAR : gw_final.
      ENDIF.
    ENDIF.
  ENDLOOP.
  IF gt_final_sr1 IS NOT INITIAL.
    IF gt_mska1 IS NOT INITIAL.
      DATA(t_mska1) = gt_mska1[].
      REFRESH : gt_mska1.
      LOOP AT t_mska1 INTO DATA(fs_mska).
        READ TABLE gt_final_sr1 INTO DATA(s_sr1) WITH KEY charg = fs_mska-charg.
        IF sy-subrc = 0.
          APPEND fs_mska TO gt_mska1.
        ELSE.
*          DELETE GT_MSKA1 INDEX SY-TABIX.
        ENDIF.
        CLEAR : fs_mska, s_sr1.
      ENDLOOP.
      IF gt_mska1 IS NOT INITIAL.
        SELECT mblnr, mjahr, bwart, xauto, matnr, werks, lgort, charg, sobkz, kdauf, kdpos, sjahr, smbln, menge,
        cpudt_mkpf, cputm_mkpf, mat_kdauf, mat_kdpos
        FROM mseg INTO TABLE @DATA(t_mseg1)
        FOR ALL ENTRIES IN @gt_mska1
        WHERE werks = '1021'
        AND matnr = @gt_mska1-matnr
        AND charg = @gt_mska1-charg
        AND lgort = @gt_mska1-lgort
        AND sobkz = @gt_mska1-sobkz
        AND mat_kdauf = @gt_mska1-vbeln
        AND mat_kdpos = @gt_mska1-posnr
*      AND XAUTO = 'X'
        AND shkzg = 'S'
        AND sjahr = ' '
        AND smbln = ' '.
      ENDIF.
    ENDIF.
**    IF GV_MSKA = 'X' AND GV_MCHB = 'X'.
**      SELECT MBLNR, MJAHR, BWART, XAUTO, MATNR, WERKS, LGORT, CHARG, SOBKZ, KDAUF, KDPOS, SJAHR, SMBLN, MENGE,
**      CPUDT_MKPF, CPUTM_MKPF, MAT_KDAUF, MAT_KDPOS
**      FROM MSEG INTO TABLE @DATA(T_MSEG1)
**      FOR ALL ENTRIES IN @GT_FINAL_SR1
**      WHERE WERKS = '1021'
**      AND MATNR = @GT_FINAL_SR1-MATNR
**      AND CHARG = @GT_FINAL_SR1-CHARG
**      AND LGORT = @GT_FINAL_SR1-LGORT
**      AND SOBKZ = @GT_FINAL_SR1-SOBKZ
**      AND XAUTO = 'X'
**      AND SJAHR = ' '
**      AND SMBLN = ' '.
**    ELSEIF GV_MSKA = 'X' AND GV_MCHB = ''.
**      SELECT MBLNR MJAHR BWART XAUTO MATNR WERKS LGORT CHARG SOBKZ KDAUF KDPOS SJAHR SMBLN MENGE
**      CPUDT_MKPF CPUTM_MKPF MAT_KDAUF MAT_KDPOS
**      FROM MSEG INTO TABLE T_MSEG1
**      FOR ALL ENTRIES IN GT_FINAL_SR1
**      WHERE WERKS = '1021'
**      AND MATNR = GT_FINAL_SR1-MATNR
**      AND CHARG = GT_FINAL_SR1-CHARG
**      AND LGORT = GT_FINAL_SR1-LGORT
**      AND SOBKZ = GT_FINAL_SR1-SOBKZ
***      AND KDAUF = @GT_FINAL_SR1-VBELN
***      AND KDPOS = @GT_FINAL_SR1-POSNR
**      AND MAT_KDAUF = GT_FINAL_SR1-VBELN
**      AND MAT_KDPOS = GT_FINAL_SR1-POSNR
**      AND XAUTO = 'X'
**      AND SJAHR = ' '
**      AND SMBLN = ' '.
**    ELSEIF GV_MCHB = 'X' AND GV_MSKA = ''.
**      SELECT MBLNR MJAHR BWART XAUTO MATNR WERKS LGORT CHARG SOBKZ KDAUF KDPOS SJAHR SMBLN MENGE
**  CPUDT_MKPF CPUTM_MKPF
**  FROM MSEG INTO TABLE T_MSEG1
**  FOR ALL ENTRIES IN GT_FINAL_SR1
**  WHERE WERKS = '1021'
**  AND MATNR = GT_FINAL_SR1-MATNR
**  AND CHARG = GT_FINAL_SR1-CHARG
**  AND LGORT = GT_FINAL_SR1-LGORT
**  AND SOBKZ = GT_FINAL_SR1-SOBKZ
**  AND XAUTO = 'X'
**  AND SJAHR = ' '
**  AND SMBLN = ' '.
**    ENDIF.
  ENDIF.
  DATA(gt_final_srr) = gt_final_sr1.
  REFRESH gt_final_sr1.
  IF t_mseg1 IS NOT INITIAL.
    SORT t_mseg1 BY cpudt_mkpf DESCENDING.
    DATA(t_mseg11) = t_mseg1[].

    LOOP AT t_mseg11 INTO DATA(s_mseg11).
      ON CHANGE OF s_mseg11-mat_kdauf.
*      ON CHANGE OF S_MSEG11-CHARG.
        LOOP AT t_mseg1 INTO DATA(s_mseg1) WHERE charg = s_mseg11-charg AND mat_kdauf = s_mseg11-mat_kdauf.
          DATA: lv_date TYPE sy-datum,
                lv_char TYPE char20.
          CLEAR: lv_date,lv_char.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg1-matnr
                                                       charg = s_mseg1-charg
                                                       lgort = s_mseg1-lgort
                                                       sobkz = s_mseg1-sobkz
                                                       vbeln = s_mseg1-mat_kdauf
                                                       posnr = s_mseg1-mat_kdpos.
          IF sy-subrc = 0.
            gd_tabix = sy-tabix.
            IF s_mseg1-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg1-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              MODIFY gt_final FROM gw_final TRANSPORTING age_batch1 WHERE charg = gw_final-charg.
              CLEAR : gw_final.
            ENDIF.
          ENDIF.
        ENDLOOP.
      ENDON.
      CLEAR : s_mseg11, s_mseg1.
    ENDLOOP.

    LOOP AT t_mseg11 INTO s_mseg11.
      ON CHANGE OF s_mseg11-mat_kdauf.
*      ON CHANGE OF S_MSEG11-CHARG.
        LOOP AT t_mseg1 INTO s_mseg1 WHERE charg = s_mseg11-charg AND mat_kdauf = s_mseg11-mat_kdauf.
*            DATA: LV_DATE TYPE SY-DATUM,
*                  LV_CHAR TYPE CHAR20.
          CLEAR: lv_date,lv_char.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg1-matnr
                                                       charg = s_mseg1-charg
                                                       lgort = s_mseg1-lgort
                                                       sobkz = s_mseg1-sobkz
                                                       vbeln = s_mseg1-mat_kdauf
                                                       posnr = s_mseg1-mat_kdpos.
          IF sy-subrc = 0.
            IF s_mseg1-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg1-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              IF gv_aging = gw_final-age_batch1.
                gv_age = 'X'.
              ELSE.
                gv_age = ''.
              ENDIF.
              gv_aging = gw_final-age_batch1.
              CLEAR:lv_date,lv_char .
            ENDIF.
            READ TABLE gt_mska1 INTO DATA(s_mska1) WITH KEY werks = '1021'
                                                            matnr = gw_final-matnr
                                                            charg = gw_final-charg
                                                            lgort = gw_final-lgort
                                                            vbeln = gw_final-vbeln
                                                            posnr = gw_final-posnr.
            IF sy-subrc = 0.
            ENDIF.
            IF gv_flag IS INITIAL.
              gv_qty = s_mska1-kalab - s_mseg1-menge.
*              GV_QTY = GW_FINAL-MENGE - S_MSEG1-MENGE.
              CHECK gv_qty GE 0.
              gv_qty2 = s_mseg1-menge.

            ELSE.
              gv_qty1 = gv_qty.
              gv_qty = gv_qty - s_mseg1-menge.
              IF gv_qty1 EQ 0.
                CHECK gv_qty GE 0.
              ELSE.
                CHECK gv_qty GE 0 OR gv_qty1 GE 0 .
              ENDIF.
              IF gv_age = 'X'.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty = -1.
                  gv_qty1 = -1.
                ELSE.
                  gv_qty2 = gv_qty2 + s_mseg1-menge.
                  gw_final-menge = gv_qty2.
                ENDIF.
              ELSE.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty = -1.
                  gv_qty1 = -1.
                ELSE.
                  gv_qty2 = s_mseg1-menge.
                  gw_final-menge = s_mseg1-menge.
                ENDIF.
              ENDIF.
              gv_qty1 = gv_qty.
            ENDIF.
            gv_flag = 'X'.
            IF gv_qty1  IS INITIAL.
              gw_final-menge = s_mseg1-menge.
            ENDIF.

            APPEND gw_final TO gt_final_sr1.
            CLEAR : gw_final.
          ELSE.
            CLEAR : gv_flag, gv_qty , gv_qty1, gv_aging, gv_age, gv_qty2.
          ENDIF.

          CLEAR : s_mseg1.
        ENDLOOP.
        CLEAR : gv_qty, gv_qty1, gv_flag, gv_aging, gv_age, gv_qty2.
      ENDON.
      CLEAR : s_mseg11 , s_mseg1.
    ENDLOOP.
  ENDIF.
  REFRESH : t_mseg1.


  IF gt_final_srr IS NOT INITIAL.
    IF gt_mchb1 IS NOT INITIAL.
      DATA(t_mchb1) = gt_mchb1[].
      REFRESH : gt_mchb1.
      LOOP AT t_mchb1 INTO DATA(fs_mchb).
        READ TABLE gt_final_srr INTO DATA(s_srr) WITH KEY charg = fs_mchb-charg.
        IF sy-subrc = 0.
          APPEND fs_mchb TO gt_mchb1.
        ELSE.
*          DELETE GT_MCHB1 FROM FS_MCHB.
        ENDIF.
        CLEAR : fs_mska, s_sr1.
      ENDLOOP.
      REFRESH : t_mseg1.
      IF gt_mchb1 IS NOT INITIAL.
        SELECT mblnr mjahr bwart xauto matnr werks lgort charg sobkz kdauf kdpos sjahr smbln menge
        cpudt_mkpf cputm_mkpf mat_kdauf mat_kdpos
        FROM mseg INTO TABLE t_mseg1
        FOR ALL ENTRIES IN gt_mchb1
        WHERE werks = '1021'
        AND matnr = gt_mchb1-matnr
        AND charg = gt_mchb1-charg
        AND lgort = gt_mchb1-lgort
*      AND XAUTO = 'X'
        AND shkzg = 'S'
        AND sjahr = ''
        AND smbln = ''
        AND sobkz EQ ''.
      ENDIF.
    ENDIF.
  ENDIF.
  REFRESH : gt_final_srr.
  IF t_mseg1 IS NOT INITIAL.
    SORT t_mseg1 BY cpudt_mkpf DESCENDING.
    t_mseg11 = t_mseg1[].

    LOOP AT t_mseg11 INTO s_mseg11.
      ON CHANGE OF s_mseg11-charg.
        LOOP AT t_mseg1 INTO s_mseg1 WHERE charg = s_mseg11-charg..
*          DATA: LV_DATE TYPE SY-DATUM,
*                LV_CHAR TYPE CHAR20.
          CLEAR: lv_date,lv_char.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg1-matnr
                                           charg = s_mseg1-charg
                                           lgort = s_mseg1-lgort.
*                                           SOBKZ = S_MSEG1-SOBKZ
          IF sy-subrc = 0.
            gd_tabix = sy-tabix.
            IF s_mseg1-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg1-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              MODIFY gt_final FROM gw_final TRANSPORTING age_batch1 WHERE charg = gw_final-charg.
              CLEAR : gw_final.
            ENDIF.
          ENDIF.
        ENDLOOP.
      ENDON.
      CLEAR : s_mseg11, s_mseg1.
    ENDLOOP.

    LOOP AT t_mseg11 INTO s_mseg11.
      ON CHANGE OF s_mseg11-charg.
        LOOP AT t_mseg1 INTO s_mseg1 WHERE charg = s_mseg11-charg..
*            DATA: LV_DATE TYPE SY-DATUM,
*                  LV_CHAR TYPE CHAR20.
          CLEAR: lv_date,lv_char.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg1-matnr
                                           charg = s_mseg1-charg
                                           lgort = s_mseg1-lgort.
*                                           SOBKZ = S_MSEG1-SOBKZ.
          IF sy-subrc = 0.
            IF s_mseg1-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg1-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              IF gv_aging = gw_final-age_batch1.
                gv_age = 'X'.
              ELSE.
                gv_age = ''.
              ENDIF.
              gv_aging = gw_final-age_batch1.
              CLEAR:lv_date,lv_char .
            ENDIF.
            READ TABLE gt_mchb1 INTO DATA(s_mchb1) WITH KEY werks = '1021'
                                                            matnr = gw_final-matnr
                                                            charg = gw_final-charg
                                                            lgort = gw_final-lgort.
            IF sy-subrc = 0.
            ENDIF.
            IF gv_flag IS INITIAL.
              gv_qty = s_mchb1-clabs - s_mseg1-menge.
*              GV_QTY = GW_FINAL-MENGE - S_MSEG1-MENGE.
              CHECK gv_qty GE 0.
              gv_qty2 = s_mseg1-menge.

            ELSE.
              gv_qty1 = gv_qty.
              gv_qty = gv_qty - s_mseg1-menge.
              IF gv_qty1 EQ 0.
                CHECK gv_qty GE 0.
              ELSE.
                CHECK gv_qty GE 0 OR gv_qty1 GE 0 .
              ENDIF.
              IF gv_age = 'X'.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty = -1.
                  gv_qty1 = -1.
                ELSE.
                  gv_qty2 = gv_qty2 + s_mseg1-menge.
                  gw_final-menge = gv_qty2.
                ENDIF.
              ELSE.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty = -1.
                  gv_qty1 = -1.
                ELSE.
                  gv_qty2 = s_mseg1-menge.
                  gw_final-menge = s_mseg1-menge.
                ENDIF.
              ENDIF.
              gv_qty1 = gv_qty.
            ENDIF.
            gv_flag = 'X'.
            IF gv_qty1  IS INITIAL.
              gw_final-menge = s_mseg1-menge.
            ENDIF.
*            GW_FINAL-VBELN = ''.
*            GW_FINAL-POSNR = ''.
            APPEND gw_final TO gt_final_sr11.
            CLEAR : gw_final.
          ELSE.
            CLEAR : gv_flag, gv_qty , gv_qty1, gv_aging, gv_age, gv_qty2.
          ENDIF.

          CLEAR : s_mseg1.
        ENDLOOP.
        CLEAR : gv_qty, gv_qty1, gv_flag, gv_aging, gv_age, gv_qty2.
      ENDON.
      CLEAR : s_mseg11 , s_mseg1.
    ENDLOOP.

  ENDIF.
  IF gt_final_sr1 IS NOT INITIAL.
    SORT gt_final_sr1 BY menge DESCENDING age_batch1 DESCENDING charg DESCENDING.
    DATA : lv_menge TYPE mseg-menge.
    DATA : lv_bch   TYPE char20.
    DATA(ct_final_sr1) = gt_final_sr1.
    REFRESH : gt_final_sr1.
    SORT ct_final_sr1 BY vbeln posnr age_batch1.
    LOOP AT ct_final_sr1 INTO DATA(s_final_sr1).
      ON CHANGE OF s_final_sr1-vbeln.
        LOOP AT ct_final_sr1 INTO DATA(ls_final_sr1) WHERE vbeln = s_final_sr1-vbeln AND charg = s_final_sr1-charg.

*          ON CHANGE OF : LS_FINAL_SR-AGE_BATCH1.
          IF lv_bch NE ls_final_sr1-age_batch1.
            LOOP AT ct_final_sr1 INTO DATA(cs_final_sr1) WHERE vbeln = s_final_sr1-vbeln
                                                       AND charg = s_final_sr1-charg
                                                       AND age_batch1 = ls_final_sr1-age_batch1.
              lv_menge = lv_menge + cs_final_sr1-menge.
              CLEAR : cs_final_sr1.
            ENDLOOP.
            lv_bch = ls_final_sr1-age_batch1.

            ls_final_sr1-menge = lv_menge.
            APPEND ls_final_sr1 TO gt_final_sr1.
          ENDIF.
          CLEAR : ls_final_sr1.
          CLEAR : lv_menge.
*          ENDON.
*          ENDON.
        ENDLOOP.
        CLEAR : lv_bch.
      ENDON.
      CLEAR : s_final_sr1.
    ENDLOOP.
**    DELETE ADJACENT DUPLICATES FROM GT_FINAL_SR1 COMPARING AGE_BATCH1.
    SORT gt_final_sr1 BY menge ASCENDING age_batch1 ASCENDING charg ASCENDING.
    LOOP AT gt_final INTO gw_final.
      gd_tabix = sy-tabix.
      READ TABLE gt_final_sr1 INTO gw_final_sr1 WITH KEY mblnr = gw_final-mblnr.
      IF sy-subrc = 0.
        DELETE gt_final INDEX gd_tabix.
      ENDIF.
      CLEAR : gw_final, gw_final_sr1.
    ENDLOOP.
  ENDIF.
  IF gt_final_sr11 IS NOT INITIAL.
    SORT gt_final_sr11 BY menge DESCENDING age_batch1 DESCENDING charg DESCENDING.
    DATA : lv_menge1 TYPE mseg-menge.
    DATA : lv_bch1   TYPE char20.
    DATA(ct_final_sr11) = gt_final_sr11.
    REFRESH : gt_final_sr11.
    SORT ct_final_sr11 BY vbeln posnr age_batch1.
    LOOP AT ct_final_sr11 INTO DATA(s_final_sr11).
      ON CHANGE OF s_final_sr11-vbeln.
        LOOP AT ct_final_sr11 INTO DATA(ls_final_sr11) WHERE vbeln = s_final_sr11-vbeln AND charg = s_final_sr11-charg.

*          ON CHANGE OF : LS_FINAL_SR-AGE_BATCH1.
          IF lv_bch1 NE ls_final_sr11-age_batch1.
            LOOP AT ct_final_sr11 INTO DATA(cs_final_sr11) WHERE vbeln = s_final_sr11-vbeln
                                                       AND charg = s_final_sr11-charg
                                                       AND age_batch1 = ls_final_sr11-age_batch1.
              lv_menge1 = lv_menge1 + cs_final_sr11-menge.
              CLEAR : cs_final_sr11.
            ENDLOOP.
            lv_bch1 = ls_final_sr11-age_batch1.

            ls_final_sr11-menge = lv_menge1.
            APPEND ls_final_sr11 TO gt_final_sr11.
          ENDIF.
          CLEAR : ls_final_sr11.
          CLEAR : lv_menge1.
*          ENDON.
*          ENDON.
        ENDLOOP.
        CLEAR : lv_bch1.
      ENDON.
      CLEAR : s_final_sr11.
    ENDLOOP.
*    DELETE ADJACENT DUPLICATES FROM GT_FINAL_SR11 COMPARING AGE_BATCH1.
    SORT gt_final_sr11 BY menge ASCENDING age_batch1 ASCENDING charg ASCENDING.
    LOOP AT gt_final INTO gw_final.
      gd_tabix = sy-tabix.
      READ TABLE gt_final_sr11 INTO gw_final_sr11 WITH KEY mblnr = gw_final-mblnr.
      IF sy-subrc = 0.
        DELETE gt_final INDEX gd_tabix.
      ENDIF.
      CLEAR : gw_final, gw_final_sr11.
    ENDLOOP.
    LOOP AT gt_final_sr11 INTO gw_final_sr11.
      gw_final_sr11-vbeln = ''.
      gw_final_sr11-posnr = ''.
      MODIFY gt_final_sr11 FROM gw_final_sr11.
      CLEAR : gw_final_sr11.
    ENDLOOP.
  ENDIF.
  IF gt_final_sr1 IS NOT INITIAL.
    APPEND LINES OF gt_final_sr1 TO gt_final.
    SORT gt_final BY mblnr.
  ENDIF.
  IF gt_final_sr11 IS NOT INITIAL.
    APPEND LINES OF gt_final_sr11 TO gt_final.
    SORT gt_final BY mblnr.
  ENDIF.
  LOOP AT gt_final INTO gw_final.
    gw_final-stk_value = gw_final-menge * gw_final-stk_price.
    MODIFY gt_final FROM gw_final TRANSPORTING stk_value.
    CLEAR : gw_final.
  ENDLOOP.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  SR_NO3
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*************************Added by Surbhi dadhich************************
FORM sr_no3.
  REFRESH gt_final_sr2.
  CLEAR : gv_qty, gv_qty1, gv_flag.
  LOOP AT gt_final INTO gw_final.
    IF gw_final-werks = '1021' AND gw_final-lgort = 'FP01'.
      IF gw_final-charg NP 'OTHER*'.
        APPEND gw_final TO gt_final_sr2.
        CLEAR : gw_final.
      ENDIF.
    ENDIF.
  ENDLOOP.
  IF gt_final_sr2 IS NOT INITIAL.
    SELECT mblnr, mjahr, bwart, xauto, matnr, werks, lgort, charg, sobkz, kdauf, kdpos, sjahr, smbln, menge,
    cpudt_mkpf, cputm_mkpf,  mat_kdauf, mat_kdpos
    FROM mseg INTO TABLE @DATA(t_mseg2)
    FOR ALL ENTRIES IN @gt_final_sr2
    WHERE werks = '1021'
    AND matnr = @gt_final_sr2-matnr
    AND charg = @gt_final_sr2-charg
    AND lgort = @gt_final_sr2-lgort
    AND sobkz = @gt_final_sr2-sobkz
    AND mat_kdauf = @gt_final_sr2-vbeln
    AND mat_kdpos = @gt_final_sr2-posnr
    AND xauto = 'X'
    AND sjahr = ' '
    AND smbln = ' '.
  ENDIF.
  REFRESH gt_final_sr2.
  IF t_mseg2 IS NOT INITIAL.
    SORT t_mseg2 BY charg cpudt_mkpf DESCENDING.
    DATA(t_mseg22) = t_mseg2[].
    LOOP AT t_mseg22 INTO DATA(s_mseg22).
      ON CHANGE OF s_mseg22-charg.
        LOOP AT t_mseg2 INTO DATA(s_mseg2) WHERE charg = s_mseg22-charg.
          DATA: lv_date TYPE sy-datum,
                lv_char TYPE char20.
          CLEAR: lv_date,lv_char.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg2-matnr
                                                       charg = s_mseg2-charg
                                                       lgort = s_mseg2-lgort
                                                       sobkz = s_mseg2-sobkz
                                                       vbeln = s_mseg2-mat_kdauf
                                                       posnr = s_mseg2-mat_kdpos.
          IF sy-subrc = 0.
            IF gv_flag IS INITIAL.
              gv_qty = gw_final-menge - s_mseg2-menge.
              CHECK gv_qty GE 0.
            ELSE.
              gv_qty1 = gv_qty.
              gv_qty = gv_qty - s_mseg2-menge.
              IF gv_qty1 EQ 0.
                CHECK gv_qty GE 0.
              ELSE.
                CHECK gv_qty GE 0 OR gv_qty1 GE 0 .
              ENDIF.
              gv_qty1 = gv_qty.
            ENDIF.
            gv_flag = 'X'.
            gw_final-menge = s_mseg2-menge.
            IF s_mseg2-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg2-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              CLEAR:lv_date,lv_char .
            ENDIF.
            APPEND gw_final TO gt_final_sr2.
            CLEAR : gw_final.
          ELSE.
            CLEAR : gv_flag, gv_qty.
          ENDIF.
          CLEAR : s_mseg2.
        ENDLOOP.
        CLEAR : gv_qty, gv_qty1, gv_flag.
      ENDON.
      CLEAR : s_mseg22 , s_mseg2.
    ENDLOOP.
    LOOP AT gt_final INTO gw_final.
      gd_tabix = sy-tabix.
      READ TABLE gt_final_sr2 INTO gw_final_sr2 WITH KEY mblnr = gw_final-mblnr.
      IF sy-subrc = 0.
        DELETE gt_final INDEX gd_tabix.
      ENDIF.
      CLEAR : gw_final, gw_final_sr2.
    ENDLOOP.
  ENDIF.
  IF gt_final_sr2 IS NOT INITIAL.
    APPEND LINES OF gt_final_sr2 TO gt_final.
    SORT gt_final BY mblnr.
  ENDIF.
ENDFORM.

FORM sr_no4.
  REFRESH gt_final_sr2.
  CLEAR : gv_qty, gv_qty1, gv_flag.
  LOOP AT gt_final INTO gw_final.
    IF gw_final-werks = '1021' AND gw_final-lgort = 'FP01'.
      IF gw_final-charg NP 'OTHER*'.
        APPEND gw_final TO gt_final_sr2.
        CLEAR : gw_final.
      ENDIF.
    ENDIF.
  ENDLOOP.
  IF gt_final_sr2 IS NOT INITIAL.
    IF gt_mska3 IS NOT INITIAL.
      DATA(t_mska3) = gt_mska3[].
      REFRESH : gt_mska3.
      LOOP AT t_mska3 INTO DATA(fs_mska3).
        READ TABLE gt_final_sr2 INTO DATA(s_srr2) WITH KEY charg = fs_mska3-charg.
        IF sy-subrc = 0.
          APPEND fs_mska3 TO gt_mska3.
        ELSE.
*          DELETE GT_MSKA3 INDEX SY-TABIX.
        ENDIF.
        CLEAR : fs_mska3, s_srr2.
      ENDLOOP.
      IF gt_mska3 IS NOT INITIAL.
        SELECT mblnr, mjahr, bwart, xauto, matnr, werks, lgort, charg, sobkz, kdauf, kdpos, sjahr, smbln, menge,
        cpudt_mkpf, cputm_mkpf, mat_kdauf, mat_kdpos
        FROM mseg INTO TABLE @DATA(t_mseg2)
        FOR ALL ENTRIES IN @gt_mska3
        WHERE werks = '1021'
        AND matnr = @gt_mska3-matnr
        AND charg = @gt_mska3-charg
        AND lgort = @gt_mska3-lgort
        AND sobkz = @gt_mska3-sobkz
        AND mat_kdauf = @gt_mska3-vbeln
        AND mat_kdpos = @gt_mska3-posnr
*      AND XAUTO = 'X'
        AND shkzg EQ 'S'
        AND sjahr = ' '
        AND smbln = ' '.
      ENDIF.
    ENDIF.
  ENDIF.
  DATA(gt_final2_srr) = gt_final_sr2.
  REFRESH gt_final_sr2.
  IF t_mseg2 IS NOT INITIAL.
    SORT t_mseg2 BY charg cpudt_mkpf DESCENDING.
    DATA(t_mseg22) = t_mseg2[].
    LOOP AT t_mseg22 INTO DATA(s_mseg22).
      ON CHANGE OF s_mseg22-mat_kdauf.
*      ON CHANGE OF S_MSEG22-CHARG.
        LOOP AT t_mseg2 INTO DATA(s_mseg2) WHERE charg = s_mseg22-charg AND mat_kdauf = s_mseg22-mat_kdauf.
          DATA: lv_date TYPE sy-datum,
                lv_char TYPE char20.
          CLEAR: lv_date,lv_char.
*          IF GV_MSKA = 'X'.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg2-matnr
                                                       charg = s_mseg2-charg
                                                       lgort = s_mseg2-lgort
                                                       sobkz = s_mseg2-sobkz
                                                       vbeln = s_mseg2-mat_kdauf
                                                       posnr = s_mseg2-mat_kdpos.
          IF sy-subrc = 0.
            gd_tabix = sy-tabix.
            IF s_mseg2-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg2-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              MODIFY gt_final FROM gw_final TRANSPORTING age_batch1 WHERE charg = gw_final-charg.
              CLEAR : gw_final.
            ENDIF.
          ENDIF.
*          ELSEIF GV_MCHB = 'X'.
*            READ TABLE GT_FINAL INTO GW_FINAL WITH KEY MATNR = S_MSEG2-MATNR
*                                             CHARG = S_MSEG2-CHARG
*                                             LGORT = S_MSEG2-LGORT
*                                             SOBKZ = S_MSEG2-SOBKZ.
*            IF SY-SUBRC = 0.
*              GD_TABIX = SY-TABIX.
*              IF S_MSEG2-CPUDT_MKPF  IS NOT INITIAL .
*                LV_DATE =  S_MSEG2-CPUDT_MKPF.
*                PERFORM CALCULATE_DATE_RANGE USING LV_DATE CHANGING LV_CHAR .
*                GW_FINAL-AGE_BATCH1  = LV_CHAR .
*                MODIFY GT_FINAL FROM GW_FINAL TRANSPORTING AGE_BATCH1 WHERE CHARG = GW_FINAL-CHARG.
*                CLEAR : GW_FINAL.
*              ENDIF.
*            ENDIF.
*          ENDIF.
        ENDLOOP.
      ENDON.
      CLEAR : s_mseg22, s_mseg2.
    ENDLOOP.

    LOOP AT t_mseg22 INTO s_mseg22.
      ON CHANGE OF s_mseg22-mat_kdauf.
        LOOP AT t_mseg2 INTO s_mseg2 WHERE charg = s_mseg22-charg AND mat_kdauf = s_mseg22-mat_kdauf.
*          DATA: LV_DATE TYPE SY-DATUM,
*                LV_CHAR TYPE CHAR20.
          CLEAR: lv_date,lv_char.
*          IF GV_MSKA = 'X'.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg2-matnr
                                                       charg = s_mseg2-charg
                                                       lgort = s_mseg2-lgort
                                                       sobkz = s_mseg2-sobkz
                                                       vbeln = s_mseg2-mat_kdauf
                                                       posnr = s_mseg2-mat_kdpos.
          IF sy-subrc = 0.
            IF s_mseg2-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg2-cpudt_mkpf.
              CLEAR : gv_age.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              IF gv_aging = gw_final-age_batch1.
                gv_age = 'X'.
              ELSE.
                gv_age = ''.
              ENDIF.
              gv_aging = gw_final-age_batch1.
              CLEAR:lv_date,lv_char .
            ENDIF.
            READ TABLE gt_mska3 INTO DATA(s_mska3) WITH KEY werks = '1021'
                                                          matnr = gw_final-matnr
                                                          charg = gw_final-charg
                                                          lgort = gw_final-lgort
                                                          vbeln = gw_final-vbeln
                                                          posnr = gw_final-posnr.
            IF sy-subrc = 0.
            ENDIF.
            IF gv_flag IS INITIAL.
              gv_qty = s_mska3-kalab - s_mseg2-menge.
*                GV_QTY = GW_FINAL-MENGE - S_MSEG2-MENGE.
              CHECK gv_qty GE 0.
              gv_qty2 = s_mseg2-menge.
            ELSE.
              gv_qty1 = gv_qty.
              gv_qty = gv_qty - s_mseg2-menge.
              IF gv_qty1 EQ 0.
                CHECK gv_qty GE 0.
              ELSE.
                CHECK gv_qty GE 0 OR gv_qty1 GE 0 .
              ENDIF.
              IF gv_age = 'X'.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty1 = -1.
                  gv_qty = -1.
                ELSE.
                  gv_qty2 = gv_qty2 + s_mseg2-menge.
                  gw_final-menge = gv_qty2.
*                  GW_FINAL-MENGE = S_MSEG2-MENGE + GV_QTY1.
                ENDIF.
              ELSE.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty = -1.
                  gv_qty1 = -1.
                ELSE.
                  gv_qty2 = s_mseg2-menge.
                  gw_final-menge = s_mseg2-menge.
                ENDIF.
*                GW_FINAL-MENGE = S_MSEG2-MENGE.
              ENDIF.
              gv_qty1 = gv_qty.
            ENDIF.
            gv_flag = 'X'.
            IF gv_qty1  IS INITIAL.
              gw_final-menge = s_mseg2-menge.
            ENDIF.
            APPEND gw_final TO gt_final_sr2.
            CLEAR : gw_final.
          ELSE.
            CLEAR : gv_flag, gv_qty, gv_qty1, gv_aging, gv_age, gv_qty2.
          ENDIF.
*          ELSEIF GV_MCHB = 'X'.
*            READ TABLE GT_FINAL INTO GW_FINAL WITH KEY MATNR = S_MSEG2-MATNR
*                                             CHARG = S_MSEG2-CHARG
*                                             LGORT = S_MSEG2-LGORT
*                                             SOBKZ = S_MSEG2-SOBKZ.
*            IF SY-SUBRC = 0.
*              IF S_MSEG2-CPUDT_MKPF  IS NOT INITIAL .
*                LV_DATE =  S_MSEG2-CPUDT_MKPF.
*                CLEAR : GV_AGE.
*                PERFORM CALCULATE_DATE_RANGE USING LV_DATE CHANGING LV_CHAR .
*                GW_FINAL-AGE_BATCH1  = LV_CHAR .
*                IF GV_AGING = GW_FINAL-AGE_BATCH1.
*                  GV_AGE = 'X'.
*                ELSE.
*                  GV_AGE = ''.
*                ENDIF.
*                GV_AGING = GW_FINAL-AGE_BATCH1.
*                CLEAR:LV_DATE,LV_CHAR .
*              ENDIF.
*              IF GV_FLAG IS INITIAL.
*                GV_QTY = GW_FINAL-MENGE - S_MSEG2-MENGE.
*                CHECK GV_QTY GE 0.
*                GV_QTY2 = S_MSEG2-MENGE.
*              ELSE.
*                GV_QTY1 = GV_QTY.
*                GV_QTY = GV_QTY - S_MSEG2-MENGE.
*                IF GV_QTY1 EQ 0.
*                  CHECK GV_QTY GE 0.
*                ELSE.
*                  CHECK GV_QTY GE 0 OR GV_QTY1 GE 0 .
*                ENDIF.
*                IF GV_AGE = 'X'.
*                  IF GW_FINAL-AGE_BATCH1 = 'More then 365'.
*                    GW_FINAL-MENGE = GV_QTY1.
*                    GV_QTY1 = -1.
*                    GV_QTY = -1.
*                  ELSE.
*                    GV_QTY2 = GV_QTY2 + S_MSEG2-MENGE.
*                    GW_FINAL-MENGE = GV_QTY2.
**                  GW_FINAL-MENGE = S_MSEG2-MENGE + GV_QTY1.
*                  ENDIF.
*                ELSE.
*                  IF GW_FINAL-AGE_BATCH1 = 'More then 365'.
*                    GW_FINAL-MENGE = GV_QTY1.
*                    GV_QTY = -1.
*                    GV_QTY1 = -1.
*                  ELSE.
*                    GV_QTY2 = S_MSEG2-MENGE.
*                    GW_FINAL-MENGE = S_MSEG2-MENGE.
*                  ENDIF.
**                GW_FINAL-MENGE = S_MSEG2-MENGE.
*                ENDIF.
*                GV_QTY1 = GV_QTY.
*              ENDIF.
*              GV_FLAG = 'X'.
*              IF GV_QTY1  IS INITIAL.
*                GW_FINAL-MENGE = S_MSEG2-MENGE.
*              ENDIF.
*              APPEND GW_FINAL TO GT_FINAL_SR2.
*              CLEAR : GW_FINAL.
*            ELSE.
*              CLEAR : GV_FLAG, GV_QTY, GV_QTY1, GV_AGING, GV_AGE, GV_QTY2.
*            ENDIF.
*          ENDIF.
          CLEAR : s_mseg2.
        ENDLOOP.
        CLEAR : gv_qty, gv_qty1, gv_flag, gv_aging, gv_age, gv_qty2.
      ENDON.
      CLEAR : s_mseg22 , s_mseg2.
    ENDLOOP.
  ENDIF.
  REFRESH : t_mseg2.
  IF gt_final2_srr IS NOT INITIAL.
    IF gt_mchb3 IS NOT INITIAL.
      DATA(t_mchb3) = gt_mchb3[].
      REFRESH : gt_mchb3.
      LOOP AT t_mchb3 INTO DATA(fs_mchb3).
        READ TABLE gt_final2_srr INTO DATA(s_srr3) WITH KEY charg = fs_mchb3-charg.
        IF sy-subrc = 0.
          APPEND fs_mchb3 TO gt_mchb3.
        ELSE.
*          DELETE GT_MCHB3 FROM FS_MCHB3.
        ENDIF.
        CLEAR : fs_mchb3, s_srr3.
      ENDLOOP.
      REFRESH : t_mseg2.
      IF gt_mchb3 IS NOT INITIAL.
        SELECT mblnr mjahr bwart xauto matnr werks lgort charg sobkz kdauf kdpos sjahr smbln menge
        cpudt_mkpf cputm_mkpf mat_kdauf mat_kdpos
        FROM mseg INTO TABLE t_mseg2
        FOR ALL ENTRIES IN gt_mchb3
        WHERE werks = '1021'
        AND matnr = gt_mchb3-matnr
        AND charg = gt_mchb3-charg
        AND lgort = gt_mchb3-lgort
*      AND XAUTO = 'X'
        AND shkzg EQ 'S'
        AND sjahr = ''
        AND smbln = ''
        AND sobkz EQ ''.
      ENDIF.
    ENDIF.
  ENDIF.
  REFRESH : gt_final2_srr.
  IF t_mseg2 IS NOT INITIAL.
    SORT t_mseg2 BY cpudt_mkpf DESCENDING.
    t_mseg22[] = t_mseg2[].
    LOOP AT t_mseg22 INTO s_mseg22.
      ON CHANGE OF s_mseg22-charg.
        LOOP AT t_mseg2 INTO s_mseg2 WHERE charg = s_mseg22-charg.
*          DATA: LV_DATE TYPE SY-DATUM,
*                LV_CHAR TYPE CHAR20.
          CLEAR: lv_date,lv_char.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg2-matnr
                                           charg = s_mseg2-charg
                                           lgort = s_mseg2-lgort.
*                                           SOBKZ = S_MSEG1-SOBKZ
          IF sy-subrc = 0.
            gd_tabix = sy-tabix.
            IF s_mseg2-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg2-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              MODIFY gt_final FROM gw_final TRANSPORTING age_batch1 WHERE charg = gw_final-charg.
              CLEAR : gw_final.
            ENDIF.
          ENDIF.
        ENDLOOP.
      ENDON.
      CLEAR : s_mseg22, s_mseg2.
    ENDLOOP.
    LOOP AT t_mseg22 INTO s_mseg22.
      ON CHANGE OF s_mseg22-charg.
        LOOP AT t_mseg2 INTO s_mseg2 WHERE charg = s_mseg22-charg..
*            DATA: LV_DATE TYPE SY-DATUM,
*                  LV_CHAR TYPE CHAR20.
          CLEAR: lv_date,lv_char.
          READ TABLE gt_final INTO gw_final WITH KEY matnr = s_mseg2-matnr
                                           charg = s_mseg2-charg
                                           lgort = s_mseg2-lgort.
*                                           SOBKZ = S_MSEG1-SOBKZ.
          IF sy-subrc = 0.
            IF s_mseg2-cpudt_mkpf  IS NOT INITIAL .
              lv_date =  s_mseg2-cpudt_mkpf.
              PERFORM calculate_date_range USING lv_date CHANGING lv_char .
              gw_final-age_batch1  = lv_char .
              IF gv_aging = gw_final-age_batch1.
                gv_age = 'X'.
              ELSE.
                gv_age = ''.
              ENDIF.
              gv_aging = gw_final-age_batch1.
              CLEAR:lv_date,lv_char .
            ENDIF.
            READ TABLE gt_mchb3 INTO DATA(s_mchb3) WITH KEY werks = '1021'
                                                            matnr = gw_final-matnr
                                                            charg = gw_final-charg
                                                            lgort = gw_final-lgort.
            IF sy-subrc = 0.
            ENDIF.
            IF gv_flag IS INITIAL.
              gv_qty = s_mchb3-clabs - s_mseg2-menge.
*              GV_QTY = GW_FINAL-MENGE - S_MSEG1-MENGE.
              CHECK gv_qty GE 0.
              gv_qty2 = s_mseg2-menge.

            ELSE.
              gv_qty1 = gv_qty.
              gv_qty = gv_qty - s_mseg2-menge.
              IF gv_qty1 EQ 0.
                CHECK gv_qty GE 0.
              ELSE.
                CHECK gv_qty GE 0 OR gv_qty1 GE 0 .
              ENDIF.
              IF gv_age = 'X'.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty = -1.
                  gv_qty1 = -1.
                ELSE.
                  gv_qty2 = gv_qty2 + s_mseg2-menge.
                  gw_final-menge = gv_qty2.
                ENDIF.
              ELSE.
                IF gw_final-age_batch1 = 'More then 365'.
                  gw_final-menge = gv_qty1.
                  gv_qty = -1.
                  gv_qty1 = -1.
                ELSE.
                  gv_qty2 = s_mseg2-menge.
                  gw_final-menge = s_mseg2-menge.
                ENDIF.
              ENDIF.
              gv_qty1 = gv_qty.
            ENDIF.
            gv_flag = 'X'.
            IF gv_qty1  IS INITIAL.
              gw_final-menge = s_mseg2-menge.
            ENDIF.
*            GW_FINAL-VBELN = ''.
*            GW_FINAL-POSNR = ''.
            APPEND gw_final TO gt_final_sr22.
            CLEAR : gw_final.
          ELSE.
            CLEAR : gv_flag, gv_qty , gv_qty1, gv_aging, gv_age, gv_qty2.
          ENDIF.

          CLEAR : s_mseg2.
        ENDLOOP.
        CLEAR : gv_qty, gv_qty1, gv_flag, gv_aging, gv_age, gv_qty2.
      ENDON.
      CLEAR : s_mseg22 , s_mseg2.
    ENDLOOP.
  ENDIF.

  IF gt_final_sr2 IS NOT INITIAL.
    SORT gt_final_sr2 BY menge DESCENDING age_batch1 DESCENDING charg DESCENDING.
    DATA : lv_menge5 TYPE mseg-menge.
    DATA : lv_bch5   TYPE char20.
    DATA(ct_final_sr2) = gt_final_sr2.
    REFRESH : gt_final_sr2.
    SORT ct_final_sr2 BY vbeln posnr age_batch1.
    LOOP AT ct_final_sr2 INTO DATA(s_final_sr2).
      ON CHANGE OF s_final_sr2-vbeln.
        LOOP AT ct_final_sr2 INTO DATA(ls_final_sr2) WHERE vbeln = s_final_sr2-vbeln AND charg = s_final_sr2-charg.

*          ON CHANGE OF : LS_FINAL_SR-AGE_BATCH1.
          IF lv_bch5 NE ls_final_sr2-age_batch1.
            LOOP AT ct_final_sr2 INTO DATA(cs_final_sr2) WHERE vbeln = s_final_sr2-vbeln
                                                       AND charg = s_final_sr2-charg
                                                       AND age_batch1 = ls_final_sr2-age_batch1.
              lv_menge5 = lv_menge5 + cs_final_sr2-menge.
              CLEAR : cs_final_sr2.
            ENDLOOP.
            lv_bch5 = ls_final_sr2-age_batch1.

            ls_final_sr2-menge = lv_menge5.
            APPEND ls_final_sr2 TO gt_final_sr2.
          ENDIF.
          CLEAR : ls_final_sr2.
          CLEAR : lv_menge5.
*          ENDON.
*          ENDON.
        ENDLOOP.
        CLEAR : lv_bch5.
      ENDON.
      CLEAR : s_final_sr2.
    ENDLOOP.
*    DELETE ADJACENT DUPLICATES FROM GT_FINAL_SR2 COMPARING AGE_BATCH1.
    SORT gt_final_sr2 BY menge ASCENDING age_batch1 ASCENDING charg ASCENDING.
    LOOP AT gt_final INTO gw_final.
      gd_tabix = sy-tabix.
      READ TABLE gt_final_sr2 INTO gw_final_sr2 WITH KEY mblnr = gw_final-mblnr.
      IF sy-subrc = 0.
        DELETE gt_final INDEX gd_tabix.
      ENDIF.
      CLEAR : gw_final, gw_final_sr2.
    ENDLOOP.
  ENDIF.
  IF gt_final_sr22 IS NOT INITIAL.
    SORT gt_final_sr22 BY menge DESCENDING age_batch1 DESCENDING charg DESCENDING.
    DATA : lv_menge6 TYPE mseg-menge.
    DATA : lv_bch6   TYPE char20.
    DATA(ct_final_sr22) = gt_final_sr22.
    REFRESH : gt_final_sr22.
    SORT ct_final_sr22 BY vbeln posnr age_batch1.
    LOOP AT ct_final_sr22 INTO DATA(s_final_sr22).
      ON CHANGE OF s_final_sr22-vbeln.
        LOOP AT ct_final_sr22 INTO DATA(ls_final_sr22) WHERE vbeln = s_final_sr22-vbeln AND charg = s_final_sr22-charg.

*          ON CHANGE OF : LS_FINAL_SR-AGE_BATCH1.
          IF lv_bch6 NE ls_final_sr22-age_batch1.
            LOOP AT ct_final_sr22 INTO DATA(cs_final_sr22) WHERE vbeln = s_final_sr22-vbeln
                                                       AND charg = s_final_sr22-charg
                                                       AND age_batch1 = ls_final_sr22-age_batch1.
              lv_menge6 = lv_menge6 + cs_final_sr22-menge.
              CLEAR : cs_final_sr22.
            ENDLOOP.
            lv_bch6 = ls_final_sr22-age_batch1.

            ls_final_sr22-menge = lv_menge6.
            APPEND ls_final_sr22 TO gt_final_sr22.
          ENDIF.
          CLEAR : ls_final_sr22.
          CLEAR : lv_menge6.
*          ENDON.
*          ENDON.
        ENDLOOP.
        CLEAR : lv_bch6.
      ENDON.
      CLEAR : s_final_sr22.
    ENDLOOP.
*    DELETE ADJACENT DUPLICATES FROM GT_FINAL_SR22 COMPARING AGE_BATCH1.
    SORT gt_final_sr22 BY menge ASCENDING age_batch1 ASCENDING charg ASCENDING.
    LOOP AT gt_final INTO gw_final.
      gd_tabix = sy-tabix.
      READ TABLE gt_final_sr22 INTO gw_final_sr22 WITH KEY mblnr = gw_final-mblnr.
      IF sy-subrc = 0.
        DELETE gt_final INDEX gd_tabix.
      ENDIF.
      CLEAR : gw_final, gw_final_sr22.
    ENDLOOP.
    LOOP AT gt_final_sr22 INTO gw_final_sr22.
      gw_final_sr22-vbeln = ''.
      gw_final_sr22-posnr = ''.
      MODIFY gt_final_sr22 FROM gw_final_sr22.
      CLEAR : gw_final_sr22.
    ENDLOOP.
  ENDIF.
  IF gt_final_sr2 IS NOT INITIAL.
    APPEND LINES OF gt_final_sr2 TO gt_final.
    SORT gt_final BY mblnr.
  ENDIF.
  IF gt_final_sr22 IS NOT INITIAL.
    APPEND LINES OF gt_final_sr22 TO gt_final.
    SORT gt_final BY mblnr.
  ENDIF.
  LOOP AT gt_final INTO gw_final.
    gw_final-stk_value = gw_final-menge * gw_final-stk_price.
    MODIFY gt_final FROM gw_final TRANSPORTING stk_value.
    CLEAR : gw_final.
  ENDLOOP.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  GET_RECEIVERS_LIST
*&---------------------------------------------------------------------*

FORM get_receivers_list .

  "Added by V00041 on 10.02.2022 req by Bhavin ATDK963417
  IF p_dlist IS NOT INITIAL AND p_subj IS INITIAL.
    MESSAGE s000(38) WITH TEXT-011 DISPLAY LIKE 'E'.
    LEAVE LIST-PROCESSING.
  ENDIF.
  IF p_dlist IS INITIAL AND p_subj IS NOT INITIAL.
    MESSAGE s000(38) WITH TEXT-012 DISPLAY LIKE 'E'.
    LEAVE LIST-PROCESSING.
  ENDIF.
***********  EOC

  DATA : gt_member  LIKE TABLE OF sodm1,
         gt_objpara LIKE TABLE OF  selc,
         gt_objparb LIKE TABLE OF soop1.
  TYPES: BEGIN OF ty_address,
           address TYPE so_memadr,
         END OF ty_address.
  TYPES : tt_address TYPE TABLE OF ty_address.
*Types : BEGIN OF ty_email,
  CALL FUNCTION 'SO_DLI_READ'
    EXPORTING
      distributionlist           = p_dlist
*     DLI_ID                     = ' '
*     OWNER                      = ' '
      system_dli                 = 'X'
* IMPORTING
*     OBJECT_FL_DISPLAY          =
*     OBJECT_HD_DISPLAY          =
*     OBJECT_ID                  =
*     OBJECT_SD_DISPLAY          =
    TABLES
      member                     = gt_member
      objpara                    = gt_objpara
      objparb                    = gt_objparb
    EXCEPTIONS
      active_user_not_exist      = 1
      communication_failure      = 2
      component_not_available    = 3
      dl_name_not_exist          = 4
      folder_not_exist           = 5
      folder_no_authorization    = 6
      forwarder_not_exist        = 7
      object_not_exist           = 8
      object_no_authorization    = 9
      operation_no_authorization = 10
      owner_not_exist            = 11
      parameter_error            = 12
      substitute_not_active      = 13
      substitute_not_defined     = 14
      system_failure             = 15
      user_not_exist             = 16
      x_error                    = 17
      OTHERS                     = 18.
  IF sy-subrc = 0.
*  data : ls_members  like SODM1.
*  data(lt_Receivers_IDs) = value tt_address( FOR ls_members IN gt_member ( ls_members-address ) ).
    LOOP AT gt_member INTO DATA(gs_member).
*      GS_RECEIVER_EMAIL = GS_MEMBER-ADDRESS.
      gs_receiver_email-mail = gs_member-address.
      gs_receiver_email-sndex = gs_member-sndex.
      gs_receiver_email-sndcp = gs_member-sndcp.
      gs_receiver_email-sndbc = gs_member-sndbc.
      APPEND gs_receiver_email TO gt_receiver_email.
      CLEAR : gs_receiver_email.
    ENDLOOP.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_LAYOUT_FCAT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_layout_fcat .
  CONSTANTS: c_relid TYPE ltdx-relid VALUE 'LT'.
  SELECT SINGLE * FROM ltdx INTO wa_ltdx
  WHERE relid = c_relid
  AND report = sy-repid
   AND variant = p_layo.

  IF sy-subrc = 0.
    MOVE-CORRESPONDING wa_ltdx TO v_varkey.
* will get the layout fields

    CALL FUNCTION 'LT_DBDATA_READ_FROM_LTDX'
      EXPORTING
        i_tool       = c_relid
        is_varkey    = v_varkey
      TABLES
        t_dbfieldcat = it_fcat1 " To create Field Catalog
        t_dbsortinfo = it_sort_info " Sort category set
        t_dbfilter   = it_filter. " Filter category set


    IF it_fcat1[] IS NOT INITIAL.
      it_fcat_copy[] = it_fcat1[].
      SORT it_fcat1 BY param.
      DELETE it_fcat1 WHERE param <> 'NO_OUT' .
      DELETE it_fcat1 WHERE value = abap_true.
      SORT it_fcat1 BY key1.
      DELETE ADJACENT DUPLICATES FROM it_fcat1 COMPARING key1.
    ENDIF.
  ENDIF.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  SET_EMAIL_BASE
*&---------------------------------------------------------------------*

FORM set_email_base .

  DATA:
    mo_result_data        TYPE REF TO cl_salv_ex_result_data_table,
    lt_final              TYPE REF TO data,
    lv_version            TYPE string,
    lv_file_type          TYPE salv_bs_constant,
    lv_flavour            TYPE string,
    e_xstring             TYPE xstring,
    lt_binary             TYPE solix_tab,
    output_length         TYPE i,
    lt_fcat               TYPE lvc_t_fcat,
    ls_fcat               TYPE lvc_s_fcat,
    i_lt_fcat             TYPE kkblo_t_fieldcat,
    cs_layout_c           TYPE kkblo_layout,
    ct_default_fieldcat_c TYPE kkblo_t_fieldcat,
    lv_variant            LIKE disvariant,
    wa_newline            TYPE REF TO data.

*  GET REFERENCE OF <FS_DYNTAB> INTO LT_FINAL.
  IF it_fcat1 IS NOT INITIAL.
    LOOP AT it_fcat1 INTO DATA(wa_fcat1).
      READ TABLE gt_fcat INTO gw_fcat WITH KEY fieldname = wa_fcat1-key1.
      IF sy-subrc = 0 .
        ls_fcat-col_pos =
         VALUE #( it_fcat_copy[ key1 = wa_fcat1-key1 param = 'COL_POS']-value OPTIONAL ).
        ls_fcat-fieldname = gw_fcat-fieldname.
        ls_fcat-outputlen = gw_fcat-outputlen.
        ls_fcat-coltext   = gw_fcat-seltext_l.
        APPEND ls_fcat TO lt_fcat.
        CLEAR : ls_fcat.
      ENDIF.
    ENDLOOP.

  ELSE.
    LOOP AT gt_fcat INTO gw_fcat.
      ls_fcat-fieldname = gw_fcat-fieldname.
      ls_fcat-col_pos = gw_fcat-col_pos.
      ls_fcat-outputlen = gw_fcat-outputlen.
      ls_fcat-coltext   = gw_fcat-seltext_l.
      APPEND ls_fcat TO lt_fcat.
      CLEAR : ls_fcat, gw_fcat.
    ENDLOOP.
  ENDIF.


** Create dynamic internal table and assign to FS
  CALL METHOD cl_alv_table_create=>create_dynamic_table
    EXPORTING
      it_fieldcatalog = lt_fcat[]
    IMPORTING
      ep_table        = it_newtab.

  ASSIGN: it_newtab->* TO <fs_dyntab>.
  CREATE DATA wa_newline LIKE LINE OF <fs_dyntab>.

  LOOP AT gt_final ASSIGNING FIELD-SYMBOL(<fs_final>).
    ASSIGN wa_newline->* TO <fs_dynwa>.
    LOOP AT lt_fcat INTO ls_fcat.
      ASSIGN COMPONENT ls_fcat-fieldname OF STRUCTURE <fs_dynwa> TO <fs_fld2>.
      IF sy-subrc = 0.
        ASSIGN COMPONENT ls_fcat-fieldname OF STRUCTURE <fs_final> TO <fs_fld1>.
        IF sy-subrc = 0.
          <fs_fld2> = <fs_fld1>.
          UNASSIGN : <fs_fld2>, <fs_fld1>.
        ENDIF.
      ENDIF.
    ENDLOOP.
    IF <fs_dynwa> IS ASSIGNED.
      APPEND <fs_dynwa> TO <fs_dyntab>.
      UNASSIGN <fs_dynwa>.
    ENDIF.
  ENDLOOP.
  GET REFERENCE OF <fs_dyntab> INTO lt_final.
  IF cl_salv_bs_a_xml_base=>get_version( ) EQ if_salv_bs_xml=>version_25 OR
    cl_salv_bs_a_xml_base=>get_version( ) EQ if_salv_bs_xml=>version_26.


    mo_result_data = cl_salv_ex_util=>factory_result_data_table(
                                          r_data = lt_final
                                          t_fieldcatalog = lt_fcat
                                      ).

  ENDIF."IF cl_salv_bs_a_xml_base=>get_version( ) EQ if_salv_bs_xml=>version_25 OR

  CASE cl_salv_bs_a_xml_base=>get_version( ).
    WHEN if_salv_bs_xml=>version_25.
      lv_version = if_salv_bs_xml=>version_25.
    WHEN if_salv_bs_xml=>version_26.
      lv_version = if_salv_bs_xml=>version_26.
  ENDCASE."CASE cl_salv_bs_a_xml_base=>get_version( ).

  lv_file_type = if_salv_bs_xml=>c_type_xlsx.
  lv_flavour = if_salv_bs_c_tt=>c_tt_xml_flavour_export.

  "transformation of data to excel
  IF mo_result_data IS NOT INITIAL.
    CALL METHOD cl_salv_bs_tt_util=>if_salv_bs_tt_util~transform
      EXPORTING
        xml_version   = lv_version
        r_result_data = mo_result_data
        xml_type      = lv_file_type
        xml_flavour   = lv_flavour
        gui_type      = if_salv_bs_xml=>c_gui_type_gui
      IMPORTING
        xml           = e_xstring.
  ENDIF."IF mo_result_data IS NOT INITIAL.
  IF e_xstring IS NOT INITIAL.
    CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
      EXPORTING
        buffer        = e_xstring
      IMPORTING
        output_length = output_length
      TABLES
        binary_tab    = lt_binary.
  ENDIF."IF e_xstring IS NOT INITIAL.

  DATA:
    gt_main             TYPE bcsy_text,
    go_send_request     TYPE REF TO  cl_bcs,
    go_document         TYPE REF TO  cl_document_bcs,
    gv_subject          TYPE so_obj_des,
    gv_txt              TYPE string,
    lv_size             TYPE sood-objlen,
    lv_filename         TYPE sood-objdes,
    gv_sender_mail_id   TYPE ad_smtpadr,
    lv_sender_mail_text TYPE adr6-smtp_addr,
    lo_recipient        TYPE REF TO if_recipient_bcs,
    lv_sent_to_all      TYPE os_boolean,
    lo_ref_sender       TYPE REF TO if_sender_bcs. "Sender Details

  gv_subject = p_subj.
  "SENDER NAME
  SELECT SINGLE a~name_text e~smtp_addr
  FROM usr21 AS u INNER JOIN adr6 AS e
  ON u~persnumber EQ e~persnumber
  LEFT OUTER JOIN adrp AS a
  ON a~persnumber EQ u~persnumber
  INTO ( lv_sender_mail_text, gv_sender_mail_id )
  WHERE u~bname EQ sy-uname.

  APPEND VALUE #( line = 'Hi,' ) TO gt_main.
  APPEND INITIAL LINE TO gt_main.

  APPEND VALUE #( line = 'Please find attached output.' ) TO gt_main.
  APPEND INITIAL LINE TO gt_main.
  APPEND INITIAL LINE TO gt_main.
  APPEND VALUE #( line = '------------------------------------------------------------------------------------------' ) TO gt_main.
  APPEND VALUE #( line = 'This is system generated email.' ) TO gt_main.
  APPEND INITIAL LINE TO gt_main.

  go_send_request   = cl_bcs=>create_persistent( ).

  go_document  = cl_document_bcs=>create_document(
  i_type    = 'RAW'
  i_subject = gv_subject
  i_text    = gt_main ).

  lv_size = output_length.

  lv_filename = sy-datum.

  go_document->add_attachment(
  i_attachment_type = 'xls'
  i_attachment_subject = lv_filename
  i_attachment_size = lv_size
  i_att_content_hex = lt_binary
  ).

  go_send_request->set_document( go_document ).

  IF gv_sender_mail_id IS NOT INITIAL.
    lo_ref_sender     = cl_cam_address_bcs=>create_internet_address(
    i_address_string = gv_sender_mail_id
    i_address_name   = lv_sender_mail_text ).
  ENDIF.
  go_send_request->set_sender( lo_ref_sender ).

  DATA(lv_lines) = lines( gt_receiver_email ).
*  DATA(lv_lines) = 1.
*  DATA receiver_mail TYPE adr6-smtp_addr VALUE 'sasgar31090@gmail.com'.
  DO lv_lines TIMES.
    gs_receiver_email = VALUE #( gt_receiver_email[ sy-index ] OPTIONAL ).

    lo_recipient = cl_cam_address_bcs=>create_internet_address( gs_receiver_email-mail  ).
    IF gs_receiver_email-sndex = abap_true.
      go_send_request->add_recipient( EXPORTING i_recipient = lo_recipient i_express = 'X' ).
    ELSEIF gs_receiver_email-sndcp = abap_true.
      go_send_request->add_recipient( EXPORTING i_recipient = lo_recipient i_copy = 'X' ).
    ELSE.
      go_send_request->add_recipient( EXPORTING i_recipient = lo_recipient i_blind_copy = 'X' ).
    ENDIF.
    FREE: lo_recipient.
    CLEAR gs_receiver_email.
  ENDDO.

  go_send_request->set_send_immediately( 'X' ).
  TRY.
      go_send_request->send(
      EXPORTING
        i_with_error_screen = abap_true
        RECEIVING
        result = lv_sent_to_all ).

    CATCH cx_send_req_bcs.
  ENDTRY.
  IF lv_sent_to_all EQ abap_true.
    COMMIT WORK AND WAIT.
  ENDIF."IF lv_sent_to_all EQ abap_true.

  CLEAR : gt_fcat, lt_fcat, it_catdis.
ENDFORM.

**********************Soc By Devid-4619
FORM send_to_wovens_plannig .
***  commenting starts by jash rajpara dt: 09.10.24
*  DATA : LT_MMSTOCK_NEW  TYPE TABLE OF ZERPFINISHSTOCK,
***        SOC BY JASH RAJPARA DT: 10.09.2024
*         LT_MMSTOCK_NEW1 TYPE TABLE OF ZERPFINISHSTOCK,
*         LT_MMSTOCK_NEW2 TYPE TABLE OF ZERPFINISHSTOCK,
*         LT_MMSTOCK_NEW3 TYPE TABLE OF ZERPFINISHSTOCK,
***        EOC BY JASH RAJPARA DT: 10.09.2024
*         LW_MMSTOCK_NEW  TYPE ZERPFINISHSTOCK.

*  DATA : LV_LEN     TYPE I,
*         LV_STR     TYPE STRING,
*         LV_QTY(25) TYPE C.
*
*  DATA : LVC_DAT TYPE SY-DATUM.
*
*  DATA : CN TYPE I.
*
*  DATA : GV_C_DATE TYPE CHAR10.  "Soc By Devid-4953
** commenting ends here by jash rajpara dt: 09.10.24

  IF gt_final[] IS NOT INITIAL.

**->Soc - Transaction Log Date/Time : ATDK993980 - 22.11.2023
**    DATA : LV_TRDATE    TYPE STRING .    "" commented by jash rajpara dt: 10.09.24
**->Eoc - Transaction Log Date/Time : ATDK993980 - 22.11.2023

    CLEAR : lv_trdate.
    CONCATENATE sy-datum+6(2)
    sy-datum+4(2)
    sy-datum+0(4) INTO DATA(lv_date) SEPARATED BY '-'.

    CONCATENATE sy-uzeit+0(2)
    sy-uzeit+2(2)
    sy-uzeit+4(2) INTO DATA(lv_time) SEPARATED BY ':'.

    CLEAR : gv_c_date .
    gv_c_date = lv_date . "Soc By Devid-4953

    IF lv_date IS NOT INITIAL AND lv_time IS NOT INITIAL.
      CONCATENATE lv_date lv_time INTO lv_trdate SEPARATED BY space.
    ENDIF.
    CLEAR : lv_date,lv_time.

    SELECT * FROM zerpfinishstock
      INTO TABLE @DATA(it_zmmstk)
         WHERE zpkey = @p_key.
    IF it_zmmstk IS NOT INITIAL.
      SORT it_zmmstk BY zpkey.
      DELETE FROM zerpfinishstock WHERE zpkey = p_key.
    ENDIF.
    REFRESH : it_zmmstk[].
    CLEAR: cn.    "" added by jash rajpara no dev id dt: 10.09.2024
    DESCRIBE TABLE gt_final LINES lv_r_count.

    LOOP AT gt_final INTO DATA(lw_final).
      cn = cn + 1.  "" added by jash rajpara no dev id dt: 10.09.2024
      cn1 = cn1 + 1.
      lw_mmstock_new-mandt = sy-mandt. "Added BY Uday Sorathiya NO DEV ID : WPS Project
      lw_mmstock_new-zid = sy-tabix .
      lw_mmstock_new-zpkey = p_key.

      IF lw_final-fvdt1 IS NOT INITIAL AND lw_final-fvdt1 NE 00000000.    "Batch Creation Date
        CONCATENATE lw_final-fvdt1+6(2)
                    lw_final-fvdt1+4(2)
                    lw_final-fvdt1+0(4) INTO lw_mmstock_new-zbatch_creation_date SEPARATED BY '-'.
      ENDIF.

      lw_mmstock_new-zsloc                = lw_final-lgort .              "Sloc
      lw_mmstock_new-zmaterial_code  = lw_final-matnr .                   "Material Code
      lw_mmstock_new-zbatch_no = lw_final-charg .                         "Batch No
      lw_mmstock_new-zphysical_beam_no = lw_final-phycl_beam_no .         "Physical Beam No
      lw_mmstock_new-ztype = lw_final-type .                              "Type

      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-menge  LT '0.000' AND lw_final-menge NE '0.000' AND lw_final-menge IS NOT INITIAL. "Batch Qty
        lv_qty = lw_final-menge  .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-menge.
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zbatch_qty = lv_qty.
      ELSE.
        lw_mmstock_new-zbatch_qty = lw_final-menge .
      ENDIF.

      lw_mmstock_new-zoriginal_so = lw_final-org_sono .                   "Original Sales Order
      lw_mmstock_new-zoriginal_so_line = lw_final-org_soline .            "Original So Line
      lw_mmstock_new-zquality_code = lw_final-qlty_code .                 "Quality Code

      IF lw_final-fvdt2 IS NOT INITIAL AND lw_final-fvdt2 NE 00000000.     "Transaction Date
        CONCATENATE lw_final-fvdt2+6(2)
                    lw_final-fvdt2+4(2)
                    lw_final-fvdt2+0(4) INTO lw_mmstock_new-ztransaction_date SEPARATED BY '-'.
      ENDIF.

      lw_mmstock_new-zpo_line   = lw_final-ebeln .                        "Purchase Order/ Line
      lw_mmstock_new-zqc_desc   = lw_final-qltdsc .                       "Qc Desc
      lw_mmstock_new-zsupplier_lot  = lw_final-supply_lot .               "Supplier Lot
      lw_mmstock_new-zmat_desc      = lw_final-maktx .                    "Mat Desc
*------------------------------------------------>Soc By Devid-4619
      IF lw_final-cputm IS NOT INITIAL AND lw_final-cputm NE 00000000.     "Transaction Time
        CONCATENATE lw_final-cputm+0(2)
                    lw_final-cputm+2(2)
                    lw_final-cputm+4(2) INTO lw_mmstock_new-ztransaction_time SEPARATED BY ':'.
      ENDIF.
*------------------------------------------------>Eoc By Devid-4619
*      lw_mmstock_new-ztransaction_time = lw_final-cputm  .                "Transaction Time
      lw_mmstock_new-zplant    =   lw_final-werks   .                     "Plant
      lw_mmstock_new-zsloc_desc   =   lw_final-lgobe   .                  "Sloc Desc
      lw_mmstock_new-zmaterial_group  =   lw_final-matkl .                "Material Grp
      lw_mmstock_new-zmaterial_group_desc   = lw_final-wgbez   .          "Mat Grp Desc
      lw_mmstock_new-zgl_account    =   lw_final-racct   .                "GL Account
      lw_mmstock_new-zdept  =   lw_final-departdesc   .                   "Department
      lw_mmstock_new-zbatch_uom  =   lw_final-meins   .                   "Batch Uom
      lw_mmstock_new-zwarehouse_no  =   lw_final-lgnum   .                "Warehouse No
      lw_mmstock_new-zwm_code_desc  =   lw_final-lnumt   .                "Wm Code Desc
      lw_mmstock_new-zstorage_type  =   lw_final-lgtyp   .                "Storage Type
      lw_mmstock_new-zstorage_bin   =   lw_final-lgpla   .                "Storage Bin
      lw_mmstock_new-zstock_category   =   lw_final-st_text   .           "Stock Category
      lw_mmstock_new-zspecial_stock  =   lw_final-sobkz   .               "Special Stock
      lw_mmstock_new-zso_type  =   lw_final-auart   .                     "Sales Order Type
      lw_mmstock_new-zso_no  =   lw_final-vbeln   .                       "Sales Order No
      lw_mmstock_new-zso_line   =   lw_final-posnr   .                    "Sales Order Line
      lw_mmstock_new-zprd_order  =   lw_final-aufnr1   .                   "Prd Order       "Soc By Devid-4619

      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-kwmeng  LT '0.000' AND lw_final-kwmeng NE '0.000' AND lw_final-kwmeng IS NOT INITIAL.  "So Line Qty   "Soc By Devid-4619
        lv_qty = lw_final-kwmeng  .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-kwmeng.
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zso_line_qty = lv_qty.
      ELSE.
        lw_mmstock_new-zso_line_qty = lw_final-kwmeng .
      ENDIF.

      lw_mmstock_new-zso_line_uom   =   lw_final-vrkme   .                "So Line Uom
      lw_mmstock_new-zassortment_req  =   lw_final-zz_sortorder   .       "Assortment Req
      lw_mmstock_new-zship_to_party   =   lw_final-kunnr_sh   .           "Ship To Party
      lw_mmstock_new-zsold_to_party   =   lw_final-kunnr_sp   .           "Sold To Party
      lw_mmstock_new-zdelivery_no   =   lw_final-vbeln_dl   .             "Delivery No

      IF lw_final-erdat IS NOT INITIAL AND lw_final-erdat NE 00000000.     "Delivery Date
        CONCATENATE lw_final-erdat+6(2)
                    lw_final-erdat+4(2)
                    lw_final-erdat+0(4) INTO lw_mmstock_new-zdelivery_date SEPARATED BY '-'.
      ENDIF.

      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-lfimg  LT '0.000' AND lw_final-lfimg NE '0.000' AND lw_final-lfimg IS NOT INITIAL.  "Delivery Line Quantity  "Soc By Devid-4619
        lv_qty = lw_final-lfimg  .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-lfimg.
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zdelivery_line_qty = lv_qty.
      ELSE.
        lw_mmstock_new-zdelivery_line_qty = lw_final-lfimg .
      ENDIF.


      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-open_qty   LT '0.000' AND lw_final-open_qty  NE '0.000' AND lw_final-open_qty IS NOT INITIAL.   "Open Qty
        lv_qty = lw_final-open_qty   .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-open_qty .
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zopen_qty = lv_qty.
      ELSE.
        lw_mmstock_new-zopen_qty = lw_final-open_qty  .
      ENDIF.


      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-so_price  LT '0.000' AND lw_final-so_price NE '0.000' AND lw_final-so_price IS NOT INITIAL.    "So Price   "Soc By Devid-4619
        lv_qty = lw_final-so_price  .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-so_price.
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zso_price = lv_qty.
      ELSE.
        lw_mmstock_new-zso_price = lw_final-so_price .
      ENDIF.

      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-so_valu  LT '0.00' AND lw_final-so_valu NE '0.00' AND lw_final-so_valu IS NOT INITIAL.    "Value So Wise   "Soc By Devid-4619
        lv_qty = lw_final-so_valu  .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-so_valu.
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zvalue_so_wise = lv_qty.
      ELSE.
        lw_mmstock_new-zvalue_so_wise = lw_final-so_valu .
      ENDIF.

      lw_mmstock_new-zsales_district_desc  =   lw_final-bztxt   .         "Sales District Description
      lw_mmstock_new-zsales_district_code  =   lw_final-bzirk   .         "Sales District Code
      lw_mmstock_new-zfinal_segment  =   lw_final-final_seg   .           "Final Segment
      lw_mmstock_new-zsales_office_kam_name  =   lw_final-vkbur_text   .  "Sales Office-Kam Name
      lw_mmstock_new-zsales_group  =   lw_final-vkgrp_text   .            "Sales Group
      lw_mmstock_new-zcustomer_ref  =   lw_final-kdmat  .                 "Customer Ref
      lw_mmstock_new-zbrand   =   lw_final-zzkvgr1_text   .               "Brand
      lw_mmstock_new-ztrade_name   =   lw_final-zztradenm   .             "Trade Name
      lw_mmstock_new-zbreak_open_req_no  =   lw_final-zreq_no   .         "Break Open Req No
      lw_mmstock_new-zageing_from_delivery_date = lw_final-age_del .      "Ageing From Delivery Date
      lw_mmstock_new-zbo_req_status  =   lw_final-zstat   .               "Bbo Req Status
      lw_mmstock_new-zsales_order_status  =   lw_final-so_status  .       "Sales Order Status

      IF lw_final-zzppcmtdt IS NOT INITIAL AND lw_final-zzppcmtdt NE 00000000.     "So Line Exmill Date
        CONCATENATE lw_final-zzppcmtdt+6(2)
                    lw_final-zzppcmtdt+4(2)
                    lw_final-zzppcmtdt+0(4) INTO lw_mmstock_new-zso_line_exmill_date SEPARATED BY '-'.
      ENDIF.


      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-stk_price  LT '0.00' AND lw_final-stk_price NE '0.00' AND lw_final-stk_price IS NOT INITIAL. "Stock Price
        lv_qty = lw_final-stk_price  .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-stk_price.
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zstock_price = lv_qty.
      ELSE.
        lw_mmstock_new-zstock_price = lw_final-stk_price .
      ENDIF.

      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-stk_value  LT '0.00' AND lw_final-stk_value NE '0.00' AND lw_final-stk_value IS NOT INITIAL. "Stock Value
        lv_qty = lw_final-stk_value  .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-stk_value.
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zstock_value = lv_qty.
      ELSE.
        lw_mmstock_new-zstock_value = lw_final-stk_value .
      ENDIF.

      lw_mmstock_new-zorg_so_type  =   lw_final-org_auart   .             "Org.So.Typ(Projection/Prodn)
      lw_mmstock_new-zbatch_creation_ageing  =   lw_final-age_batch  .    "Batch Creation Ageing
      lw_mmstock_new-zdev_ord_no  =   lw_final-dev_no   .                 "Dev Ord No
      lw_mmstock_new-zdev_ord_line  =   lw_final-dev_line   .             "Dev Ord Line
      lw_mmstock_new-zmou_ord  =   lw_final-mou_order   .                 "Mou Ord
      lw_mmstock_new-zppc_ageing  =   lw_final-age_ppcdt .                "PPC Aging

      IF lw_final-zzcusreqd IS NOT INITIAL AND lw_final-zzcusreqd NE 00000000.     "Cust.Req.Date
        CONCATENATE lw_final-zzcusreqd+6(2)
                    lw_final-zzcusreqd+4(2)
                    lw_final-zzcusreqd+0(4) INTO lw_mmstock_new-zcust_req_date SEPARATED BY '-'.
      ENDIF.

      lw_mmstock_new-zageing_from_crd = lw_final-age_crdt .    "Aging Frm CRD
      lw_mmstock_new-zwork_order_no   =   lw_final-wo_no   .              "Work Order No
      lw_mmstock_new-zmat_doc_no   =   lw_final-mblnr   .                 "Mat Doc No
      lw_mmstock_new-zmat_doc_line   =   lw_final-zeile   .               "Mat Doc Line
      lw_mmstock_new-zmovement_type   =   lw_final-bwart   .              "Movement Type
      lw_mmstock_new-zpur_order_status  =   lw_final-pursts   .           "Pur.Ord Status
      lw_mmstock_new-zprod_order   =   lw_final-aufnr   .                 "Production Order
      lw_mmstock_new-zprod_order_status   =   lw_final-postat   .         "Prod.Ord. Status
      lw_mmstock_new-znow_so_line   =   lw_final-kdauf   .                "NOW Sales Order/ Line
      lw_mmstock_new-zpo_item_category  =   lw_final-pstyp_text   .       "PO Item Category
      lw_mmstock_new-zvaluation_type   =   lw_final-bwtar   .             "Valuation Type
      lw_mmstock_new-zsupplier_name  =   lw_final-supply_name   .         "Supplier Name
      lw_mmstock_new-zinspection_lot  =   lw_final-prueflos   .           "Inspection Lot
      lw_mmstock_new-ztotal_defect   =   lw_final-ttl_defect   .          "Total Defect
      lw_mmstock_new-zreed_space   =   lw_final-reed_space   .            "Reed Space
      lw_mmstock_new-zweave   =   lw_final-wave   .                       "Weave
      lw_mmstock_new-zbig_roll_no   =   lw_final-big_rollno   .           "Big Roll No
      lw_mmstock_new-zwidth   =   lw_final-width   .                      "Width
      lw_mmstock_new-zfabric_name  =   lw_final-fab_name_slno   .         "Fabric Name/KNITS Serialno
      lw_mmstock_new-zshade_code  =   lw_final-shade_code   .             "Shade Code
      lw_mmstock_new-zfinish_code  =   lw_final-finish_code   .           "Finish Code
      lw_mmstock_new-zprint_code  =   lw_final-print_code   .             "Print Code
      lw_mmstock_new-zshade_color  =   lw_final-shade_colour   .          "Shade / Colour
      lw_mmstock_new-znow_bale_no  =   lw_final-now_bal_no   .            "Now Bale No
      lw_mmstock_new-zvariety  =   lw_final-veriety   .                  "Variety
      lw_mmstock_new-zinspection_remark  =   lw_final-insp_rmk   .        "Inspection Remark
      lw_mmstock_new-zinspector_name  =   lw_final-insptor_name   .       "Inspector Name
      lw_mmstock_new-zblend  =   lw_final-blend   .                       "Blend
      lw_mmstock_new-zshade_lot  =   lw_final-shade_lot   .               "Shade Lot

      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-gross_wt  LT '0.00' AND lw_final-gross_wt NE '0.00' AND lw_final-gross_wt IS NOT INITIAL.   "Gross Wt
        lv_qty = lw_final-gross_wt  .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-gross_wt.
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zgross_wt = lv_qty.
      ELSE.
        lw_mmstock_new-zgross_wt = lw_final-gross_wt .
      ENDIF.

      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-net_wt  LT '0.00' AND lw_final-net_wt NE '0.00' AND lw_final-net_wt IS NOT INITIAL.  "Net Wt
        lv_qty = lw_final-net_wt  .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-net_wt.
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-znet_wt = lv_qty.
      ELSE.
        lw_mmstock_new-znet_wt = lw_final-net_wt .
      ENDIF.

      lw_mmstock_new-zvariance   =   lw_final-variance   .                "Variance
      lw_mmstock_new-zvariance_per  =   lw_final-variance_p   .           "Variance%
      lw_mmstock_new-ztotal_so_line   =   lw_final-so_line   .            "Total So Line
      lw_mmstock_new-zso_greige_planned_qty_m   = lw_final-grig_pln_qty . "SO Greige Planned Qty(M)
      lw_mmstock_new-zhsn_code   =   lw_final-steuc .                     "Hsn Code
      lw_mmstock_new-zold_material_no   =   lw_final-old_mtrl_no   .      "Old Material No
      lw_mmstock_new-zbill_to_party_code   =   lw_final-kunnr_bill   .    "Bill To Party Code
      lw_mmstock_new-zbill_to_party_name   =   lw_final-kunnr_bill_name . "Bill To Party Name
      lw_mmstock_new-zremark    =   lw_final-remark   .                   "Remark
      lw_mmstock_new-zmat_category   =   lw_final-mat_cat   .             "Mat Categoty

      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-qty_yrd  LT '0.00' AND lw_final-qty_yrd NE '0.00' AND lw_final-qty_yrd IS NOT INITIAL.    "Qty(Yard)
        lv_qty = lw_final-qty_yrd  .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-qty_yrd.
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zqty_yard = lv_qty.
      ELSE.
        lw_mmstock_new-zqty_yard = lw_final-qty_yrd .
      ENDIF.

      lw_mmstock_new-zshade_desc   =   lw_final-shd_colr_text   .         "Shade/ Colour(Description)
      lw_mmstock_new-zdoc_no_line_date   =   lw_final-dt_docln   .        "Doc Date/NO-Line
      lw_mmstock_new-zunloading_point   =   lw_final-unloading   .        "Unloading Point
      lw_mmstock_new-zproduct_category     =   lw_final-pstyp_text   .    "Product Category

****************************************Soc By Devid-4712
      lw_mmstock_new-zbatch_aum_qty =  lw_final-btch_aum_qty  .
      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-btch_aum_qty  LT '0.00' AND lw_final-btch_aum_qty NE '0.00' AND lw_final-btch_aum_qty IS NOT INITIAL. "Batch Qty
        lv_qty = lw_final-btch_aum_qty .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-btch_aum_qty .
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zbatch_aum_qty = lv_qty.
      ELSE.
        lw_mmstock_new-zbatch_aum_qty = lw_final-btch_aum_qty .
      ENDIF.

      lw_mmstock_new-zbatch_aum =  lw_final-btch_aum_uom .
      lw_mmstock_new-zpr_no =  lw_final-banfn.
      lw_mmstock_new-zpr_creator =  lw_final-pr_creator  .
      lw_mmstock_new-zpo_item_text =  lw_final-po_text  .
      lw_mmstock_new-zsupplier_inv_no =  lw_final-zinvoino  .

      IF lw_final-zinvoidt IS NOT INITIAL AND lw_final-zinvoidt NE 00000000.
        CONCATENATE lw_final-zinvoidt+6(2)
                    lw_final-zinvoidt+4(2)
                    lw_final-zinvoidt+0(4) INTO lw_mmstock_new-zsupplier_inv_date SEPARATED BY '-'.
      ENDIF.

      lw_mmstock_new-zgate_entry_no =  lw_final-zgateentryno  .

      IF lw_final-zentrydate IS NOT INITIAL AND lw_final-zentrydate NE 00000000.
        CONCATENATE lw_final-zentrydate+6(2)
                    lw_final-zentrydate+4(2)
                    lw_final-zentrydate+0(4) INTO lw_mmstock_new-zgate_entry_date SEPARATED BY '-'.
      ENDIF.
      lw_mmstock_new-zmeter_kg =  lw_final-meter_kg .

      CLEAR: lv_len, lv_str,lv_qty.
      IF lw_final-vmsav  LT '0.00' AND lw_final-vmsav NE '0.00' AND lw_final-vmsav IS NOT INITIAL. "Batch Qty
        lv_qty = lw_final-vmsav  .
        CONDENSE lv_qty.
        lv_len = strlen( lv_qty ).
        lv_len = lv_len - 1.
        lv_qty = lv_qty+0(lv_len).
        lv_str = lw_final-vmsav.
        CONDENSE lv_str NO-GAPS.
        CONCATENATE lv_str+lv_len(1) lv_qty INTO lv_qty.
        lw_mmstock_new-zlast_month_price  = lv_qty.
      ELSE.
        lw_mmstock_new-zlast_month_price  = lw_final-vmsav .
      ENDIF.

      lw_mmstock_new-zpackage_length =  lw_final-pck_length.
      lw_mmstock_new-zform_of_packing =  lw_final-form_pack .
      lw_mmstock_new-zchart_prefix =  lw_final-chart_prfx .
      lw_mmstock_new-zcreel =  lw_final-creel  .
      lw_mmstock_new-zyarn_use =  lw_final-yarn_use  .
      lw_mmstock_new-zweaving_plant =  lw_final-weaving_plant .
      lw_mmstock_new-zsize_set_no =  lw_final-size_set_no .
      lw_mmstock_new-zmixing_detail =  lw_final-mix_dtls .
      lw_mmstock_new-zrope_position_no =  lw_final-rpn  .
      lw_mmstock_new-zdyed_yarn_lot_no =  lw_final-dylno  .
      lw_mmstock_new-zyarn1_source =  lw_final-yarn1  .
      lw_mmstock_new-zyarn2_source =  lw_final-yarn2 .
      lw_mmstock_new-zyarn3_source =  lw_final-yarn3 .
      lw_mmstock_new-zyarn4_source =  lw_final-yarn4 .
      lw_mmstock_new-zszg_batch =  lw_final-szg_btch .
      lw_mmstock_new-zsize_set_sr_no =  lw_final-szg_set_sl .
      lw_mmstock_new-zpending_grey_issue =  lw_final-gry_pend_issue .
      lw_mmstock_new-zpr_l1_approver =  lw_final-pr_l1approve .
****************************************Eoc By Devid-4712

**      SOC BY JASH RAJPARA DEV ID:
      lw_mmstock_new-zwarp_lot_no   = lw_final-warp_lot_no.
      lw_mmstock_new-zloom_no       = lw_final-mchin_loom_no.
      lw_mmstock_new-zweft_supplier = lw_final-weft_supply.
      lw_mmstock_new-zwarp_supplier = lw_final-warp_supply.
      lw_mmstock_new-zweft_lot_no   = lw_final-weft_lot_no.
      lw_mmstock_new-zweaving_plant = lw_final-weaving_plant.
**      EOC BY JASH RAJPARA DEV ID:

***->Soc - Transaction Log Date/Time : ATDK993980 - 22.11.2023
      lw_mmstock_new-ztrn_log_date = lv_trdate .
***->Eoc - Transaction Log Date/Time : ATDK993980 - 22.11.2023

      CONDENSE :  lw_mmstock_new-zsloc,
                  lw_mmstock_new-zmaterial_code,
                  lw_mmstock_new-zbatch_no,
                  lw_mmstock_new-zphysical_beam_no,
                  lw_mmstock_new-ztype,
*                 lw_mmstock_new-zbatch_qty,
                  lw_mmstock_new-zoriginal_so,
                  lw_mmstock_new-zoriginal_so_line,
                  lw_mmstock_new-zquality_code,
                  lw_mmstock_new-ztransaction_date,
                  lw_mmstock_new-zpo_line,
                  lw_mmstock_new-zqc_desc,
                  lw_mmstock_new-zsupplier_lot,
                  lw_mmstock_new-zmat_desc,
                  lw_mmstock_new-ztransaction_time,
                  lw_mmstock_new-zplant,
                  lw_mmstock_new-zsloc_desc,
                  lw_mmstock_new-zmaterial_group,
                  lw_mmstock_new-zmaterial_group_desc,
                  lw_mmstock_new-zgl_account,
                  lw_mmstock_new-zdept,
                  lw_mmstock_new-zbatch_uom,
                  lw_mmstock_new-zwarehouse_no,
                  lw_mmstock_new-zwm_code_desc,
                  lw_mmstock_new-zstorage_type,
                  lw_mmstock_new-zstorage_bin,
                  lw_mmstock_new-zstock_category,
                  lw_mmstock_new-zspecial_stock,
                  lw_mmstock_new-zso_type,
                  lw_mmstock_new-zso_no,
                  lw_mmstock_new-zso_line,
                  lw_mmstock_new-zprd_order,
*                 lw_mmstock_new-zso_line_qty,
                  lw_mmstock_new-zso_line_uom,
                  lw_mmstock_new-zassortment_req,
                  lw_mmstock_new-zship_to_party,
                  lw_mmstock_new-zsold_to_party,
                  lw_mmstock_new-zdelivery_no,
                  lw_mmstock_new-zdelivery_date,
*                 lw_mmstock_new-zdelivery_line_qty,
*                 lw_mmstock_new-zopen_qty,
*                 lw_mmstock_new-zso_price,
*                 lw_mmstock_new-zvalue_so_wise,
                  lw_mmstock_new-zsales_district_desc,
                  lw_mmstock_new-zsales_district_code,
                  lw_mmstock_new-zfinal_segment,
                  lw_mmstock_new-zsales_office_kam_name,
                  lw_mmstock_new-zsales_group,
                  lw_mmstock_new-zcustomer_ref,
                  lw_mmstock_new-zbrand,
                  lw_mmstock_new-ztrade_name,
                  lw_mmstock_new-zbreak_open_req_no,
                  lw_mmstock_new-zageing_from_delivery_date,
                  lw_mmstock_new-zbo_req_status,
                  lw_mmstock_new-zsales_order_status,
                  lw_mmstock_new-zso_line_exmill_date,
*                 lw_mmstock_new-zstock_price,
*                 lw_mmstock_new-zstock_value,
                  lw_mmstock_new-zorg_so_type,
                  lw_mmstock_new-zbatch_creation_ageing,
                  lw_mmstock_new-zdev_ord_no,
                  lw_mmstock_new-zdev_ord_line,
                  lw_mmstock_new-zmou_ord,
                  lw_mmstock_new-zppc_ageing,
                  lw_mmstock_new-zcust_req_date,
                  lw_mmstock_new-zageing_from_crd,
                  lw_mmstock_new-zwork_order_no,
                  lw_mmstock_new-zmat_doc_no,
                  lw_mmstock_new-zmat_doc_line,
                  lw_mmstock_new-zmovement_type,
                  lw_mmstock_new-zpur_order_status,
                  lw_mmstock_new-zprod_order,
                  lw_mmstock_new-zprod_order_status,
                  lw_mmstock_new-znow_so_line,
                  lw_mmstock_new-zpo_item_category,
                  lw_mmstock_new-zvaluation_type,
                  lw_mmstock_new-zsupplier_name,
                  lw_mmstock_new-zinspection_lot,
                  lw_mmstock_new-ztotal_defect,
                  lw_mmstock_new-zreed_space,
                  lw_mmstock_new-zweave,
                  lw_mmstock_new-zbig_roll_no,
                  lw_mmstock_new-zwidth,
                  lw_mmstock_new-zfabric_name,
                  lw_mmstock_new-zshade_code,
                  lw_mmstock_new-zfinish_code,
                  lw_mmstock_new-zprint_code,
                  lw_mmstock_new-zshade_color,
                  lw_mmstock_new-znow_bale_no,
                  lw_mmstock_new-zvariety,
                  lw_mmstock_new-zinspection_remark,
                  lw_mmstock_new-zinspector_name,
                  lw_mmstock_new-zblend,
                  lw_mmstock_new-zshade_lot,
                  lw_mmstock_new-zgross_wt,
                  lw_mmstock_new-znet_wt,
                  lw_mmstock_new-zvariance,
                  lw_mmstock_new-zvariance_per,
                  lw_mmstock_new-ztotal_so_line,
*                 lw_mmstock_new-zso_greige_planned_qty_m,
                  lw_mmstock_new-zhsn_code,
                  lw_mmstock_new-zold_material_no,
                  lw_mmstock_new-zbill_to_party_code,
                  lw_mmstock_new-zbill_to_party_name,
                  lw_mmstock_new-zremark,
                  lw_mmstock_new-zmat_category,
*                 lw_mmstock_new-zqty_yard,
                  lw_mmstock_new-zshade_desc,
                  lw_mmstock_new-zdoc_no_line_date,
                  lw_mmstock_new-zunloading_point,
                  lw_mmstock_new-zproduct_category ,
                  lw_mmstock_new-ztrn_log_date ,
                  lw_mmstock_new-zwarp_lot_no,
                  lw_mmstock_new-zloom_no,
                  lw_mmstock_new-zweft_supplier,
                  lw_mmstock_new-zwarp_supplier,
                  lw_mmstock_new-zweft_lot_no,
                  lw_mmstock_new-zweaving_plant,
                  lw_mmstock_new-zpending_grey_issue.
**      soc by jash rajpara dt: 09.10.24
      APPEND lw_mmstock_new TO lt_mmstock_new .
      CLEAR : lw_mmstock_new , lw_final .
      IF cn EQ 20000.
        MOVE-CORRESPONDING lt_mmstock_new TO lt_final.
        PERFORM send_data_wps.
        CLEAR: lt_mmstock_new[], cn.
      ENDIF.
**      eoc by jash rajpara dt: 09.10.24
    ENDLOOP.
** soc & commenting by jash rajpara dt: 09.10.24
    IF ( lt_mmstock_new IS NOT INITIAL AND cn < 20000 ).
      MOVE-CORRESPONDING lt_mmstock_new TO lt_final.
      PERFORM send_data_wps.
      CLEAR: lt_mmstock_new[], cn, cn1.
    ENDIF.

    "BOC of Uday Sorathiya WPS Project TR : ATDK9A06BO


*    IF LT_FINAL[] IS NOT INITIAL.
*      LS_OUT-MT_ZERPFINISHSTOCK_SAP-ZERPFINISHSTOCK-ITEM = LT_FINAL.
*      TRY.
*          CREATE OBJECT LO_SERVICE.
*          CALL METHOD LO_SERVICE->SI_ASHYCOUT_ZERPFINISHSTOCK_OU
*            EXPORTING
*              OUTPUT = LS_OUT.
*          IF SY-SUBRC EQ 0.
*            COMMIT WORK.
*            DESCRIBE TABLE LT_MMSTOCK_NEW LINES LV_R_COUNT .
*            LW_WPS_LOG_TAB-ZTCODE         = 'ZMMSTOCK_NEW' .
*            LW_WPS_LOG_TAB-ZPKEY          = P_KEY .
*            LW_WPS_LOG_TAB-ZTRN_LOG_DATE  = LV_TRDATE .
*            LW_WPS_LOG_TAB-ZREC_COUNT     = LV_R_COUNT .
*            LW_WPS_LOG_TAB-ZCURR_DATE     = SY-DATUM.
*            LW_WPS_LOG_TAB-ZWPS_TBL_NAME  = 'ZERPFINISHSTOCK' .
*
*            IF LW_WPS_LOG_TAB IS NOT INITIAL.
*              INSERT ZWPS_LOG_TAB FROM LW_WPS_LOG_TAB .
*            ENDIF.
*            CLEAR : LV_TRDATE , LV_R_COUNT , LW_WPS_LOG_TAB, LS_OUT .
*            MESSAGE : 'Data Sent Successfully' TYPE 'S'.
*          ELSE.
*            IF LT_MMSTOCK_NEW[] IS NOT INITIAL.
*              MODIFY ZERPFINISHSTOCK FROM TABLE LT_MMSTOCK_NEW.
*              IF SY-SUBRC = 0.
*                COMMIT WORK .
*                REFRESH : LT_MMSTOCK_NEW[].
*              ENDIF.
*            ENDIF.
*          ENDIF.
*        CATCH CX_AI_SYSTEM_FAULT INTO LO_SYS_EXCEPTION.
*        CATCH CX_AI_APPLICATION_FAULT.
*      ENDTRY.
*    ENDIF.

    CLEAR : lt_mmstock_new[], lt_final[], cn1.
**    EOC & COMMENTING BY JASH RAJPARA DT: 09.10.24
  ENDIF.
  "EOC of Uday Sorathiya WPS Project TR : ATDK9A06BO
ENDFORM.
**********************Eoc By Devid-4619
*&---------------------------------------------------------------------*
*&      Form  SEND_DATA_WPS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM send_data_wps .

  ls_out-mt_zerpfinishstock_sap-zerpfinishstock-item = lt_final.
  CLEAR: lt_final.
  TRY.
      CREATE OBJECT lo_service.
      CALL METHOD lo_service->si_ashycout_zerpfinishstock_ou
        EXPORTING
          output = ls_out.
      IF sy-subrc EQ 0.
        COMMIT WORK.
        IF cn1 EQ lv_r_count.

          lw_wps_log_tab-ztcode         = 'ZMMSTOCK_NEW' .
          lw_wps_log_tab-zpkey          = p_key .
          lw_wps_log_tab-ztrn_log_date  = lv_trdate .
          lw_wps_log_tab-zrec_count     = lv_r_count .
          lw_wps_log_tab-zcurr_date     = sy-datum.
          lw_wps_log_tab-zwps_tbl_name  = 'ZERPFINISHSTOCK' .

          IF lw_wps_log_tab IS NOT INITIAL.
            INSERT zwps_log_tab FROM lw_wps_log_tab .
          ENDIF.
          CLEAR : lv_trdate , lv_r_count , lw_wps_log_tab, ls_out, cn1 .
          MESSAGE : 'Data Sent Successfully' TYPE 'S'.
        ELSE.
          IF lt_mmstock_new[] IS NOT INITIAL.
            MODIFY zerpfinishstock FROM TABLE lt_mmstock_new.
            IF sy-subrc = 0.
              COMMIT WORK .
              REFRESH : lt_mmstock_new[].
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    CATCH cx_ai_system_fault INTO lo_sys_exception.
    CATCH cx_ai_application_fault.
  ENDTRY.

ENDFORM.